<!DOCTYPE html>
<html lang="ja">

<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³•æ”¿Jr.ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã‚¯ãƒ©ãƒ–é‹å–¶ç®¡ç†ã‚¢ãƒ—ãƒª</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: "Noto Sans JP", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
            padding: 20px;
            color: white;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 10px rgba(255, 94, 98, 0.3);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 0 15px 15px 15px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 5px;
            margin: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            text-align: center;
        }

        .nav-item.active {
            background: #ffe0b2;
            color: #333;
            border: 2px solid #FF9966;
            transform: scale(0.98);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²åˆ†ã‘ */
        .nav-item[onclick*="fee"],
        .nav-item[onclick*="gut"] {
            border-left: 5px solid #ffc107;
        }

        .nav-item[onclick*="shuttle"],
        .nav-item[onclick*="carry"],
        .nav-item[onclick*="skyArena"] {
            border-left: 5px solid #17a2b8;
        }

        .nav-item[onclick*="member"],
        .nav-item[onclick*="other"],
        .nav-item[onclick*="tournament"] {
            border-left: 5px solid #6c757d;
        }

        .nav-item[onclick*="attendance"],
        .nav-item[onclick*="task"] {
            border-left: 5px solid #FF9966;
        }


        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content-wrapper {
            padding: 0 15px 80px 15px;
        }

        .card-section {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            margin-bottom: 30px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            font-size: 18px;
            color: #444;
            border-left: 5px solid #FF9966;
            padding-left: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 16px;
            margin: 15px 0 10px 0;
            color: #555;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        select,
        input,
        textarea {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            background-color: #f9f9f9;
            transition: border-color 0.3s;
            appearance: none;
        }

        select:focus,
        input:focus,
        textarea:focus {
            border-color: #FF9966;
            outline: none;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* ãƒœã‚¿ãƒ³ */
        button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #FF9966;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 25px;
            box-shadow: 0 4px 10px rgba(255, 153, 102, 0.3);
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 5px rgba(255, 153, 102, 0.3);
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        th {
            background-color: #fafafa;
            color: #666;
            font-weight: bold;
            white-space: nowrap;
        }

        td.delete-col button {
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 0;
            width: auto;
            border-radius: 6px;
            background-color: #6c757d;
            box-shadow: none;
        }

        td.delete-col button:first-child {
            background-color: #17a2b8;
            margin-right: 5px;
        }

        td.delete-col button:last-child {
            background-color: #dc3545;
        }

        tr.other-completed {
            background-color: #f9f9f9;
            color: #333;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»é€šçŸ¥ */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-weight: bold;
            color: #FF9966;
            font-size: 1.2em;
        }

        #cache-notice {
            display: none;
            font-size: 0.8em;
            color: #888;
            text-align: center;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: inline-block;
        }

        .notice-wrapper {
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        /* ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ */
        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .member-card {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .member-card:active {
            transform: scale(0.96);
            background: #fdfdfd;
            border-color: #FF9966;
        }

        .member-name {
            font-weight: bold;
            font-size: 1.1em;
            display: block;
            margin-bottom: 3px;
            color: #333;
        }

        .member-grade {
            font-size: 0.8em;
            color: #999;
        }

        /* å€‹äººå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #individualModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .ind-header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #eee;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .ind-content {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .ind-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f4f4f4;
        }

        .ind-info {
            flex: 1;
        }

        .ind-btns {
            display: flex;
            gap: 8px;
        }

        .ind-btn {
            padding: 10px 14px;
            border: 1px solid #eee;
            background: white;
            border-radius: 12px;
            font-size: 14px;
            color: #ccc;
            cursor: pointer;
            width: auto;
            margin: 0;
            box-shadow: none;
            font-weight: bold;
        }

        .ind-btn.active.present {
            background: #28a745;
            color: white;
            border-color: #28a745;
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
        }

        .ind-btn.active.absent {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
        }

        .ind-btn.active.unknown {
            background: #eee;
            color: #555;
            border-color: #ddd;
        }

        /* å‚åŠ è€…ã¾ã¨ã‚ */
        .summary-box {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            border-left: 5px solid #ccc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .summary-box.club {
            border-left-color: #FF9966;
        }

        .summary-box.fed {
            border-left-color: #17a2b8;
        }

        .summary-box.skill {
            border-left-color: #6610f2;
        }

        .summary-header {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-count {
            font-size: 0.9em;
            color: white;
            background: #333;
            padding: 3px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .summary-names {
            font-size: 0.95em;
            color: #555;
            line-height: 1.6;
        }

        /* åç°¿ãƒ†ãƒ¼ãƒ–ãƒ«å°‚ç”¨ */
        #memberTable th,
        #memberTable td {
            text-align: center;
        }

        #memberTable th:nth-child(1) {
            width: 20%;
        }

        #memberTable th:nth-child(2) {
            width: 50%;
        }

        #memberTable th:nth-child(3) {
            width: 30%;
        }

        /* ãƒãƒˆãƒªã‚¯ã‚¹ç”¨ï¼ˆè£ã§ä½¿ç”¨ï¼‰ */
        .matrix-table {
            min-width: 800px;
            display: none;
        }

        /* å¤§ä¼šä¸€è¦§ã®å‚åŠ è€…åˆ—ç”¨ */
        .participant-cell {
            font-size: 0.85em;
            color: #555;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.5;
        }


        /* ã‚¹ãƒãƒ›è¡¨ç¤ºæœ€é©åŒ– */
        @media (max-width: 600px) {

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ */
            table {
                min-width: 0 !important;
                width: 100%;
            }

            .table-container {
                overflow-x: visible;
            }

            /* =========================================
           1. é“å…·é‹æ¬ (#listTable) - ã‚«ãƒ¼ãƒ‰åŒ–
           ========================================= */
            #listTable thead {
                display: none;
            }

            #listTable tbody tr {
                display: block;
                width: 100%;
                margin-bottom: 20px;
                background: #fff;
                border: 2px solid #17a2b8;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                box-sizing: border-box;
                position: relative;
                padding-bottom: 50px;
                /* ãƒœã‚¿ãƒ³ç”¨ä½™ç™½ */
            }

            #listTable tbody td {
                display: block;
                width: 100%;
                border: none;
                padding: 4px 0;
            }

            #listTable tbody td:nth-child(1) {
                /* æ—¥ä»˜ */
                font-weight: bold;
                color: #17a2b8;
                border-bottom: 1px solid #eee;
                margin-bottom: 5px;
            }

            #listTable tbody td:nth-child(2) {
                /* ä½“è‚²é¤¨ */
                font-size: 1.2em;
                font-weight: bold;
                color: #333;
            }

            #listTable tbody td:nth-child(2)::before {
                content: "ğŸŸï¸ ";
            }

            #listTable tbody td:nth-child(3) {
                /* æ‹…å½“è€… */
                color: #555;
            }

            #listTable tbody td:nth-child(3)::before {
                content: "ğŸ‘¤ ";
                color: #999;
            }

            #listTable tbody td:nth-child(4) {
                /* æŒå‚ç‰© */
                background: #f0f9fa;
                padding: 10px;
                border-radius: 8px;
                font-size: 0.9em;
                color: #333;
                line-height: 1.5;
                white-space: normal;
                margin-top: 5px;
            }

            #listTable tbody td:nth-child(4)::before {
                content: "ğŸ‘œ æŒå‚ç‰©";
                display: block;
                font-size: 0.8em;
                color: #17a2b8;
                font-weight: bold;
                margin-bottom: 3px;
            }

            /* ãƒœã‚¿ãƒ³é…ç½®ï¼ˆå³ä¸‹çµ¶å¯¾é…ç½®ï¼‰ */
            #listTable tbody td.delete-col {
                display: inline-block;
                width: auto;
                position: absolute;
                bottom: 10px;
            }

            #listTable tbody td:nth-child(5) {
                right: 70px;
            }

            #listTable tbody td:nth-child(6) {
                right: 10px;
            }


            /* =========================================
           2. ã‚¹ã‚«ã‚¤ã‚¢ãƒªãƒ¼ãƒŠåº§é–“ (#arenaTable) - ã‚«ãƒ¼ãƒ‰åŒ–
           ========================================= */
            #arenaTable thead {
                display: none;
            }

            #arenaTable tbody tr {
                display: block;
                width: 100%;
                margin-bottom: 20px;
                background: #fff;
                border: 2px solid #4facfe;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                box-sizing: border-box;
            }

            #arenaTable tbody td {
                display: block;
                width: 100%;
                border: none;
                padding: 5px 0;
            }

            /* æœˆãƒ»No */
            #arenaTable tbody td:nth-child(2) {
                font-weight: bold;
                color: #4facfe;
                border-bottom: 1px solid #eee;
                margin-bottom: 5px;
            }

            #arenaTable tbody td:nth-child(2)::before {
                content: "ğŸ“… ";
            }

            #arenaTable tbody td:nth-child(2)::after {
                content: " (No." attr(data-no) ")";
                color: #999;
                font-size: 0.8em;
            }

            /* Noåˆ—ã¯éè¡¨ç¤ºï¼ˆæœˆã¨ä¸€ç·’ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰ */
            #arenaTable tbody td:nth-child(1) {
                display: none;
            }

            /* ã‚¿ã‚¹ã‚¯å */
            #arenaTable tbody td:nth-child(3) {
                font-size: 1.1em;
                font-weight: bold;
                color: #333;
            }

            /* æ‹…å½“è€…ãƒ»å®Œäº† */
            #arenaTable tbody td:nth-child(4) {
                display: inline-block;
                width: auto;
                margin-right: 15px;
            }

            #arenaTable tbody td:nth-child(4)::before {
                content: "ğŸ‘¤ ";
                color: #999;
            }

            #arenaTable tbody td:nth-child(5) {
                display: inline-block;
                width: auto;
                font-weight: bold;
            }

            /* å†™çœŸ */
            #arenaTable tbody td:nth-child(6) {
                text-align: center;
                margin-top: 5px;
            }

            #arenaTable tbody td:nth-child(6) img {
                max-width: 100%;
                border-radius: 8px;
                max-height: 200px;
                object-fit: cover;
            }

            /* ãƒœã‚¿ãƒ³ï¼ˆFlexboxã§å³å¯„ã›ï¼‰ */
            #arenaTable tbody td.delete-col {
                display: flex;
                justify-content: flex-end;
                gap: 5px;
                margin-top: 10px;
                border-top: 1px dashed #eee;
                padding-top: 10px;
            }


            /* =========================================
           3. ãã®ä»–é€£çµ¡äº‹é … (#otherList) - ã‚«ãƒ¼ãƒ‰åŒ–
           ========================================= */
            #otherList thead {
                display: none;
            }

            #otherList tbody tr {
                display: block;
                width: 100%;
                margin-bottom: 20px;
                background: #fff;
                border: 2px solid #6c757d;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                box-sizing: border-box;
            }

            #otherList tbody tr.other-completed {
                border-color: #ccc;
                background: #f9f9f9;
            }

            #otherList tbody td {
                display: block;
                width: 100%;
                border: none;
                padding: 5px 0;
            }

            /* ã‚¿ã‚¤ãƒˆãƒ« */
            #otherList tbody td:nth-child(1) {
                font-weight: bold;
                font-size: 1.1em;
                color: #333;
                border-bottom: 2px solid #6c757d;
                margin-bottom: 10px;
                padding-bottom: 5px;
            }

            /* å†…å®¹ */
            #otherList tbody td:nth-child(2) {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 8px;
                color: #444;
                white-space: pre-wrap;
                margin-bottom: 10px;
                line-height: 1.6;
            }

            /* æ‹…å½“è€…ãƒ»çŠ¶æ³ */
            #otherList tbody td:nth-child(3) {
                display: inline-block;
                width: auto;
                margin-right: 10px;
                font-size: 0.9em;
                color: #666;
            }

            #otherList tbody td:nth-child(3)::before {
                content: "æ‹…å½“: ";
            }

            #otherList tbody td:nth-child(4) {
                display: inline-block;
                width: auto;
                font-weight: bold;
                font-size: 0.9em;
            }

            #otherList tbody td:nth-child(4)::before {
                content: "çŠ¶æ³: ";
                color: #999;
                font-weight: normal;
            }

            /* ãƒœã‚¿ãƒ³ */
            #otherList tbody td.delete-col {
                display: flex;
                justify-content: flex-end;
                gap: 5px;
                margin-top: 10px;
            }


            /* =========================================
           4. æ—¢å­˜ã®ã‚¹ãƒãƒ›å¯¾å¿œç¶­æŒï¼ˆå¤§ä¼šãƒ»èª²é¡Œï¼‰
           ========================================= */
            #tournamentTable thead {
                display: none;
            }

            #tournamentTable tbody tr {
                display: block;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 20px;
                background: #fff;
                border: 2px solid #FF9966;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            }

            #tournamentTable tbody td {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                border-bottom: 1px dashed #eee;
                padding: 10px 0;
                text-align: right;
                font-size: 0.95em;
                width: 100%;
                box-sizing: border-box;
            }

            #tournamentTable tbody td:last-child {
                border-bottom: none;
            }

            #tournamentTable tbody td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #888;
                font-size: 0.85em;
                margin-right: 15px;
                white-space: nowrap;
                text-align: left;
                flex-shrink: 0;
            }

            #tournamentTable tbody td[data-label="å‚åŠ è€…"] {
                display: block;
                text-align: left;
            }

            #tournamentTable tbody td[data-label="å‚åŠ è€…"]::before {
                display: block;
                margin-bottom: 5px;
                color: #FF9966;
            }

            #taskTable thead {
                display: none;
            }

            #taskTable tbody tr {
                display: block;
                width: 100%;
                margin-bottom: 20px;
                background: #fff;
                border: 2px solid #1976D2;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                box-sizing: border-box;
            }

            #taskTable tbody td {
                display: block;
                width: 100%;
                text-align: left;
                padding: 8px 0;
                border-bottom: 1px dashed #eee;
                box-sizing: border-box;
            }

            #taskTable tbody td:last-child {
                border-bottom: none;
                display: flex;
                justify-content: flex-end;
                flex-wrap: wrap;
                gap: 5px;
            }

            #taskTable tbody td::before {
                content: attr(data-label);
                display: block;
                font-weight: bold;
                color: #1976D2;
                font-size: 0.85em;
                margin-bottom: 4px;
            }
        }

        #taskTable tbody td:nth-child(2) {
            font-size: 1.05em;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .checkbox-label {
            display: inline-block;
            padding: 10px 16px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            transition: all 0.2s ease;
            user-select: none;
        }

        .checkbox-label input {
            display: none;
        }

        .checkbox-label:has(input:checked) {
            background-color: #FF9966;
            color: white;
            border-color: #FF9966;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(255, 153, 102, 0.4);
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .summary-container {
            margin-bottom: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #eee;
        }

        .summary-toggle-header {
            background: #fff;
            color: #333;
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
            border-left: 6px solid #FF9966;
            transition: background 0.3s;
        }

        .summary-toggle-header:active {
            background: #f0f0f0;
        }

        .toggle-icon {
            font-size: 0.8em;
            transition: transform 0.3s ease;
            color: #999;
        }

        .summary-toggle-header.open .toggle-icon {
            transform: rotate(180deg);
        }

        .summary-content {
            display: none;
            padding: 10px 15px 20px 15px;
            background: #fafafa;
            border-top: 1px solid #f0f0f0;
        }

        .summary-content.open {
            display: block;
        }

        .fed-header {
            border-left-color: #17a2b8;
        }

        /* ã‚·ãƒ£ãƒˆãƒ«ç®¡ç† */
        .shuttle-group-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
            margin-bottom: 30px;
        }

        .shuttle-card {
            border-radius: 16px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        /* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ */
        .jr-card {
            background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
        }

        .fed-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .kamitsu-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .shuttle-card h4 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .stock-display {
            text-align: center;
            margin: 15px 0;
        }

        .stock-number {
            font-size: 3.5em;
            font-weight: bold;
            line-height: 1;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .stock-unit {
            font-size: 24px;
            margin-left: 5px;
            font-weight: bold;
            vertical-align: baseline;
        }

        .shuttle-control {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .shuttle-details {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .shuttle-control div {
            text-align: center;
        }

        .shuttle-control label,
        .shuttle-details label {
            display: block;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
            font-weight: bold;
        }

        /* å…¥åŠ›æ¬„å…±é€š */
        .shuttle-control input,
        .shuttle-details select,
        .shuttle-details input {
            width: 100%;
            border-radius: 8px;
            padding: 8px;
            font-size: 1em;
            box-sizing: border-box;
            background: #ffffff;
            border: 2px solid #fff;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .shuttle-control input {
            text-align: center;
            font-size: 1.2em;
        }

        /* å„ã‚«ãƒ¼ãƒ‰ã”ã¨ã®å…¥åŠ›è‰²èª¿æ•´ */
        .jr-card .shuttle-control input,
        .jr-card .shuttle-details input,
        .jr-card .shuttle-details select {
            color: #FF5E62;
        }

        .jr-card .shuttle-control input::placeholder {
            color: #ffcdd2;
        }

        .fed-card .shuttle-control input,
        .fed-card .shuttle-details input,
        .fed-card .shuttle-details select {
            color: #0277BD;
        }

        .fed-card .shuttle-control input::placeholder {
            color: #b3e5fc;
        }

        .kamitsu-card .shuttle-control input,
        .kamitsu-card .shuttle-details input,
        .kamitsu-card .shuttle-details select {
            color: #00897b;
        }

        .kamitsu-card .shuttle-control input::placeholder {
            color: #b2dfdb;
        }

        .kamitsu-card button {
            color: #00897b;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.85em;
        }

        .stat-item {
            text-align: center;
        }

        .stat-val {
            display: block;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* ãƒ¡ãƒ¢ */
        .summary-memo-container {
            margin-top: 8px;
            border-top: 1px dashed #eee;
        }

        .memo-toggle-header {
            padding: 6px 4px;
            cursor: pointer;
            color: #666;
            font-size: 0.85em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .memo-toggle-header:active {
            background-color: #f5f5f5;
        }

        .memo-list-content {
            display: none;
            padding: 5px 10px 10px 10px;
            background-color: #fafafa;
            border-radius: 6px;
            margin-top: 2px;
        }

        .memo-item {
            font-size: 0.9em;
            margin-bottom: 6px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
            line-height: 1.4;
        }

        .memo-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .memo-person-name {
            font-weight: bold;
            margin-right: 6px;
            color: #333;
        }

        .memo-text {
            color: #333;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #tournamentDetailModal,
        #taskEditModal,
        #reflectionModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 3000;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .tournament-file-area {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px dashed #ddd;
        }

        .participant-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .payment-status-btn {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #ddd;
            background: #eee;
            color: #888;
            transition: all 0.2s;
        }

        .payment-status-btn.paid {
            background: #E3F2FD;
            color: #1976D2;
            border-color: #BBDEFB;
        }

        .payment-status-btn.unpaid {
            background: #FFEBEE;
            color: #D32F2F;
            border-color: #FFCDD2;
        }

        .add-participant-box {
            margin-top: 15px;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f4f7f6;
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .login-overlay.active {
            display: flex;
        }

        .login-box {
            width: 85%;
            max-width: 320px;
            background: white;
            padding: 30px 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .login-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .login-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .pass-input {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            margin-bottom: 20px;
            box-sizing: border-box;
            text-align: center;
            letter-spacing: 2px;
            -webkit-text-security: disc;
        }

        .pass-input:focus {
            border-color: #FF9966;
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #FF9966;
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 153, 102, 0.3);
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-container {
            position: relative;
            margin: 20px 0 0 10px;
            padding-left: 20px;
            border-left: 3px solid #FF9966;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 15px;
            width: 15px;
            height: 15px;
            background: white;
            border: 3px solid #FF9966;
            border-radius: 50%;
            z-index: 1;
        }

        .timeline-date-label {
            font-weight: bold;
            color: #FF9966;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .timeline-content-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 15px;
            position: relative;
            border: 1px solid #eee;
        }

        .timeline-content-box::after {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid white;
        }

        .tl-task-section {
            margin-bottom: 10px;
        }

        .tl-reflect-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            background: #f9fff9;
            margin: 10px -15px -15px -15px;
            padding: 10px 15px;
            border-radius: 0 0 12px 12px;
        }

        .tl-label {
            font-size: 0.75em;
            font-weight: bold;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            color: white;
        }

        .bg-task {
            background: #1976D2;
        }

        .bg-reflect {
            background: #2E7D32;
        }

        /* ã‚·ãƒ£ãƒˆãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .shuttle-cal-wrapper {
            margin-top: 30px;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
        }

        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cal-month-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: #ddd;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .cal-weekday {
            background: #f0f0f0;
            text-align: center;
            font-size: 0.8em;
            font-weight: bold;
            padding: 5px 0;
            color: #666;
        }

        .cal-weekday.sun {
            color: #FF5E62;
        }

        .cal-weekday.sat {
            color: #4facfe;
        }

        .cal-cell {
            background: white;
            min-height: 80px;
            padding: 4px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .cal-cell:active {
            background: #fafafa;
        }

        /* æ—¥ä»˜ã®è‰²ã¯å¸¸ã«é»’ */
        .cal-date-num {
            font-size: 0.9em;
            font-weight: bold;
            color: #333 !important;
            margin-bottom: 2px;
        }

        /* ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æ—¥ã¯å¤ªå­—å¼·èª¿ã®ã¿ */
        .cal-has-data {
            font-weight: 900;
        }

        .cal-today {
            background: #fff5e0;
            border: 2px solid #FF9966;
            box-sizing: border-box;
        }

        /* ãƒãƒƒã‚¸ã‚¨ãƒªã‚¢ */
        .cal-indicators {
            display: flex;
            flex-wrap: wrap;
            /* æ¨ªä¸¦ã³ã€æº¢ã‚ŒãŸã‚‰æ”¹è¡Œ */
            gap: 2px;
            justify-content: center;
            width: 100%;
            margin-top: 2px;
        }

        /* ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‰ãƒƒãƒˆï¼ˆãƒãƒƒã‚¸ï¼‰ */
        .cal-info-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .badge-kamiho {
            background-color: #FF5E62;
        }

        /* ä¸Šæ˜Ÿ */
        .badge-kamitsu {
            background-color: #00897b;
        }

        /* ä¸Šé¶´é–“ */
        .badge-fed {
            background-color: #0277BD;
        }

        /* ä¸­å­¦ */

        /* è©³ç´°è¡¨ç¤º */
        #shuttleDayDetail {
            display: none;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
            animation: fadeIn 0.3s ease;
        }

        .detail-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 8px 0;
            font-size: 0.9em;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        /* è©³ç´°ãƒªã‚¹ãƒˆã®ãƒãƒƒã‚¸ */
        .detail-cat {
            font-weight: bold;
            font-size: 0.85em;
            padding: 3px 10px;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: inline-block;
            min-width: 60px;
            text-align: center;
            margin-right: 10px;
        }

        /* è‰²å®šç¾©ï¼ˆè©³ç´°ãƒªã‚¹ãƒˆç”¨ï¼‰ */
        .bg-kamiho {
            background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
            color: white;
        }

        .bg-kamitsu {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .bg-fed {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .detail-row-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 6px;
        }

        .detail-stats {
            font-size: 0.95em;
            color: #333;
        }
    </style>
</head>

<body>

    <div id="loading">
        <div style="text-align:center;">
            <div style="margin-bottom:10px;">å‡¦ç†ä¸­...</div>
            <div style="font-size:0.8em; color:#999;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
        </div>
    </div>

    <header>
        <h1>æ³•æ”¿Jr.ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã‚¯ãƒ©ãƒ–<br>é‹å–¶ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
    </header>

    <div class="notice-wrapper">
        <div id="cache-notice">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...</div>
    </div>

    <div class="nav-container">
        <div class="nav-item active" onclick="switchCategory('attendance', this)">ğŸ“… å‡ºæ¬ ç¢ºèª</div>
        <div class="nav-item" onclick="switchCategory('task', this)">ğŸ“Š èª²é¡Œåˆ†æ</div>
        <div class="nav-item" onclick="switchCategory('shuttle', this)">ğŸ¸ ã‚·ãƒ£ãƒˆãƒ«</div>
        <div class="nav-item" onclick="switchCategory('carry', this)">ğŸš™ é“å…·é‹æ¬</div>
        <div class="nav-item" onclick="switchCategory('skyArena', this)">ğŸŸï¸ ã‚¹ã‚«ã‚¤ã‚¢ãƒªãƒ¼ãƒŠåº§é–“</div>
        <div class="nav-item" onclick="switchCategory('tournament', this)">ğŸ† å¤§ä¼šç”³è¾¼</div>
        <div class="nav-item" onclick="switchCategory('fee', this)">ğŸ’´ æœˆè¬</div>
        <div class="nav-item" onclick="switchCategory('gut', this)">ğŸ¸ ã‚¬ãƒƒãƒˆ</div>
        <div class="nav-item" onclick="switchCategory('other', this)">ğŸ“ ãã®ä»–</div>
        <div class="nav-item" onclick="switchCategory('member', this)">ğŸ‘¥ åç°¿</div>
    </div>

    <div class="content-wrapper">

        <div id="attendanceSection" class="card-section">
            <h2>å‡ºæ¬ ç¢ºèª</h2>
            <p style="font-size:0.9em; color:#666; margin-bottom:20px;">æ°åã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ä»Šå¾Œã®å‡ºæ¬ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

            <div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button onclick="openSettingModal()"
                        style="width:auto; margin:0; padding:8px 16px; font-size:0.9em; background:#666; border-radius:20px; box-shadow:none;">âš™ï¸
                        è¡¨ç¤ºè¨­å®š</button>
                    <button id="toggleDisplayBtn" onclick="toggleShowAll()"
                        style="width:auto; margin:0; padding:8px 16px; font-size:0.9em; background:#FF9966; border-radius:20px; box-shadow:none;">ğŸ‘¥
                        å…¨å“¡ã‚’è¡¨ç¤º</button>
                </div>
                <div id="selectedMembersLabel" style="font-size:0.85em; color:#888; margin-top:10px;"></div>
            </div>

            <div id="memberListContainer" class="member-grid"></div>
            <div id="matrixError" style="color:red; margin-top:10px; display:none;">â€»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASãŒæœ€æ–°ç‰ˆã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>

            <div style="margin-top:30px;">
                <div class="summary-container">
                    <div class="summary-toggle-header open" onclick="toggleSummary('clubContent', this)">
                        <span>æ³•æ”¿Jr.ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã‚¯ãƒ©ãƒ–ãƒ»ä¸­å­¦ç”Ÿã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ã‚¹</span>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div id="clubContent" class="summary-content open">
                        <div id="attendanceSummary"></div>
                    </div>
                </div>
            </div>

            <div style="margin-top:20px;">
                <div class="summary-container">
                    <div class="summary-toggle-header fed-header open" onclick="toggleSummary('fedContent', this)">
                        <span>ä¸­å­¦ç”Ÿç·´ç¿’</span>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div id="fedContent" class="summary-content open">
                        <div id="attendanceSummaryFed"></div>
                    </div>
                </div>
            </div>

            <table id="matrixTable" class="matrix-table">
                <thead>
                    <tr id="matrixHeader"></tr>
                </thead>
                <tbody id="matrixBody"></tbody>
            </table>
        </div>

        <div id="taskSection" class="card-section" style="display:none;">
            <h2>èª²é¡Œã®åé›†ã¨åˆ†æ</h2>
            <p style="font-size:0.9em; color:#666;">é€£ç›Ÿç™»éŒ²è€…ï¼ˆå°å­¦ç”Ÿãƒ»ä¸­å­¦ç”Ÿï¼‰ã®ã¿å…¥åŠ›å¯èƒ½ã§ã™ã€‚</p>

            <div style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee;">
                <label style="font-weight:bold; color:#555;">æ°å</label>
                <select id="taskName" style="margin-bottom:15px;">
                    <option value="">åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>

                <label style="font-weight:bold; color:#555;">å–ã‚Šçµ„ã‚€ç¨®ç›®</label>

                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input type="radio" name="taskType" value="ã‚·ãƒ³ã‚°ãƒ«ã‚¹" checked>
                        ã‚·ãƒ³ã‚°ãƒ«ã‚¹
                    </label>

                    <label class="checkbox-label">
                        <input type="radio" name="taskType" value="ãƒ€ãƒ–ãƒ«ã‚¹">
                        ãƒ€ãƒ–ãƒ«ã‚¹
                    </label>
                </div>
                <label style="font-weight:bold; color:#555;">ç¾åœ¨ã®èª²é¡Œï¼ˆå…·ä½“çš„ã«ï¼‰</label>
                <textarea id="taskContent" rows="3" placeholder="ä¾‹ï¼šã‚¹ãƒãƒƒã‚·ãƒ¥ãŒæµ®ã„ã¦ã—ã¾ã†ã€‚å‰è¡›ã§ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒé…ã‚Œã‚‹ã€‚"></textarea>

                <button type="button" onclick="submitTask()">èª²é¡Œã‚’ç™»éŒ²ã™ã‚‹</button>
            </div>

            <hr style="margin: 30px 0; border:none; border-top:1px dashed #ccc;">

            <div
                style="display:flex; background:#fff; border-radius:30px; border:1px solid #ddd; padding:4px; margin: 20px 0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <button onclick="switchViewMode('category')" id="btnViewCategory"
                    style="flex:1; margin:0; border-radius:25px; box-shadow:none; background:#FF9966; color:white; font-size:0.9em;">ğŸ“Š
                    å…¨ä½“ãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ†æ</button>
                <button onclick="switchViewMode('personal')" id="btnViewPersonal"
                    style="flex:1; margin:0; border-radius:25px; box-shadow:none; background:transparent; color:#666; font-size:0.9em;">ğŸ‘¤
                    å€‹äººãƒ»å¤‰é·å±¥æ­´</button>
            </div>

            <div id="personalHistoryArea" style="display:none; animation: fadeIn 0.3s ease;">
                <h4 style="margin:0 0 10px 0; color:#333;">é¸æ‰‹ã®æˆé•·è¨˜éŒ²</h4>
                <select id="timelineMemberSelect" onchange="renderPersonalHistory()"
                    style="margin-bottom:10px; border:2px solid #FF9966;">
                    <option value="">å±¥æ­´ã‚’è¦‹ãŸã„é¸æ‰‹ã‚’é¸æŠ</option>
                </select>
                <div id="timelineContainer"></div>
            </div>
            <div id="categoryAnalysisArea">
                <h3>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ åˆ†æãƒ»é›†è¨ˆ</h3>

                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;">
                    <button onclick="switchAnalysisTab('elem_s')" id="tab_elem_s" class="analysis-tab active"
                        style="width:auto; padding:6px 10px; font-size:0.8em; margin:0;">å°ãƒ»ã‚·ãƒ³ã‚°ãƒ«</button>
                    <button onclick="switchAnalysisTab('elem_d')" id="tab_elem_d" class="analysis-tab"
                        style="width:auto; padding:6px 10px; font-size:0.8em; margin:0; background:#eee; color:#666;">å°ãƒ»ãƒ€ãƒ–ãƒ«</button>
                    <button onclick="switchAnalysisTab('mid_s')" id="tab_mid_s" class="analysis-tab"
                        style="width:auto; padding:6px 10px; font-size:0.8em; margin:0; background:#eee; color:#666;">ä¸­ãƒ»ã‚·ãƒ³ã‚°ãƒ«</button>
                    <button onclick="switchAnalysisTab('mid_d')" id="tab_mid_d" class="analysis-tab"
                        style="width:auto; padding:6px 10px; font-size:0.8em; margin:0; background:#eee; color:#666;">ä¸­ãƒ»ãƒ€ãƒ–ãƒ«</button>
                </div>

                <div id="analysisResultArea">
                    <h4 id="analysisTitle" style="margin:0 0 10px 0; color:#FF9966;">å°å­¦ç”Ÿ ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã®èª²é¡Œå‚¾å‘</h4>

                    <div id="keywordRanking"
                        style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; min-height:50px;"></div>

                    <div
                        style="background:#E3F2FD; padding:15px; border-radius:12px; border:1px solid #BBDEFB; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h4 style="margin:0 0 5px 0; color:#1565C0;">ğŸ¤– AIãƒãƒ¼ãƒ ç·´ç¿’ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h4>
                            <div style="font-size:0.85em; color:#555;">é›†è¨ˆã•ã‚ŒãŸèª²é¡Œå‚¾å‘ã‹ã‚‰ã€ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¡ˆã‚’ä½œæˆã—ã¾ã™ã€‚</div>
                        </div>
                        <button onclick="generateTeamPlanPrompt()"
                            style="width:auto; padding:10px 16px; background:#1976D2; border:none; box-shadow:0 2px 5px rgba(0,0,0,0.2); font-size:0.9em;">
                            ğŸš€ Smart Coachã§AIãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆ
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="taskTable">
                            <thead>
                                <tr>
                                    <th>æ°å</th>
                                    <th>èª²é¡Œ</th>
                                    <th>æ—¥æ™‚</th>
                                    <th class="delete-col">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div style="text-align:right; margin-top:10px;">
                    <button type="button" onclick="loadTasks()"
                        style="width:auto; padding:6px 12px; font-size:0.8em; background:#666; box-shadow:none; margin:0;">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
                </div>
            </div>
        </div>

        <div id="shuttleSection" class="card-section"
            style="display:none; background:transparent; box-shadow:none; padding:0;">
            <h2>ã‚·ãƒ£ãƒˆãƒ«åœ¨åº«ç®¡ç†</h2>

            <div class="shuttle-group-container">

                <div class="shuttle-card jr-card">
                    <h4 style="font-size:1em;">ğŸ¸ æ³•æ”¿Jr.ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã‚¯ãƒ©ãƒ–ï¼ˆä¸Šæ˜Ÿå°å­¦æ ¡ï¼‰</h4>
                    <div class="stock-display">
                        <span class="stock-number" id="jrKamihoStock">0</span><span class="stock-unit">ç­’</span>
                    </div>
                    <div class="shuttle-control">
                        <div><label>ä½¿ç”¨æ•° (-)</label><input type="number" id="jrKamihoUsed" placeholder="0"></div>
                        <div><label>è¿½åŠ æ•° (+)</label><input type="number" id="jrKamihoAdded" placeholder="0"></div>
                    </div>
                    <div class="shuttle-details">
                        <label>ç”¨é€”</label>
                        <select id="jrKamihoType" style="margin-bottom:8px;">
                            <option value="ç·´ç¿’">ç·´ç¿’</option>
                            <option value="ç·´ç¿’è©¦åˆ">ç·´ç¿’è©¦åˆ</option>
                            <option value="å¤§ä¼š">å¤§ä¼š</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                        <label>å‚™è€ƒ</label>
                        <input type="text" id="jrKamihoMemo" placeholder="è©³ç´°ãƒ¡ãƒ¢">
                    </div>
                    <button onclick="updateShuttleStock('jr_kamiho')"
                        style="background:white; color:#FF5E62; margin-top:15px; width:100%; padding:10px; border-radius:10px; border:none; font-weight:bold;">åœ¨åº«ã‚’æ›´æ–°ãƒ»è¨˜éŒ²</button>
                    <div class="stats-row">
                        <div class="stat-item"><span style="opacity:0.8;">ä»Šé€±ã®ä½¿ç”¨</span><span class="stat-val"><span
                                    id="jrKamihoWeekUsed">0</span><small>ç­’</small></span></div>
                        <div class="stat-item"><span style="opacity:0.8;">ä»Šæœˆã®ä½¿ç”¨</span><span class="stat-val"><span
                                    id="jrKamihoMonthUsed">0</span><small>ç­’</small></span></div>
                    </div>
                </div>

                <div class="shuttle-card kamitsu-card">
                    <h4 style="font-size:1em;">ğŸ¸ æ³•æ”¿Jr.ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã‚¯ãƒ©ãƒ–ï¼ˆä¸Šé¶´é–“å°å­¦æ ¡ï¼‰</h4>
                    <div class="stock-display">
                        <span class="stock-number" id="jrKamitsuStock">0</span><span class="stock-unit">ç­’</span>
                    </div>
                    <div class="shuttle-control">
                        <div><label>ä½¿ç”¨æ•° (-)</label><input type="number" id="jrKamitsuUsed" placeholder="0"></div>
                        <div><label>è¿½åŠ æ•° (+)</label><input type="number" id="jrKamitsuAdded" placeholder="0"></div>
                    </div>
                    <div class="shuttle-details">
                        <label>ç”¨é€”</label>
                        <select id="jrKamitsuType" style="margin-bottom:8px;">
                            <option value="ç·´ç¿’">ç·´ç¿’</option>
                            <option value="ç·´ç¿’è©¦åˆ">ç·´ç¿’è©¦åˆ</option>
                            <option value="å¤§ä¼š">å¤§ä¼š</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                        <label>å‚™è€ƒ</label>
                        <input type="text" id="jrKamitsuMemo" placeholder="è©³ç´°ãƒ¡ãƒ¢">
                    </div>
                    <button onclick="updateShuttleStock('jr_kamitsu')"
                        style="background:white; color:#FF5E62; margin-top:15px; width:100%; padding:10px; border-radius:10px; border:none; font-weight:bold;">åœ¨åº«ã‚’æ›´æ–°ãƒ»è¨˜éŒ²</button>
                    <div class="stats-row">
                        <div class="stat-item"><span style="opacity:0.8;">ä»Šé€±ã®ä½¿ç”¨</span><span class="stat-val"><span
                                    id="jrKamitsuWeekUsed">0</span><small>ç­’</small></span></div>
                        <div class="stat-item"><span style="opacity:0.8;">ä»Šæœˆã®ä½¿ç”¨</span><span class="stat-val"><span
                                    id="jrKamitsuMonthUsed">0</span><small>ç­’</small></span></div>
                    </div>
                </div>

                <div class="shuttle-card fed-card">
                    <h4>ğŸ¸ ä¸­å­¦ç”Ÿç·´ç¿’</h4>
                    <div class="stock-display">
                        <span class="stock-number" id="fedStock">0</span><span class="stock-unit">ç­’</span>
                    </div>
                    <div class="shuttle-control">
                        <div><label>ä½¿ç”¨æ•° (-)</label><input type="number" id="fedUsed" placeholder="0"></div>
                        <div><label>è¿½åŠ æ•° (+)</label><input type="number" id="fedAdded" placeholder="0"></div>
                    </div>
                    <div class="shuttle-details">
                        <label>ç”¨é€”</label>
                        <select id="fedType" style="margin-bottom:8px;">
                            <option value="ç·´ç¿’">ç·´ç¿’</option>
                            <option value="ç·´ç¿’è©¦åˆ">ç·´ç¿’è©¦åˆ</option>
                            <option value="å¤§ä¼š">å¤§ä¼š</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                        <label>å‚™è€ƒ</label>
                        <input type="text" id="fedMemo" placeholder="è©³ç´°ãƒ¡ãƒ¢">
                    </div>
                    <button onclick="updateShuttleStock('fed')"
                        style="background:white; color:#4facfe; margin-top:15px; width:100%; padding:10px; border-radius:10px; border:none; font-weight:bold;">åœ¨åº«ã‚’æ›´æ–°ãƒ»è¨˜éŒ²</button>
                    <div class="stats-row">
                        <div class="stat-item"><span style="opacity:0.8;">ä»Šé€±ã®ä½¿ç”¨</span><span class="stat-val"><span
                                    id="fedWeekUsed">0</span><small>ç­’</small></span></div>
                        <div class="stat-item">
                            <span style="opacity:0.8;">ä»Šæœˆã®ä½¿ç”¨</span>
                            <span class="stat-val"><span id="fedMonthUsed">0</span><small>ç­’</small></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="shuttle-cal-wrapper">
                <h3 style="color:#555; border-left:5px solid #666; padding-left:10px;">ğŸ“… ä½¿ç”¨ãƒ»å…¥è·å±¥æ­´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>

                <div class="cal-header">
                    <button onclick="changeShuttleMonth(-1)"
                        style="width:auto; padding:5px 15px; margin:0; background:#eee; color:#333; box-shadow:none;">â—€</button>
                    <span id="shuttleCalTitle" class="cal-month-title">2024å¹´ 1æœˆ</span>
                    <button onclick="changeShuttleMonth(1)"
                        style="width:auto; padding:5px 15px; margin:0; background:#eee; color:#333; box-shadow:none;">â–¶</button>
                </div>

                <div class="cal-grid" id="shuttleCalendarGrid"></div>

                <div id="shuttleDayDetail">
                    <h4 id="detailDateStr"
                        style="margin:0 0 10px 0; color:#333; border-bottom:2px solid #FF9966; padding-bottom:5px;">
                    </h4>
                    <div id="detailListContent"></div>
                    <button onclick="document.getElementById('shuttleDayDetail').style.display='none'"
                        style="margin-top:15px; background:#ccc; color:#333;">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
        <div id="carrySection" class="card-section" style="display:none;">
            <h2>é“å…·é‹æ¬ç®¡ç†</h2>
            <label>ç·´ç¿’æ—¥</label>
            <select id="dateSelect" onchange="updateGym()">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <label>ä½“è‚²é¤¨</label>
            <input type="text" id="gym" readonly style="background-color:#eee;">

            <label>æ‹…å½“è€…</label>
            <input type="text" id="person" placeholder="åå‰ã‚’å…¥åŠ›">

            <label>æŒå‚ç‰©</label>
            <div id="carryItemsBox" class="checkbox-container">
                <label class="checkbox-label"><input type="checkbox" value="ãƒãƒƒãƒˆ"> ãƒãƒƒãƒˆ</label>
                <label class="checkbox-label"><input type="checkbox" value="ãƒãƒƒã‚¯ã‚±ãƒ¼ã‚¹"> ãƒãƒƒã‚¯ã‚±ãƒ¼ã‚¹</label>
                <label class="checkbox-label"><input type="checkbox" value="ãƒ‹ãƒ¥ãƒ¼ã‚·ãƒ£ãƒˆãƒ«"> ãƒ‹ãƒ¥ãƒ¼ã‚·ãƒ£ãƒˆãƒ«</label>
                <label class="checkbox-label"><input type="checkbox" value="ãƒ©ãƒ€ãƒ¼"> ãƒ©ãƒ€ãƒ¼</label>
                <label class="checkbox-label"><input type="checkbox" value="ã‚¿ã‚¤ãƒãƒ¼"> ã‚¿ã‚¤ãƒãƒ¼</label>
                <label class="checkbox-label"><input type="checkbox" value="éµ"> éµ</label>
                <label class="checkbox-label"><input type="checkbox" value="å—ä»˜"> å—ä»˜</label>
            </div>

            <button type="button" onclick="submitForm()">ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹</button>

            <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                <h2>ç™»éŒ²æ¸ˆã¿ä¸€è¦§</h2>
                <div class="table-container">
                    <table id="listTable">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ä½“è‚²é¤¨</th>
                                <th>æ‹…å½“è€…</th>
                                <th>æŒå‚ç‰©</th>
                                <th class="delete-col">ç·¨é›†</th>
                                <th class="delete-col">å‰Šé™¤</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="skyArenaSection" class="card-section" style="display:none;">
            <h2>ã‚¹ã‚«ã‚¤ã‚¢ãƒªãƒ¼ãƒŠåº§é–“ã‚¿ã‚¹ã‚¯</h2>
            <label>å¯¾è±¡æœˆ</label>
            <input type="month" id="arenaMonth">
            <label>ã‚¿ã‚¹ã‚¯å†…å®¹</label>
            <select id="arenaTask">
                <option value="æŠ½é¸äºˆç´„ï¼ˆä½“è‚²é¤¨ã®æ©Ÿæ¢°ï¼‰">æŠ½é¸äºˆç´„ï¼ˆä½“è‚²é¤¨ã®æ©Ÿæ¢°ï¼‰</option>
                <option value="è¿½åŠ äºˆç´„ï¼ˆé›»è©±ï¼‰">è¿½åŠ äºˆç´„ï¼ˆé›»è©±ï¼‰</option>
                <option value="ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆæŠ½é¸äºˆç´„ï¼‰">ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆæŠ½é¸äºˆç´„ï¼‰</option>
                <option value="ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆè¿½åŠ äºˆç´„ï¼‰">ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆè¿½åŠ äºˆç´„ï¼‰</option>
                <option value="ä½¿ç”¨æ–™ã®æ”¯æ‰•ã„">ä½¿ç”¨æ–™ã®æ”¯æ‰•ã„</option>
                <option value="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¢ºèª">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¢ºèª</option>
            </select>
            <label>æ‹…å½“è€…</label>
            <input type="text" id="arenaPerson" placeholder="åå‰ã‚’å…¥åŠ›">
            <label>å®Œäº†çŠ¶æ³</label>
            <select id="arenaCompleted">
                <option value="false">â¬œ æœªå®Œäº†</option>
                <option value="true">âœ… å®Œäº†</option>
            </select>
            <label>å†™çœŸ (ä»»æ„ãƒ»Firebaseä¿å­˜)</label>
            <input type="file" id="arenaPhoto" accept="image/*" style="padding:10px; border:1px dashed #ccc;">
            <button type="button" onclick="addArenaTask()">ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²ã™ã‚‹</button>
            <div style="margin-top:30px;">
                <h2>ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
                <button type="button" onclick="forceReloadArena()"
                    style="margin-top:0; padding:8px 16px; font-size:12px; width:auto; background:#666; box-shadow:none; color:white; border:none; border-radius:20px;">ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿</button>
                <div class="table-container">
                    <table id="arenaTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>æœˆ</th>
                                <th>ã‚¿ã‚¹ã‚¯</th>
                                <th>æ‹…å½“è€…</th>
                                <th>å®Œäº†</th>
                                <th>å†™çœŸ</th>
                                <th class="delete-col">ç·¨é›†</th>
                                <th class="delete-col">å‰Šé™¤</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tournamentSection" class="card-section" style="display:none;">
            <h2>å¤§ä¼šç”³è¾¼</h2>
            <label>å¤§ä¼šå</label>
            <input type="text" id="tournamentName" placeholder="å¤§ä¼šåã‚’å…¥åŠ›">
            <label>å…¥åŠ›æœŸé™</label>
            <input type="date" id="deadline">
            <label>æ‹…å½“è€…</label>
            <input type="text" id="tournamentPerson" placeholder="åå‰ã‚’å…¥åŠ›">
            <label>çŠ¶æ³</label>
            <select id="status">
                <option value="ç”³è¾¼äºˆå®š">ç”³è¾¼äºˆå®š</option>
                <option value="ç”³è«‹ä¸­">ç”³è«‹ä¸­</option>
                <option value="ç”³è¾¼å®Œäº†">ç”³è¾¼å®Œäº†</option>
            </select>

            <label>å‡ºå ´åˆ¶é™</label>
            <select id="restriction">
                <option value="elem_all">å°å­¦ç”Ÿå…¨å“¡ï¼ˆã‚¯ãƒ©ãƒ–å“¡ï¼‰</option>
                <option value="elem_fed">å°å­¦ç”Ÿé€£ç›Ÿç™»éŒ²è€…</option>
                <option value="jhs_fed">ä¸­å­¦ç”Ÿé€£ç›Ÿç™»éŒ²è€…</option>
                <option value="all">åˆ¶é™ãªã—ï¼ˆå…¨å“¡ï¼‰</option>
            </select>

            <label>å‚åŠ è²» (1äººã‚ãŸã‚Š)</label>
            <input type="number" id="tournamentFee" placeholder="ä¾‹ï¼š1500">

            <button type="button" onclick="submitTournament()">æ–°è¦ç™»éŒ²</button>

            <div style="margin-top:30px;">
                <h2>ç”³è¾¼ä¸€è¦§</h2>
                <div class="table-container">
                    <table id="tournamentTable">
                        <thead>
                            <tr>
                                <th>å¤§ä¼šå</th>
                                <th>å…¥åŠ›æœŸé™</th>
                                <th>æ‹…å½“è€…</th>
                                <th>çŠ¶æ³</th>
                                <th class="delete-col">è©³ç´°/ç®¡ç†</th>
                                <th class="delete-col">å‰Šé™¤</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="otherSection" class="card-section" style="display:none;">
            <h2>ãã®ä»–é€£çµ¡äº‹é …</h2>
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="otherTitle">
            <label>å†…å®¹</label>
            <textarea id="otherContent" rows="3"></textarea>
            <label>æ‹…å½“è€…</label>
            <input type="text" id="otherPerson">
            <label>çŠ¶æ³</label>
            <input type="text" id="otherStatus" placeholder="ä¾‹ï¼šç¢ºèªä¸­ã€å®Œäº†ãªã©">
            <button type="button" onclick="saveOtherData()">ç™»éŒ²ã™ã‚‹</button>
            <div style="margin-top:30px;">
                <h2>ãã®ä»–ä¸€è¦§</h2>
                <div class="table-container">
                    <table id="otherList">
                        <thead>
                            <tr>
                                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th>å†…å®¹</th>
                                <th>æ‹…å½“è€…</th>
                                <th>çŠ¶æ³</th>
                                <th class="delete-col">ç·¨é›†</th>
                                <th class="delete-col">å‰Šé™¤</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="feeSection" class="card-section" style="display:none;">
            <h2>ğŸ’´ æœˆè¬ç®¡ç† (4,000å††/æœˆ)</h2>
            <div
                style="background:#fff; padding:15px; border-radius:12px; border:1px solid #FF9966; margin-bottom:20px; text-align:center;">
                <label>å¯¾è±¡æœˆã‚’é¸æŠ</label>
                <input type="month" id="feeMonthSelect"
                    style="font-size:1.2em; font-weight:bold; text-align:center; color:#333;" onchange="loadFeeData()">
            </div>

            <div style="margin-bottom:10px; font-size:0.9em; color:#666; text-align:right;">
                <span id="feeCountLabel">æ”¯æ‰•ã„æ¸ˆã¿: 0å</span>
            </div>

            <div class="table-container">
                <table id="feeTable">
                    <thead>
                        <tr>
                            <th style="width:65%;">æ°å</th>
                            <th style="width:35%;">çŠ¶æ³</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="gutSection" class="card-section" style="display:none;">
            <h2>ğŸ¸ ã‚¬ãƒƒãƒˆå¼µã‚Šç®¡ç†</h2>

            <div
                style="background:#f9f9f9; padding:20px; border-radius:12px; border:1px solid #ddd; margin-bottom:30px;">
                <h3 style="margin-top:0;">æ–°è¦ç™»éŒ²</h3>
                <label>æ°å</label>
                <select id="gutNameSelect">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>

                <label>å—ä»˜æ—¥</label>
                <input type="date" id="gutDate">

                <label>ã‚³ãƒ¼ã‚¹é¸æŠ</label>
                <div class="checkbox-container" style="margin-bottom:10px;">
                    <label class="checkbox-label">
                        <input type="radio" name="gutOption" value="included" checked onchange="toggleGutInfo()">
                        ã‚¬ãƒƒãƒˆè¾¼ã¿ (Â¥1,800)
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="gutOption" value="carry_in" onchange="toggleGutInfo()">
                        æŒã¡è¾¼ã¿ (Â¥1,000)
                    </label>
                </div>

                <div id="gutInfoBox" style="margin-bottom:15px; display:block;">
                    <div
                        style="background:#fff; border:1px solid #ffe0b2; border-left:5px solid #FF9966; border-radius:6px; padding:12px 15px; font-size:0.9em; display:flex; align-items:center; gap:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);">
                        <span style="font-weight:bold; color:#FF9966; white-space:nowrap;">â„¹ï¸ æ¨™æº–ä»•æ§˜</span>
                        <span style="color:#ddd;">|</span>
                        <span style="color:#333;">
                            <span style="font-weight:bold;">BG66 ã‚¢ãƒ«ãƒ†ã‚£ãƒãƒƒã‚¯ã‚¹</span>
                            <span style="font-size:0.85em; color:#666; margin-left:2px;">(ãƒ¡ã‚¿ãƒªãƒƒã‚¯ãƒ›ãƒ¯ã‚¤ãƒˆ)</span>
                        </span>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>æœ¬æ•°</label>
                        <input type="number" id="gutCount" value="1" min="1">
                    </div>
                    <div style="flex:1;">
                        <label>ãƒ†ãƒ³ã‚·ãƒ§ãƒ³</label>
                        <input type="number" id="gutTension" placeholder="24" step="0.5">
                    </div>
                </div>

                <button onclick="submitGut()">ç™»éŒ²ã™ã‚‹</button>
            </div>

            <h3>ğŸ“œ å±¥æ­´ãƒ»æ”¯æ‰•ã„çŠ¶æ³</h3>
            <button onclick="loadGutList()"
                style="width:auto; padding:6px 12px; font-size:0.8em; margin-bottom:10px; background:#666; box-shadow:none;">æ›´æ–°</button>

            <div class="table-container">
                <table id="gutTable">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>æ°å</th>
                            <th>å†…å®¹</th>
                            <th>é‡‘é¡/çŠ¶æ³</th>
                            <th class="delete-col">å‰Šé™¤</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="memberSection" class="card-section" style="display:none;">
            <h2>ã‚¯ãƒ©ãƒ–åç°¿</h2>
            <div class="table-container">
                <table id="memberTable">
                    <thead>
                        <tr>
                            <th>ç•ªå·</th>
                            <th>æ°å</th>
                            <th>å­¦å¹´</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="individualModal">
        <div class="ind-header">
            <h3 id="indModalTitle" style="margin:0;">æ°å</h3>
            <button
                style="width:auto; margin:0; padding:8px 16px; background:#f0f0f0; color:#333; border:1px solid #ddd; box-shadow:none;"
                onclick="closeIndModal()">é–‰ã˜ã‚‹</button>
        </div>
        <div class="ind-content" id="indList">
        </div>
        <div
            style="padding:15px; background:rgba(255,255,255,0.95); text-align:center; position:sticky; bottom:0; border-top:1px solid #eee;">
            <button type="button" onclick="saveIndData()"
                style="width:100%; max-width:400px; margin-top:0;">ã“ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>

    <div id="photoModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:3000;">
        <img id="modalImage" src=""
            style="max-width:95%; max-height:80%; border-radius:8px; box-shadow:0 0 20px rgba(255,255,255,0.2);">
        <div style="position:absolute; bottom:30px; color:white; font-size:14px;">ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</div>
    </div>

    <div id="settingModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:4000; justify-content:center; align-items:center;">
        <div
            style="background:white; width:90%; max-width:400px; max-height:80%; border-radius:12px; display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #eee; font-weight:bold;">è¡¨ç¤ºãƒ¡ãƒ³ãƒãƒ¼é¸æŠ
            </div>
            <div id="settingMemberContainer" style="padding:15px; overflow-y:auto; flex:1;">
            </div>
            <div style="padding:15px; border-top:1px solid #eee; text-align:center; background:white;">
                <button onclick="saveMySettings()" style="width:100%; margin:0;">æ±ºå®šã—ã¦ä¿å­˜</button>
                <button onclick="document.getElementById('settingModal').style.display='none'"
                    style="width:100%; margin-top:10px; background:#ccc; color:#333; box-shadow:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="tournamentEditModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:4000; justify-content:center; align-items:center;">
        <div
            style="background:white; width:90%; max-width:400px; max-height:90%; border-radius:12px; display:flex; flex-direction:column; overflow-y:auto;">
            <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #eee; font-weight:bold;">å¤§ä¼šæƒ…å ±ã®ç·¨é›†</div>
            <div style="padding:20px;">
                <input type="hidden" id="edit_t_row">
                <label>å¤§ä¼šå</label>
                <input type="text" id="edit_t_name">

                <label>å…¥åŠ›æœŸé™</label>
                <input type="date" id="edit_t_deadline">

                <label>æ‹…å½“è€…</label>
                <input type="text" id="edit_t_person">

                <label>çŠ¶æ³</label>
                <select id="edit_t_status">
                    <option value="ç”³è¾¼äºˆå®š">ç”³è¾¼äºˆå®š</option>
                    <option value="ç”³è«‹ä¸­">ç”³è«‹ä¸­</option>
                    <option value="ç”³è¾¼å®Œäº†">ç”³è¾¼å®Œäº†</option>
                </select>

                <label>å‡ºå ´åˆ¶é™</label>
                <select id="edit_t_restriction">
                    <option value="elem_all">å°å­¦ç”Ÿå…¨å“¡ï¼ˆã‚¯ãƒ©ãƒ–å“¡ï¼‰</option>
                    <option value="elem_fed">å°å­¦ç”Ÿé€£ç›Ÿç™»éŒ²è€…</option>
                    <option value="jhs_fed">ä¸­å­¦ç”Ÿé€£ç›Ÿç™»éŒ²è€…</option>
                    <option value="all">åˆ¶é™ãªã—ï¼ˆå…¨å“¡ï¼‰</option>
                </select>

                <label>å‚åŠ è²»</label>
                <input type="number" id="edit_t_fee">

                <button onclick="submitEditTournament()" style="margin-top:20px;">æ›´æ–°ã—ã¦ä¿å­˜</button>
                <button onclick="document.getElementById('tournamentEditModal').style.display='none'"
                    style="background:#ccc; color:#333; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="tournamentDetailModal">
        <div class="ind-header">
            <h3 style="margin:0; font-size:1em; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;"
                id="tDetailTitle">å¤§ä¼šè©³ç´°</h3>
            <button
                style="width:auto; margin:0; padding:8px 16px; background:#f0f0f0; color:#333; border:1px solid #ddd; box-shadow:none;"
                onclick="closeTournamentDetail()">é–‰ã˜ã‚‹</button>
        </div>
        <div class="ind-content">

            <h3>ğŸ“ å¤§ä¼šè¦é …ãƒ»è³‡æ–™</h3>
            <div class="tournament-file-area">
                <div id="tFileLinkArea" style="margin-bottom:10px;"></div>
                <input type="file" id="tFileUpload" style="font-size:0.8em;">
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <h3 style="margin:0;">ğŸ‘¥ å‚åŠ å¸Œæœ›è€… <span id="tParticipantCount"
                        style="font-size:0.8em; font-weight:normal; color:#666; margin-left:5px;"></span></h3>
                <button onclick="toggleAddParticipantBox()"
                    style="width:auto; padding:6px 12px; font-size:0.8em; margin:0;">ï¼‹ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
            </div>

            <div id="addParticipantBox" class="add-participant-box" style="display:none;">
                <p style="font-size:0.8em; margin-top:0;">è¿½åŠ ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <select id="tMemberSelect" style="margin-bottom:10px;"></select>
                <button onclick="addParticipantToTournament()" style="margin-top:0; padding:10px;">è¿½åŠ </button>
            </div>

            <div id="tParticipantList" style="margin-top:10px;"></div>

        </div>
        <div
            style="padding:15px; background:rgba(255,255,255,0.95); text-align:center; position:sticky; bottom:0; border-top:1px solid #eee;">
            <button type="button" onclick="saveTournamentDetails()"
                style="width:100%; max-width:400px; margin-top:0;">å†…å®¹ã‚’ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>

    <div id="taskEditModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:5000; justify-content:center; align-items:center;">
        <div
            style="background:white; width:90%; max-width:400px; border-radius:12px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">èª²é¡Œã®ç·¨é›†</h3>

            <input type="hidden" id="editTaskRow">
            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">ç¨®ç›®</label>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input type="radio" name="editTaskType" value="ã‚·ãƒ³ã‚°ãƒ«ã‚¹"> ã‚·ãƒ³ã‚°ãƒ«ã‚¹
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="editTaskType" value="ãƒ€ãƒ–ãƒ«ã‚¹"> ãƒ€ãƒ–ãƒ«ã‚¹
                    </label>
                </div>
            </div>

            <label style="font-weight:bold; display:block; margin-bottom:5px;">èª²é¡Œå†…å®¹</label>
            <textarea id="editTaskContent" rows="4" style="width:100%; margin-bottom:20px;"></textarea>

            <div style="display:flex; gap:10px;">
                <button onclick="saveTaskEdit()" style="flex:1; background:#FF9966; color:white;">ä¿å­˜</button>
                <button onclick="document.getElementById('taskEditModal').style.display='none'"
                    style="flex:1; background:#ccc; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    <div id="reflectionModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:5000; justify-content:center; align-items:center;">
        <div
            style="background:white; width:90%; max-width:400px; border-radius:12px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">ä»Šæœˆã®è€ƒå¯Ÿãƒ»æŒ¯ã‚Šè¿”ã‚Š</h3>
            <p style="font-size:0.85em; color:#666;">èª²é¡Œã«å¯¾ã™ã‚‹çµæœã‚„æ°—ã¥ãã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

            <input type="hidden" id="reflectTaskRow">

            <div style="background:#f0f0f0; padding:10px; border-radius:8px; margin-bottom:15px;">
                <label style="font-size:0.8em; color:#888; margin:0;">å–ã‚Šçµ„ã‚“ã èª²é¡Œ</label>
                <div id="reflectTaskPreview" style="font-weight:bold; font-size:0.9em; color:#333;"></div>
            </div>

            <label style="font-weight:bold; display:block; margin-bottom:5px;">è€ƒå¯Ÿãƒ»æŒ¯ã‚Šè¿”ã‚Š</label>
            <textarea id="reflectContent" rows="5" style="width:100%; margin-bottom:20px;"
                placeholder="ä¾‹ï¼šè¶³ã¯å‹•ãã‚ˆã†ã«ãªã£ãŸãŒã€æœ€å¾Œã®æ±ºã‚çƒãŒæµ®ã„ã¦ã—ã¾ã†ã“ã¨ãŒå¤šã‹ã£ãŸã€‚æ¥æœˆã¯..."></textarea>

            <div style="display:flex; gap:10px;">
                <button onclick="saveReflection()" style="flex:1; background:#28a745; color:white;">ä¿å­˜</button>
                <button onclick="document.getElementById('reflectionModal').style.display='none'"
                    style="flex:1; background:#ccc; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>

        // â–¼â–¼â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰ â–¼â–¼â–¼
        const APP_PASSWORD = "1234";  // ã‚¢ãƒ—ãƒªã‚’é–‹ãã¨ãã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        const TASK_PASSWORD = "5678"; // èª²é¡Œç®¡ç†ã‚’é–‹ãã¨ãã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // ã‚¢ãƒ—ãƒªãƒ­ã‚°ã‚¤ãƒ³èªè¨¼å‡¦ç†
        function checkAppLogin() {
            // ä¿å­˜ã•ã‚ŒãŸãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã‹ç¢ºèª
            if (localStorage.getItem("isAppLoggedIn") === "true") {
                document.getElementById("appLoginModal").classList.remove("active");
            } else {
                document.getElementById("appLoginModal").classList.add("active");
            }
        }

        function verifyAppLogin() {
            const input = document.getElementById("appPassInput").value;
            if (input === APP_PASSWORD) {
                localStorage.setItem("isAppLoggedIn", "true"); // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
                document.getElementById("appLoginModal").classList.remove("active");
            } else {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                document.getElementById("appPassInput").value = "";
            }
        }

        // èª²é¡Œç®¡ç†èªè¨¼å‡¦ç†
        let pendingTaskBtn = null; // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã‚’è¨˜æ†¶ç”¨

        function checkTaskLogin(btnElement) {
            if (localStorage.getItem("isTaskLoggedIn") === "true") {
                return true; // èªè¨¼æ¸ˆã¿ãªã‚‰OK
            }
            // æœªèªè¨¼ãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            pendingTaskBtn = btnElement; // æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’è¨˜æ†¶
            document.getElementById("taskLoginModal").classList.add("active");
            return false; // ãƒ­ãƒƒã‚¯ä¸­
        }

        function verifyTaskLogin() {
            const input = document.getElementById("taskPassInput").value;
            if (input === TASK_PASSWORD) {
                localStorage.setItem("isTaskLoggedIn", "true"); // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
                document.getElementById("taskLoginModal").classList.remove("active");

                // èªè¨¼æˆåŠŸã—ãŸã‚‰ã€ä¸­æ–­ã—ã¦ã„ãŸã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚’å†å®Ÿè¡Œ
                if (pendingTaskBtn) {
                    switchCategory('task', pendingTaskBtn);
                } else {
                    // ãƒœã‚¿ãƒ³æƒ…å ±ãŒãªã‘ã‚Œã°å¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ãˆ
                    const taskBtn = document.querySelector('.nav-item[onclick*="task"]');
                    switchCategory('task', taskBtn);
                }
            } else {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                document.getElementById("taskPassInput").value = "";
            }
        }

        function closeTaskLogin() {
            document.getElementById("taskLoginModal").classList.remove("active");
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯å…ƒã®ã‚¿ãƒ–ï¼ˆå‡ºæ¬ ãªã©ï¼‰ã«æˆ»ã£ãŸã¾ã¾ã«ã™ã‚‹ãŸã‚ä½•ã‚‚ã—ãªã„
        }

        // â–¼â–¼â–¼ GASã®URLï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå…ˆé ­ã«ç§»å‹•ï¼‰ â–¼â–¼â–¼
        const SHEET_URL = "https://script.google.com/macros/s/AKfycbyx--02g7KN0Z32nCdfCWN5CFE3NKQVjWWlBYDxgxDWqykxKHK5Q-BKhLCsfetgYlM/exec";

        // â–¼â–¼â–¼ Firebaseã®è¨­å®š â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyD-lU05Tehd0G9FVNvB74Qy8aKp4viC8Y8",
            authDomain: "badminton-club-app-cadc8.firebaseapp.com",
            projectId: "badminton-club-app-cadc8",
            storageBucket: "badminton-club-app-cadc8.firebasestorage.app",
            messagingSenderId: "680556351504",
            appId: "1:680556351504:web:93a9d9b8915e5530beba95"
        };

        // FirebaseåˆæœŸåŒ–
        let storage;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            storage = firebase.storage();
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼å®šæ•°
        const CACHE_KEY_SCHEDULE = 'badminton_schedule_v1';
        const CACHE_KEY_CARRY = 'badminton_carry_v1';
        const CACHE_KEY_ARENA = 'badminton_arena_v1';
        const CACHE_KEY_TOURNAMENT = 'badminton_tournament_v1';
        const CACHE_KEY_OTHER = 'badminton_other_v1';
        const CACHE_KEY_SHUTTLE = 'badminton_shuttle_v1';
        const CACHE_KEY_FEE = 'badminton_fee_v1';
        const CACHE_KEY_GUT = 'badminton_gut_v1';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let sheetData = [], arenaData = [], memberData = [], weeklyEvents = [], weeklyMembers = [], weeklyStatus = {};
        let weeklyMemo = {};
        let currentIndMember = null;
        let isShowingAll = false;
        let shuttleUpdateCount = 0;
        // â˜…ã“ã“ã«è¿½åŠ ãƒ»ç§»å‹•â˜…
        let shuttleLogsCache = [];
        let currentCalDate = new Date();
        let feeDataCache = null;  // æœˆè¬ãƒ‡ãƒ¼ã‚¿ç”¨
        let gutDataCache = null;  // ã‚¬ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ç”¨
        let allTasksCache = [];
        let currentAnalysisMode = 'elem_s';

        // â˜…å¤§ä¼šç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentTournamentRow = null; // ç·¨é›†ä¸­ã®å¤§ä¼šã®è¡Œç•ªå·
        let currentTournamentParticipants = []; // ç¾åœ¨ã®å‚åŠ è€…ãƒªã‚¹ãƒˆ [{name:xxx, paid:true/false}]
        let currentTournamentFileUrl = ""; // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«URL

        // åŸºæœ¬é–¢æ•°
        async function callGas(action, params = {}) {
            if (!SHEET_URL.startsWith("http")) { alert("SHEET_URLã‚¨ãƒ©ãƒ¼"); return; }
            const payload = { action: action, ...params };
            try {
                const response = await fetch(SHEET_URL, { method: "POST", body: JSON.stringify(payload) });
                return await response.json();
            } catch (error) { console.error("GAS Error:", error); return null; }
        }
        function safeSetStorage(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.warn("Quota Exceeded", e); } }
        function showLoading(show) { document.getElementById("loading").style.display = show ? "flex" : "none"; }

        // åˆæœŸåŒ–ï¼ˆé«˜é€ŸåŒ–å¯¾å¿œç‰ˆï¼‰
        document.addEventListener("DOMContentLoaded", async () => {
            checkAppLogin();

            // 1. ã¾ãšUIã®åˆæœŸè¡¨ç¤ºï¼ˆå‡ºæ¬ ã‚¿ãƒ–ï¼‰
            switchCategory('attendance', document.querySelector('.nav-item.active'));

            // 2. æœ€åˆã®ç”»é¢ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ï¼ˆåç°¿ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»å‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ï¼‰ã ã‘ã‚’å¾…æ©Ÿã—ã¦èª­ã¿è¾¼ã‚€
            await Promise.all([loadMemberList(), loadSchedule(), loadWeeklyMatrix()]);

            // 3. ãã®ä»–ã®ã‚¿ãƒ–ï¼ˆèª²é¡Œãƒ»æœˆè¬ãƒ»ã‚¬ãƒƒãƒˆãƒ»ã‚¢ãƒªãƒ¼ãƒŠãƒ»ã‚·ãƒ£ãƒˆãƒ«ï¼‰ã¯ã€Œè£å´ã€ã§èª­ã¿è¾¼ã‚€
            fetchArenaData();
            loadShuttleData();

            // æ–°æ©Ÿèƒ½ã®è£èª­ã¿è¾¼ã¿ï¼ˆå¼•æ•° true = ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’å‡ºã•ãšã«ãƒ‡ãƒ¼ã‚¿ã ã‘å–ã‚‹ï¼‰
            // â€»é–¢æ•°å´ã§ true ã«å¯¾å¿œã—ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€å‰ã®æ‰‹é †ã§é–¢æ•°ã‚’æ›´æ–°ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            if (typeof loadTasks === 'function') loadTasks(true);
            if (typeof loadGutList === 'function') loadGutList(true);

            // æœˆè¬ã®åˆæœŸå€¤ã‚»ãƒƒãƒˆï¼†è£èª­ã¿è¾¼ã¿
            const thisMonth = formatMonth(new Date());
            const feeSelect = document.getElementById("feeMonthSelect");
            if (feeSelect) feeSelect.value = thisMonth;

            if (typeof loadFeeData === 'function') loadFeeData(true);
        });

        // ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ
        function switchCategory(category, btnElement) {

            // â–¼â–¼â–¼ èª²é¡Œç®¡ç†ã®ãƒ­ãƒƒã‚¯ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼
            if (category === 'task') {
                // èªè¨¼ãƒã‚§ãƒƒã‚¯é–¢æ•°ã‚’å‘¼ã³å‡ºã™ï¼ˆfalseãªã‚‰ã“ã“ã§ä¸­æ–­ï¼‰
                if (!checkTaskLogin(btnElement)) return;
            }

            const sections = ["attendanceSection", "shuttleSection", "carrySection", "tournamentSection", "otherSection", "skyArenaSection", "memberSection", "taskSection", "feeSection", "gutSection"];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = "none";
            });

            const target = document.getElementById(category + "Section");
            if (target) target.style.display = "block";

            if (category === "carry") loadList();
            if (category === "tournament") loadTournamentList();
            if (category === "other") loadOtherList();
            if (category === "shuttle") loadShuttleData();

            if (category === "task") {
                if (typeof updateTaskMemberSelect === 'function') updateTaskMemberSelect();
                if (allTasksCache.length === 0 && typeof loadTasks === 'function') loadTasks();
            }

            // â˜…è¿½åŠ : æœˆè¬ã¨ã‚¬ãƒƒãƒˆå¼µã‚Š
            if (category === "fee") {
                // ä»Šæœˆã‚’ã‚»ãƒƒãƒˆ
                if (!document.getElementById("feeMonthSelect").value) {
                    document.getElementById("feeMonthSelect").value = formatMonth(new Date());
                }
                if (typeof loadFeeData === 'function') loadFeeData();
            }
            if (category === "gut") {
                if (typeof updateGutMemberSelect === 'function') updateGutMemberSelect(); // åç°¿ã‚»ãƒƒãƒˆ
                if (typeof loadGutList === 'function') loadGutList();
            }

            const navItems = document.querySelectorAll(".nav-item");
            navItems.forEach(item => item.classList.remove("active"));
            if (btnElement) btnElement.classList.add("active");
        }

        // --- å„ç¨®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•° ---

        // åç°¿
        async function loadMemberList() { const data = await callGas('getMemberList'); if (data) { memberData = data; renderMemberTable(); } }
        function renderMemberTable() { const tbody = document.querySelector("#memberTable tbody"); tbody.innerHTML = ""; if (!memberData || memberData.length === 0) { tbody.innerHTML = "<tr><td colspan='3'>èª­ã¿è¾¼ã¿ä¸­...</td></tr>"; return; } memberData.forEach(m => { const tr = document.createElement("tr"); tr.innerHTML = `<td>${m.no}</td><td>${escapeHtml(m.name)}</td><td>${escapeHtml(m.grade)}</td>`; tbody.appendChild(tr); }); }

        // å‡ºæ¬ ãƒãƒˆãƒªã‚¯ã‚¹
        async function loadWeeklyMatrix() {
            const data = await callGas('getWeeklyMatrix');
            if (!data || !data.events) {
                const errDiv = document.getElementById("matrixError");
                if (errDiv) errDiv.style.display = "block";
                return;
            }
            const errDiv = document.getElementById("matrixError");
            if (errDiv) errDiv.style.display = "none";

            weeklyEvents = data.events || [];
            weeklyMembers = data.members || [];
            weeklyStatus = data.currentStatus || {};
            weeklyMemo = data.currentMemo || {};

            renderMemberButtons();
            renderSummary();
        }

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
        function openSettingModal() {
            if (weeklyMembers.length === 0) return alert("ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            const container = document.getElementById("settingMemberContainer");
            container.innerHTML = "";

            let savedList = [];
            try { savedList = JSON.parse(localStorage.getItem("my_members_list") || "[]"); } catch (e) { }

            weeklyMembers.forEach(m => {
                const div = document.createElement("div");
                div.style.padding = "8px 0";
                div.style.borderBottom = "1px solid #f0f0f0";
                const isChecked = savedList.includes(m.name) ? "checked" : "";
                div.innerHTML = `
          <label style="display:flex; align-items:center; cursor:pointer; margin:0; font-weight:normal;">
            <input type="checkbox" value="${m.name}" ${isChecked} style="width:auto; margin-right:10px; transform:scale(1.5); appearance: auto; -webkit-appearance: auto; accent-color: #FF9966;">
            <span style="flex:1;">${m.name} <span style="font-size:0.8em; color:#999;">(${m.grade})</span></span>
          </label>`;
                container.appendChild(div);
            });
            document.getElementById("settingModal").style.display = "flex";
        }

        function saveMySettings() {
            const container = document.getElementById("settingMemberContainer");
            const checkboxes = container.querySelectorAll("input[type='checkbox']:checked");
            const selectedNames = Array.from(checkboxes).map(cb => cb.value);
            localStorage.setItem("my_members_list", JSON.stringify(selectedNames));
            document.getElementById("settingModal").style.display = "none";
            renderMemberButtons();
        }

        function toggleShowAll() {
            isShowingAll = !isShowingAll;
            renderMemberButtons();
        }

        function renderMemberButtons() {
            const container = document.getElementById("memberListContainer");
            const label = document.getElementById("selectedMembersLabel");
            const toggleBtn = document.getElementById("toggleDisplayBtn");

            container.innerHTML = "";

            if (weeklyMembers.length === 0) { container.innerHTML = "<p>ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>"; return; }

            let savedList = [];
            try { savedList = JSON.parse(localStorage.getItem("my_members_list") || "[]"); } catch (e) { }

            if (savedList.length > 0) {
                label.textContent = `é¸æŠä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼: ${savedList.join(", ")}`;
            } else {
                label.textContent = "â€»ã€Œè¡¨ç¤ºè¨­å®šã€ã‹ã‚‰ã‚ˆãä½¿ã†ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„";
            }

            let displayList = [];
            const favorites = [];
            const others = [];

            weeklyMembers.forEach(m => {
                if (savedList.includes(m.name)) favorites.push(m);
                else others.push(m);
            });

            if (isShowingAll) {
                displayList = [...favorites, ...others];
                if (toggleBtn) {
                    toggleBtn.textContent = "ğŸ”½ é¸æŠã®ã¿è¡¨ç¤º";
                    toggleBtn.style.backgroundColor = "#666";
                }
            } else {
                displayList = favorites;
                if (toggleBtn) {
                    toggleBtn.textContent = "ğŸ‘¥ å…¨å“¡ã‚’è¡¨ç¤º";
                    toggleBtn.style.backgroundColor = "#FF9966";
                }
                if (displayList.length === 0) {
                    container.innerHTML = "<p style='color:#999; text-align:center; padding:20px;'>è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚<br>ã€Œå…¨å“¡ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€è¨­å®šã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>";
                    return;
                }
            }

            displayList.forEach(m => {
                const originalIndex = weeklyMembers.findIndex(wm => wm.name === m.name);
                const card = document.createElement("div");
                card.className = "member-card";

                if (savedList.includes(m.name)) {
                    card.style.border = "2px solid #FF9966";
                    card.style.backgroundColor = "#fff5f0";
                }

                card.onclick = () => openIndModal(originalIndex);
                card.innerHTML = `<span class="member-name">${m.name}</span><span class="member-grade">${m.grade}</span>`;
                container.appendChild(card);
            });
        }

        // å€‹äººãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
        function openIndModal(memberIndex) {
            currentIndMember = weeklyMembers[memberIndex];
            document.getElementById("indModalTitle").innerText = `${currentIndMember.name} ã•ã‚“ã®å‡ºæ¬ `;
            const container = document.getElementById("indList");
            container.innerHTML = "";

            weeklyEvents.forEach((evt, idx) => {
                let isTarget = false;

                if (evt.group === 'club' && currentIndMember.isClub && !currentIndMember.isSkill) isTarget = true;

                if (evt.group === 'federation' && currentIndMember.isFed) isTarget = true;
                if (evt.group === 'skillup' && currentIndMember.isSkill) isTarget = true;

                if (isTarget) {
                    const key = `${evt.dateKey}_${evt.fullTitle}_${currentIndMember.name}`;
                    const status = weeklyStatus[key] || "æœªå®š";
                    const memo = weeklyMemo[key] || "";
                    const dayStr = getDayOfWeekStr(evt.dateKey);

                    let labelColor = "black";
                    let groupLabel = "";
                    if (evt.group === 'club') { labelColor = "#FF9966"; groupLabel = "ã€ã‚¯ãƒ©ãƒ–ã€‘"; }
                    if (evt.group === 'federation') { labelColor = "#17a2b8"; groupLabel = "ã€ä¸­å­¦ç”Ÿç·´ç¿’ã€‘"; }
                    if (evt.group === 'skillup') { labelColor = "#6610f2"; groupLabel = "ã€ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã€‘"; }

                    const div = document.createElement("div");
                    div.className = "ind-row";
                    div.style.flexWrap = "wrap";

                    div.innerHTML = `
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <div class="ind-info">
                  <div style="font-size:0.8em; color:${labelColor}; font-weight:bold;">
                    ${groupLabel} ${evt.start}${evt.end ? 'ï½' + evt.end : ''}${dayStr}
                  </div>
                  <div style="font-size:0.95em;">${evt.title}</div>
                </div>
                <div class="ind-btns" id="ind-btn-group-${idx}" data-status="${status}" data-original-status="${status}">
                  <button class="ind-btn present ${status === 'å‡ºå¸­' ? 'active' : ''}" onclick="setIndStatus(${idx}, 'å‡ºå¸­')">å‡º</button>
                  <button class="ind-btn absent ${status === 'æ¬ å¸­' ? 'active' : ''}" onclick="setIndStatus(${idx}, 'æ¬ å¸­')">æ¬ </button>
                  <button class="ind-btn unknown ${status === 'æœªå®š' ? 'active' : ''}" onclick="setIndStatus(${idx}, 'æœªå®š')">?</button>
                </div>
            </div>
            <div style="width:100%; margin-top:8px;">
                <input type="text" class="ind-memo-input" 
                       value="${escapeHtml(memo)}" 
                       placeholder="ãƒ¡ãƒ¢ï¼ˆé…åˆ»ã€æ—©é€€ãªã©ï¼‰" 
                       data-original-memo="${escapeHtml(memo)}"
                       style="width:100%; padding:8px; font-size:14px; border:1px solid #ddd; border-radius:6px; background:#fcfcfc;">
            </div>`;

                    div.dataset.eventIndex = idx;
                    container.appendChild(div);
                }
            });
            document.getElementById("individualModal").style.display = "block";
        }

        function setIndStatus(idx, status) { const group = document.getElementById(`ind-btn-group-${idx}`); const btns = group.querySelectorAll('.ind-btn'); btns.forEach(b => b.classList.remove('active')); if (status === 'å‡ºå¸­') group.querySelector('.present').classList.add('active'); if (status === 'æ¬ å¸­') group.querySelector('.absent').classList.add('active'); if (status === 'æœªå®š') group.querySelector('.unknown').classList.add('active'); group.dataset.status = status; }
        function closeIndModal() { document.getElementById("individualModal").style.display = "none"; }

        async function saveIndData() {
            const container = document.getElementById("indList");
            const rows = container.querySelectorAll(".ind-row");
            let updates = [];

            rows.forEach(row => {
                const idx = row.dataset.eventIndex;
                const evt = weeklyEvents[idx];
                const btnGroup = row.querySelector(".ind-btns");

                const currentStatus = btnGroup.dataset.status || "æœªå®š";
                const originalStatus = btnGroup.dataset.originalStatus || "æœªå®š";
                const memoInput = row.querySelector(".ind-memo-input");
                const currentMemo = memoInput.value;
                const originalMemo = memoInput.dataset.originalMemo;

                if (currentStatus !== originalStatus || currentMemo !== originalMemo) {
                    updates.push({
                        date: evt.dateKey,
                        title: evt.fullTitle,
                        name: currentIndMember.name,
                        status: currentStatus,
                        memo: currentMemo
                    });
                }
            });

            if (updates.length === 0) { alert("å¤‰æ›´ç®‡æ‰€ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

            showLoading(true);
            const res = await callGas('saveBulkAttendance', { updates: updates });
            showLoading(false);

            if (res) { alert(res); closeIndModal(); loadWeeklyMatrix(); }
        }

        // å‚åŠ è€…é›†è¨ˆ
        function renderSummary() {
            const containerClub = document.getElementById("attendanceSummary");
            const containerFed = document.getElementById("attendanceSummaryFed");
            containerClub.innerHTML = "";
            containerFed.innerHTML = "";

            if (!weeklyEvents || weeklyEvents.length === 0) return;

            let myMembers = [];
            try {
                myMembers = JSON.parse(localStorage.getItem("my_members_list") || "[]");
            } catch (e) { }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let memoToggleCounter = 0;

            weeklyEvents.forEach(evt => {
                const eventDate = new Date(evt.dateKey);
                if (eventDate < today) return;

                const attendees = [];
                const memoList = [];

                weeklyMembers.forEach(m => {
                    if (evt.group === 'club' && m.isSkill) return;

                    const key = `${evt.dateKey}_${evt.fullTitle}_${m.name}`;

                    if (weeklyStatus[key] === "å‡ºå¸­") {
                        attendees.push(m.name);
                        const memo = weeklyMemo[key];
                        if (memo) memoList.push({ name: m.name, text: memo });
                    }
                });

                if (attendees.length > 0) {
                    const dayStr = getDayOfWeekStr(evt.dateKey);

                    const formattedNames = attendees.map(name => {
                        if (myMembers.includes(name)) {
                            return `<span style="color:#FF9966; font-weight:bold;">${name}</span>`;
                        }
                        return name;
                    }).join("ã€ ");

                    const div = document.createElement("div");
                    let cls = "";
                    let label = "";
                    let isFed = false;

                    if (evt.group === 'club') { cls = "club"; label = "ã€ã‚¯ãƒ©ãƒ–ã€‘"; }
                    if (evt.group === 'federation') { cls = "fed"; label = "ã€ä¸­å­¦ç”Ÿç·´ç¿’ã€‘"; isFed = true; }
                    if (evt.group === 'skillup') { cls = "skill"; label = "ã€ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã€‘"; }

                    div.className = `summary-box ${cls}`;

                    let htmlContent = `
                    <div class="summary-header">
                    <span>${label} ${evt.start}${evt.end ? 'ï½' + evt.end : ''}${dayStr} ${evt.title}</span>
                    <span class="summary-count">${attendees.length}å</span>
                    </div>
                    <div class="summary-names">${formattedNames}</div>
                `;

                    if (memoList.length > 0) {
                        memoToggleCounter++;
                        const contentId = `memo-content-${memoToggleCounter}`;
                        const iconId = `memo-icon-${memoToggleCounter}`;

                        htmlContent += `
                    <div class="summary-memo-container">
                        <div class="memo-toggle-header" onclick="toggleMemoContent('${contentId}', '${iconId}')">
                        <span>ğŸ“ é€£çµ¡äº‹é …ã‚ã‚Š (${memoList.length}ä»¶)</span>
                        <span id="${iconId}" style="font-size:0.8em; transform:rotate(0deg); transition:transform 0.2s;">â–¼</span>
                        </div>
                        <div id="${contentId}" class="memo-list-content">`;

                        memoList.forEach(item => {
                            htmlContent += `<div class="memo-item"><span class="memo-person-name">${item.name}:</span><span class="memo-text">${escapeHtml(item.text)}</span></div>`;
                        });
                        htmlContent += `</div></div>`;
                    }

                    div.innerHTML = htmlContent;
                    if (isFed) containerFed.appendChild(div);
                    else containerClub.appendChild(div);
                }
            });

            if (containerClub.innerHTML === "") containerClub.innerHTML = "<p style='color:#999; text-align:center;'>äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            if (containerFed.innerHTML === "") containerFed.innerHTML = "<p style='color:#999; text-align:center;'>äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        }

        // é“å…·é‹æ¬
        async function loadSchedule() { const cache = localStorage.getItem(CACHE_KEY_SCHEDULE); if (cache) renderScheduleOptions(JSON.parse(cache)); const data = await callGas('getScheduleList'); if (data) { safeSetStorage(CACHE_KEY_SCHEDULE, JSON.stringify(data)); renderScheduleOptions(data); } }
        function renderScheduleOptions(data) { const dateSelect = document.getElementById("dateSelect"); const currentVal = dateSelect.value; dateSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; data.forEach(r => { const option = document.createElement("option"); const dateStr = formatDate(r.date); option.value = dateStr; option.textContent = `${dateStr}ï¼ˆ${r.gym}ï¼‰`; option.dataset.gym = r.gym; dateSelect.appendChild(option); }); if (currentVal) dateSelect.value = currentVal; updateGym(); }
        function updateGym() { const dateSelect = document.getElementById("dateSelect"); const gymInput = document.getElementById("gym"); const selectedOption = dateSelect.options[dateSelect.selectedIndex]; gymInput.value = selectedOption ? (selectedOption.dataset.gym || "") : ""; }

        async function loadList() {
            const cache = localStorage.getItem(CACHE_KEY_CARRY);
            const notice = document.getElementById("cache-notice");

            if (cache) {
                sheetData = JSON.parse(cache);
                renderCarryTable(sheetData);
                notice.style.display = "inline-block";
                notice.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
            }

            const newData = await callGas('getCarryList');
            if (newData) {
                notice.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿";
                setTimeout(() => { notice.style.display = "none"; }, 2000);

                sheetData = newData;
                safeSetStorage(CACHE_KEY_CARRY, JSON.stringify(newData));
                renderCarryTable(sheetData);
            }
        }

        function renderCarryTable(data) {
            const carryData = [...data];
            carryData.sort((a, b) => {
                const dateA = new Date(a.date.replace(/\(.+\)/, ""));
                const dateB = new Date(b.date.replace(/\(.+\)/, ""));
                if (dateA - dateB !== 0) return dateA - dateB;
                return a.gym.localeCompare(b.gym, "ja");
            });

            const tableBody = document.querySelector("#listTable tbody");
            tableBody.innerHTML = "";

            const safeStr = (str) => {
                if (!str) return "";
                return String(str).replace(/'/g, "\\'").replace(/\r?\n/g, "\\n");
            };

            carryData.forEach(m => {
                const cleanDate = formatDate(m.date);
                // ã‚·ãƒ£ãƒˆãƒ«åˆ—ã¯å‰Šé™¤
                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${cleanDate}</td>
            <td>${m.gym}</td>
            <td>${m.person}</td>
            <td>${m.items ? m.items.replace(/\n/g, '<br>') : ''}</td>
            <td class="delete-col">
                <button type="button" 
                onclick="editCarryItem(${m.row}, '${cleanDate}', '${safeStr(m.gym)}', '${safeStr(m.person)}', '${safeStr(m.items)}')">
                ç·¨é›†
                </button>
            </td>
            <td class="delete-col">
                <button type="button" onclick="deleteCarryItem(${m.row})">
                å‰Šé™¤
                </button>
            </td>`;
                tableBody.appendChild(row);
            });
        }

        async function submitForm() {
            const date = document.getElementById("dateSelect").value;
            const gym = document.getElementById("gym").value;
            const person = document.getElementById("person").value;
            // const shuttle = document.getElementById("carryShuttle").value; // å‰Šé™¤
            const checkboxes = document.querySelectorAll('#carryItemsBox input[type="checkbox"]:checked');
            const itemsArr = Array.from(checkboxes).map(cb => cb.value);
            const items = itemsArr.join("ã€");

            if (!date || !person) return alert("ç·´ç¿’æ—¥ãƒ»æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

            showLoading(true);
            // shuttleãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦é€ä¿¡
            const res = await callGas('saveCarryItem', { date, gym, person, items });

            if (res) {
                alert(res);
                document.getElementById("person").value = "";
                document.querySelectorAll('#carryItemsBox input').forEach(cb => cb.checked = false);
                await loadList();
            }
            showLoading(false);
        }

        function editCarryItem(row, date, gym, person, items) {
            const tbody = document.querySelector("#listTable tbody");
            const tr = Array.from(tbody.children).find(tr => tr.innerHTML.includes(`editCarryItem(${row}`));
            if (!tr) return;

            tr.innerHTML = `
            <td>${date}</td>
            <td>${gym}</td>
            <td><input type="text" id="editPerson${row}" value="${person}" style="width:90%"></td>
            <td><textarea id="editCarryItems${row}" style="width:95%; height:40px;">${items ? items : ""}</textarea></td>
            <td colspan="2" class="delete-col">
                <button type="button" onclick="saveEditItem(${row}, '${date}', '${gym}')">ä¿å­˜</button>
                <button type="button" onclick="loadList()">ä¸­æ­¢</button>
            </td>`;
        }

        async function saveEditItem(row, date, gym) {
            const person = document.getElementById(`editPerson${row}`).value;
            const items = document.getElementById(`editCarryItems${row}`).value;

            if (!person) return alert("æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            showLoading(true);
            // shuttleå‰Šé™¤ã—ã¦æ›´æ–°
            const res = await callGas('updateCarryItem', { row, date, gym, person, items });
            if (res) { alert(res); await loadList(); }
            showLoading(false);
        }

        async function deleteCarryItem(row) { if (confirm("ã“ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { showLoading(true); const res = await callGas('deleteCarryItem', { row }); if (res) { alert(res); await loadList(); } showLoading(false); } }

        // --- å¤§ä¼šç”³è¾¼ï¼ˆå¤§å¹…æ”¹ä¿®ï¼‰---

        let tournamentListCache = []; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        async function loadTournamentList() {
            const cache = localStorage.getItem(CACHE_KEY_TOURNAMENT);
            if (cache) {
                tournamentListCache = JSON.parse(cache);
                renderTournamentTable(tournamentListCache);
            }
            const data = await callGas('getTournamentList');
            if (data) {
                tournamentListCache = data;
                safeSetStorage(CACHE_KEY_TOURNAMENT, JSON.stringify(data));
                renderTournamentTable(data);
            }
        }

        function renderTournamentTable(data) {
            const tbody = document.querySelector("#tournamentTable tbody");
            const thead = document.querySelector("#tournamentTable thead tr");

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®šç¾©
            if (thead) {
                thead.innerHTML = `
                <th>å¤§ä¼šå</th>
                <th>å…¥åŠ›æœŸé™</th>
                <th>æ‹…å½“è€…</th>
                <th>å‚åŠ è²»</th>
                <th style="min-width:150px;">å‚åŠ è€…</th> <th>çŠ¶æ³</th>
                <th class="delete-col">è©³ç´°/ç®¡ç†</th>
                <th class="delete-col">å‰Šé™¤</th>
            `;
            }

            tbody.innerHTML = "";

            // â˜…ä¿®æ­£1ï¼šå…¥åŠ›æœŸé™ãŒæ–°ã—ã„é †ï¼ˆé™é †ï¼‰ã«ä¸¦ã³æ›¿ãˆ
            const sortedData = [...data].sort((a, b) => {
                // b - a ã«ã™ã‚‹ã“ã¨ã§æ–°ã—ã„æ—¥ä»˜ï¼ˆæœªæ¥ï¼‰ãŒä¸Šã«æ¥ã¾ã™
                return new Date(b.deadline) - new Date(a.deadline);
            });

            sortedData.forEach(r => {
                const cleanDate = formatDate(r.deadline);
                const tr = document.createElement("tr");

                if (r.status === "ç”³è¾¼å®Œäº†") tr.classList.add("other-completed");

                // é‡‘é¡è¡¨ç¤º
                const feeDisplay = r.fee ? `Â¥${Number(r.fee).toLocaleString()}` : "-";

                // å‚åŠ è€…ãƒªã‚¹ãƒˆã®ç”Ÿæˆå‡¦ç†
                let participantsStr = "0å";
                try {
                    const pList = JSON.parse(r.participants || "[]");
                    if (pList.length > 0) {
                        const names = pList.map(p => p.name).join("ã€");
                        participantsStr = `<span style="font-weight:bold;">${pList.length}å</span><br>${names}`;

                        // å…¨å“¡æ”¯æ‰•æ¸ˆã®å ´åˆã®è¡¨ç¤º
                        const isAllPaid = pList.every(p => p.paid === true);
                        if (isAllPaid) {
                            participantsStr += `<div style="margin-top:4px;"><span style="background:#28a745; color:white; padding:2px 8px; border-radius:10px; font-size:0.8em; font-weight:bold;">ğŸ‰ å…¨å“¡æ”¯æ‰•æ¸ˆ</span></div>`;
                        }
                    }
                } catch (e) {
                    participantsStr = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼";
                }

                // çŠ¶æ³ã®è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯
                let statusStyle = "font-weight:bold;";
                if (r.status === "ç”³è¾¼å®Œäº†") {
                    statusStyle += "color: #28a745;";
                } else if (r.status === "ç”³è«‹ä¸­") {
                    statusStyle += "color: #e67e22;";
                } else {
                    statusStyle += "color: #333;";
                }

                // è¡Œã®HTMLç”Ÿæˆ
                tr.innerHTML = `
        <td data-label="å¤§ä¼šå">${escapeHtml(r.name)}</td>
        <td data-label="å…¥åŠ›æœŸé™">${cleanDate}</td>
        <td data-label="æ‹…å½“è€…">${escapeHtml(r.person)}</td>
        <td data-label="å‚åŠ è²»">${feeDisplay}</td>
        
        <td data-label="å‚åŠ è€…" class="participant-cell">${participantsStr}</td>
        
        <td data-label="çŠ¶æ³" style="${statusStyle}">${r.status}</td>
        
        <td data-label="æ“ä½œ" class="delete-col" style="white-space:nowrap;">
            <button type="button" style="background:#6f42c1; display:inline-block; width:auto; padding:6px 10px; margin-right:4px;" onclick="openTournamentDetail(${r.row})">è©³ç´°</button>
            <button type="button" style="background:#17a2b8; display:inline-block; width:auto; padding:6px 10px;" onclick="openEditTournament(${r.row})">ç·¨é›†</button>
        </td>
        <td data-label="å‰Šé™¤" class="delete-col">
            <button type="button" onclick="deleteTournament(${r.row})">å‰Šé™¤</button>
        </td>`;
                tbody.appendChild(tr);
            });
        }

        async function submitTournament() {
            const name = document.getElementById("tournamentName").value;
            const deadline = document.getElementById("deadline").value;
            const person = document.getElementById("tournamentPerson").value;
            const status = document.getElementById("status").value;
            const restriction = document.getElementById("restriction").value;
            const fee = document.getElementById("tournamentFee").value; // â˜…è¿½åŠ 

            if (!name || !deadline || !person) return alert("å¤§ä¼šåãƒ»ç”³è¾¼æœŸé™ãƒ»æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

            showLoading(true);
            // fee ã‚’è¿½åŠ ã—ã¦é€ä¿¡
            const res = await callGas('saveTournament', {
                name, deadline, person, status,
                fileUrl: "", participants: "[]", restriction,
                fee: fee // â˜…è¿½åŠ 
            });

            if (res) {
                alert(res);
                document.getElementById("tournamentName").value = "";
                document.getElementById("tournamentPerson").value = "";
                document.getElementById("tournamentFee").value = ""; // ã‚¯ãƒªã‚¢
                localStorage.removeItem(CACHE_KEY_TOURNAMENT); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                loadTournamentList();
            }
            showLoading(false);
        }

        // --- å¤§ä¼šè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç† ---

        function openTournamentDetail(rowNum) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const target = tournamentListCache.find(r => r.row == rowNum);
            if (!target) return alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");

            currentTournamentRow = rowNum;
            currentTournamentFileUrl = target.fileUrl || "";

            try {
                currentTournamentParticipants = JSON.parse(target.participants || "[]");
            } catch (e) {
                currentTournamentParticipants = [];
            }

            document.getElementById("tDetailTitle").innerText = target.name;

            // è¦é …ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºæ›´æ–°
            renderTournamentFileArea();

            // å‚åŠ è€…ãƒªã‚¹ãƒˆè¡¨ç¤ºæ›´æ–°
            renderTournamentParticipants();

            // ãƒ¡ãƒ³ãƒãƒ¼é¸æŠè‚¢ã®ç”Ÿæˆ
            const select = document.getElementById("tMemberSelect");
            select.innerHTML = "";

            // å¤§ä¼šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ¶é™ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã° 'all'ï¼‰
            const restrictionType = target.restriction || 'all';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
            const filteredMembers = weeklyMembers.filter(m => {
                if (restrictionType === 'elem_all') return m.isClub;        // å°å­¦ç”Ÿå…¨å“¡
                if (restrictionType === 'elem_fed') return m.isElemFed;     // å°å­¦ç”Ÿé€£ç›Ÿ
                if (restrictionType === 'jhs_fed') return m.isFed;          // ä¸­å­¦ç”Ÿé€£ç›Ÿ
                return true; // all ã¾ãŸã¯ãã®ä»–
            });

            if (filteredMembers.length === 0) {
                const op = document.createElement("option");
                op.text = "å¯¾è±¡è€…ãŒã„ã¾ã›ã‚“";
                select.appendChild(op);
            } else {
                filteredMembers.forEach(m => {
                    const op = document.createElement("option");
                    op.value = m.name;
                    op.text = `${m.name} (${m.grade})`;
                    select.appendChild(op);
                });
            }

            // ãƒœãƒƒã‚¯ã‚¹éè¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
            document.getElementById("addParticipantBox").style.display = "none";

            document.getElementById("tournamentDetailModal").style.display = "block";
        }

        function closeTournamentDetail() {
            document.getElementById("tournamentDetailModal").style.display = "none";
        }

        function renderTournamentFileArea() {
            const area = document.getElementById("tFileLinkArea");
            area.innerHTML = "";

            if (currentTournamentFileUrl) {
                // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ï¼šæ¨ªä¸¦ã³ï¼ˆå·¦å³é…ç½®ï¼‰ã«å¤‰æ›´ã—ã¦èª¤æ“ä½œã‚’é˜²æ­¢ â–¼â–¼â–¼
                area.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; background:#fff; padding:12px 15px; border-radius:8px; border:1px solid #eee;">
                    <a href="${currentTournamentFileUrl}" target="_blank" style="font-weight:bold; color:#FF9966; text-decoration:none; display:flex; align-items:center; flex:1; margin-right:10px;">
                        ğŸ“„ è¦é …ãƒ»è³‡æ–™ã‚’é–‹ã
                    </a>
                    <button type="button" onclick="deleteTournamentFile()" style="background:#dc3545; color:white; font-size:11px; padding:6px 12px; width:auto; margin:0; border:none; border-radius:4px; white-space:nowrap;">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </div>
                <div style="font-size:0.8em; color:#999; margin-top:5px; text-align:right;">â€»å¤‰æ›´ã¯æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
            `;
                // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
            } else {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆ
                area.innerHTML = `<span style="color:#999;">è¦é …ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</span>`;
            }
            document.getElementById("tFileUpload").value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚»ãƒƒãƒˆ
        }

        function renderTournamentParticipants() {
            const container = document.getElementById("tParticipantList");
            container.innerHTML = "";

            // ç¾åœ¨ã®å¤§ä¼šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå‚åŠ è²»ã‚’çŸ¥ã‚‹ãŸã‚ï¼‰
            const currentTournament = tournamentListCache.find(r => r.row == currentTournamentRow);
            const feePerPerson = currentTournament ? Number(currentTournament.fee || 0) : 0;

            const total = currentTournamentParticipants.length;
            const paidCount = currentTournamentParticipants.filter(p => p.paid).length;

            // åˆè¨ˆé‡‘é¡ã®è¨ˆç®—
            const totalAmount = feePerPerson * paidCount;

            const countLabel = document.getElementById("tParticipantCount");
            if (countLabel) {
                // äººæ•°ã¨ã€é‡‘é¡ã‚’è¡¨ç¤º
                countLabel.innerHTML = `(æ¸ˆ:<span style="color:#1976D2; font-weight:bold;">${paidCount}</span> / ${total}å) <span style="font-size:0.9em; margin-left:5px;">è¨ˆ Â¥${totalAmount.toLocaleString()}</span>`;
            }

            if (total === 0) {
                container.innerHTML = "<p style='color:#999; text-align:center;'>å‚åŠ è€…ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>";
                return;
            }

            currentTournamentParticipants.forEach((p, index) => {
                const div = document.createElement("div");
                div.className = "participant-row";

                const statusClass = p.paid ? "paid" : "unpaid";
                const statusText = p.paid ? "ï¿¥ æ”¯æ‰•æ¸ˆ" : "ï¿¥ æœªæ‰•ã„";

                div.innerHTML = `
                <span style="font-weight:bold;">${p.name}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="payment-status-btn ${statusClass}" onclick="togglePaymentStatus(${index})">
                        ${statusText}
                    </button>
                    <button style="background:#ccc; color:#333; width:auto; padding:4px 8px; font-size:12px; margin:0;" onclick="removeTournamentParticipant(${index})">âœ•</button>
                </div>
            `;
                container.appendChild(div);
            });
        }

        function toggleAddParticipantBox() {
            const box = document.getElementById("addParticipantBox");
            box.style.display = (box.style.display === "none") ? "block" : "none";
        }

        function addParticipantToTournament() {
            const name = document.getElementById("tMemberSelect").value;
            if (!name) return;

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (currentTournamentParticipants.some(p => p.name === name)) {
                alert("ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™");
                return;
            }

            currentTournamentParticipants.push({ name: name, paid: false });
            renderTournamentParticipants();
            document.getElementById("addParticipantBox").style.display = "none";
        }

        function removeTournamentParticipant(index) {
            if (confirm("ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                currentTournamentParticipants.splice(index, 1);
                renderTournamentParticipants();
            }
        }

        function togglePaymentStatus(index) {
            currentTournamentParticipants[index].paid = !currentTournamentParticipants[index].paid;
            renderTournamentParticipants();
        }

        async function saveTournamentDetails() {
            if (!storage) { alert("Firebaseã®è¨­å®šãŒç„¡åŠ¹ã§ã™ã€‚"); return; }

            showLoading(true);
            const file = document.getElementById("tFileUpload").files[0];
            let fileUrl = currentTournamentFileUrl;

            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                if (file) {
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child('tournament_files/' + Date.now() + '_' + file.name);
                    await fileRef.put(file);
                    fileUrl = await fileRef.getDownloadURL();
                }

                // GASã¸ä¿å­˜ï¼ˆå‚åŠ è€…ãƒªã‚¹ãƒˆã¯JSONæ–‡å­—åˆ—åŒ–ï¼‰
                const participantsJson = JSON.stringify(currentTournamentParticipants);

                // updateTournament ã¯æ—¢å­˜ã®é–¢æ•°ã§ã™ãŒã€GASå´ã§å¼•æ•°ã‚’å¢—ã‚„ã—ã¦å¯¾å¿œã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                // frontendå´ã‹ã‚‰ã¯ã™ã¹ã¦ã®æƒ…å ±ã‚’é€ã‚Šã¾ã™
                // â€»æ—¢å­˜ã®editTournamentç­‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ã¯åˆ¥ãƒ«ãƒ¼ãƒˆã¨ã—ã¦ "updateTournamentDetail" ã‚’å‘¼ã¶å½¢ã«ã—ã¾ã™
                const res = await callGas('updateTournamentDetail', {
                    row: currentTournamentRow,
                    fileUrl: fileUrl,
                    participants: participantsJson
                });

                if (res) {
                    alert(res);
                    closeTournamentDetail();
                    loadTournamentList(); // ãƒªã‚¹ãƒˆæ›´æ–°
                }

            } catch (e) {
                console.error(e);
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteTournamentFile() {
            if (!confirm("æœ¬å½“ã«è¦é …ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰")) return;

            showLoading(true);
            try {
                // å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨ã®ã‚‚ã®ã‚’ç¶­æŒã—ã¤ã¤ã€URLã ã‘ç©ºæ–‡å­— "" ã§ä¸Šæ›¸ãã™ã‚‹
                const participantsJson = JSON.stringify(currentTournamentParticipants);

                const res = await callGas('updateTournamentDetail', {
                    row: currentTournamentRow,
                    fileUrl: "", // URLã‚’ç©ºã«ã™ã‚‹ï¼å‰Šé™¤
                    participants: participantsJson
                });

                if (res) {
                    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                    currentTournamentFileUrl = ""; // ç”»é¢ä¸Šã®å¤‰æ•°ã‚‚ã‚¯ãƒªã‚¢
                    renderTournamentFileArea();    // è¡¨ç¤ºã‚’æ›´æ–°
                    loadTournamentList();          // è£ã®ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
                }
            } catch (e) {
                console.error(e);
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteTournament(row) { if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { showLoading(true); const res = await callGas('deleteTournament', { row }); if (res) { alert(res); loadTournamentList(); } showLoading(false); } }

        // --- ãã®ä»–é€£çµ¡äº‹é … ---
        async function loadOtherList() { const cache = localStorage.getItem(CACHE_KEY_OTHER); if (cache) { renderOtherTable(JSON.parse(cache)); } const data = await callGas('getOtherList'); if (data) { safeSetStorage(CACHE_KEY_OTHER, JSON.stringify(data)); renderOtherTable(data); } }
        function renderOtherTable(data) { const tbody = document.querySelector("#otherList tbody"); tbody.innerHTML = ""; const incomplete = data.filter(r => !/å®Œäº†/.test(String(r.status || ""))); const complete = data.filter(r => /å®Œäº†/.test(String(r.status || ""))); function extractDate(title) { const match = title.match(/\d{4}\/\d{1,2}\/\d{1,2}/); return match ? new Date(match[0]) : new Date("2000-01-01"); } incomplete.sort((a, b) => extractDate(a.title) - extractDate(b.title)); complete.sort((a, b) => extractDate(a.title) - extractDate(b.title));[...incomplete, ...complete].forEach(r => { const isCompleted = /å®Œäº†/.test(String(r.status || "")); const tr = document.createElement("tr"); if (isCompleted) tr.classList.add("other-completed"); tr.innerHTML = `<td>${escapeHtml(r.title)}</td><td>${escapeHtml(r.content)}</td><td>${escapeHtml(r.person)}</td><td>${escapeHtml(r.status)}</td><td class="delete-col"><button type="button" onclick="editOther(${r.row}, '${(r.title || '').replace(/'/g, "\\'")}', '${(r.content || '').replace(/'/g, "\\'")}', '${(r.person || '').replace(/'/g, "\\'")}', '${(r.status || '').replace(/'/g, "\\'")}')">ç·¨é›†</button></td><td class="delete-col"><button type="button" onclick="deleteOtherRow(${r.row})">å‰Šé™¤</button></td>`; tbody.appendChild(tr); }); }
        async function saveOtherData() { const title = document.getElementById("otherTitle").value; const content = document.getElementById("otherContent").value; const person = document.getElementById("otherPerson").value; const status = document.getElementById("otherStatus").value; showLoading(true); const res = await callGas('saveOther', { title, content, person, status }); if (res) { alert(res); loadOtherList(); } showLoading(false); }
        function editOther(row, title, content, person, status) { const tbody = document.querySelector("#otherList tbody"); const tr = Array.from(tbody.children).find(tr => tr.innerHTML.includes(`editOther(${row}`)); if (!tr) return; tr.innerHTML = `<td><input type="text" id="editTitle${row}" value="${title}"></td><td><textarea id="editContent${row}">${content}</textarea></td><td><input type="text" id="editPerson${row}" value="${person}"></td><td><input type="text" id="editStatus${row}" value="${status}"></td><td colspan="2" class="delete-col"><button type="button" onclick="saveEditOther(${row})">ä¿å­˜</button><button type="button" onclick="loadOtherList()">ä¸­æ­¢</button></td>`; }
        async function saveEditOther(row) { const title = document.getElementById(`editTitle${row}`).value; const content = document.getElementById(`editContent${row}`).value; const person = document.getElementById(`editPerson${row}`).value; const status = document.getElementById(`editStatus${row}`).value; showLoading(true); const res = await callGas('updateOther', { row, title, content, person, status }); if (res) { alert(res); loadOtherList(); } showLoading(false); }
        async function deleteOtherRow(row) { if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { showLoading(true); const res = await callGas('deleteOther', { row }); if (res) { alert(res); loadOtherList(); } showLoading(false); } }

        // --- ã‚¹ã‚«ã‚¤ã‚¢ãƒªãƒ¼ãƒŠåº§é–“ (ç”»åƒåœ§ç¸®ä»˜ã) ---
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(blob => {
                            if (blob) resolve(blob);
                            else reject(new Error("Canvas conversion failed"));
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        function forceReloadArena() {
            localStorage.removeItem(CACHE_KEY_ARENA);
            arenaData = [];
            fetchArenaData();
        }

        async function fetchArenaData() {
            const cache = localStorage.getItem(CACHE_KEY_ARENA);
            const notice = document.getElementById("cache-notice");

            if (cache) {
                try {
                    arenaData = JSON.parse(cache);
                    loadArenaList();
                    notice.style.display = "inline-block";
                    notice.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
                } catch (e) {
                    console.warn("Cache broken", e);
                    localStorage.removeItem(CACHE_KEY_ARENA);
                }
            }

            try {
                const data = await callGas('getArenaList');

                notice.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿";
                setTimeout(() => { notice.style.display = "none"; }, 2000);

                if (data && Array.isArray(data)) {
                    const processedData = data.map(d => {
                        let safeUrl = d.url ?? "";
                        if (safeUrl === true || safeUrl === "TRUE" || safeUrl === "true") safeUrl = "";

                        // â˜…ä¿®æ­£: rowNum ã¾ãŸã¯ row ã®ã©ã¡ã‚‰ã‹å…¥ã£ã¦ã„ã‚‹æ–¹ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
                        const rNum = d.rowNum ?? d.row ?? null;

                        return {
                            rowNum: rNum,
                            taskNumber: d.taskNumber ?? d.id ?? "",
                            month: formatMonth(d.month),
                            task: d.task ?? "",
                            person: d.person ?? "",
                            completed: d.completed === true || d.completed === "TRUE",
                            url: safeUrl
                        };
                    });

                    processedData.sort((a, b) => {
                        const dateA = new Date(a.month || "2000-01");
                        const dateB = new Date(b.month || "2000-01");
                        if (dateA - dateB !== 0) return dateA - dateB;

                        const numA = Number(a.taskNumber);
                        const numB = Number(b.taskNumber);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return String(a.taskNumber).localeCompare(String(b.taskNumber));
                    });

                    arenaData = processedData;
                    const cacheData = processedData.map(item => ({ ...item, url: "" }));
                    safeSetStorage(CACHE_KEY_ARENA, JSON.stringify(cacheData));
                    loadArenaList();
                }
            } catch (e) {
                console.error(e);
                notice.style.display = "none";
            }
        }

        function loadArenaList() {
            const tbody = document.querySelector("#arenaTable tbody");
            tbody.innerHTML = "";
            if (!arenaData || arenaData.length === 0) { tbody.innerHTML = "<tr><td colspan='8'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>"; return; }

            arenaData.forEach((t, index) => {
                if (!t) return;
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${t.taskNumber}</td><td>${t.month}</td><td>${escapeHtml(t.task)}</td><td>${escapeHtml(t.person)}</td><td>${t.completed ? "âœ…" : "â¬œ"}</td><td>${t.url ? `<img src="${t.url}" style="max-width:80px; max-height:60px; object-fit:cover; cursor:pointer; border-radius:6px;" onclick="showPhotoModal('${t.url}')">` : "<span style='color:#ccc; font-size:12px;'>ãªã—</span>"}</td><td class="delete-col"><button type="button" onclick="editArenaTask(${index})">ç·¨é›†</button></td><td class="delete-col"><button type="button" onclick="deleteArenaTask(${t.rowNum})">å‰Šé™¤</button></td>`;
                tbody.appendChild(tr);
            });
        }

        async function addArenaTask() {
            if (!storage) { alert("Firebaseã®è¨­å®šãŒç„¡åŠ¹ã§ã™ã€‚"); return; }
            const month = document.getElementById("arenaMonth").value;
            const task = document.getElementById("arenaTask").value;
            const person = document.getElementById("arenaPerson").value;
            const completed = document.getElementById("arenaCompleted").value === "true";
            const file = document.getElementById("arenaPhoto").files[0];
            if (!month || !task || !person) return alert("æœˆãƒ»ã‚¿ã‚¹ã‚¯ãƒ»æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

            showLoading(true);

            try {
                let fileUrl = "";
                if (file) {
                    const blob = await compressImage(file, 600, 0.6);
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child('arena_photos/' + Date.now() + '_' + file.name);
                    await fileRef.put(blob);
                    fileUrl = await fileRef.getDownloadURL();
                }
                const res = await callGas('saveArenaTask', { month, task, person, completed, url: fileUrl });
                if (res) { alert(res); await fetchArenaData(); }
            } catch (error) {
                console.error(error);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        function editArenaTask(index) {
            const t = arenaData[index];
            const tbody = document.querySelector("#arenaTable tbody");
            const tr = tbody.children[index];
            tr.innerHTML = `<td>${t.taskNumber}</td><td><input type="month" id="editArenaMonth${index}" value="${t.month}"></td><td><select id="editArenaTask${index}"><option value="æŠ½é¸äºˆç´„ï¼ˆä½“è‚²é¤¨ã®æ©Ÿæ¢°ï¼‰" ${t.task === "æŠ½é¸äºˆç´„ï¼ˆä½“è‚²é¤¨ã®æ©Ÿæ¢°ï¼‰" ? "selected" : ""}>æŠ½é¸äºˆç´„ï¼ˆä½“è‚²é¤¨ã®æ©Ÿæ¢°ï¼‰</option><option value="è¿½åŠ äºˆç´„ï¼ˆé›»è©±ï¼‰" ${t.task === "è¿½åŠ äºˆç´„ï¼ˆé›»è©±ï¼‰" ? "selected" : ""}>è¿½åŠ äºˆç´„ï¼ˆé›»è©±ï¼‰</option><option value="ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆæŠ½é¸äºˆç´„ï¼‰" ${t.task === "ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆæŠ½é¸äºˆç´„ï¼‰" ? "selected" : ""}>ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆæŠ½é¸äºˆç´„ï¼‰</option><option value="ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆè¿½åŠ äºˆç´„ï¼‰" ${t.task === "ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆè¿½åŠ äºˆç´„ï¼‰" ? "selected" : ""}>ä»®äºˆç´„è¡¨ã®å—ã‘å–ã‚Šï¼ˆè¿½åŠ äºˆç´„ï¼‰</option><option value="ä½¿ç”¨æ–™ã®æ”¯æ‰•ã„" ${t.task === "ä½¿ç”¨æ–™ã®æ”¯æ‰•ã„" ? "selected" : ""}>ä½¿ç”¨æ–™ã®æ”¯æ‰•ã„</option><option value="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¢ºèª" ${t.task === "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¢ºèª" ? "selected" : ""}>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¢ºèª</option></select></td><td><input type="text" id="editArenaPerson${index}" value="${t.person}"></td><td><select id="editArenaCompleted${index}"><option value="false" ${!t.completed ? "selected" : ""}>â¬œ</option><option value="true" ${t.completed ? "selected" : ""}>âœ…</option></select></td><td>${t.url ? `<img id="editArenaImg${index}" src="${t.url}" style="max-width:50px;"><br><button type="button" onclick="removeArenaPhoto(${index})" style="font-size:10px; padding:4px;">å†™çœŸå‰Šé™¤</button>` : ""}<input type="file" id="editArenaPhoto${index}" style="width:180px;"></td><td colspan="2" class="delete-col"><button type="button" onclick="saveArenaEdit(${index})">ä¿å­˜</button><button type="button" onclick="fetchArenaData()">ä¸­æ­¢</button></td>`;
        }

        function removeArenaPhoto(index) {
            const img = document.getElementById(`editArenaImg${index}`);
            if (img) img.remove();
            const input = document.getElementById(`editArenaPhoto${index}`);
            if (input) input.dataset.remove = "true";
        }

        async function saveArenaEdit(index) {
            if (!storage) { alert("Firebaseã®è¨­å®šãŒç„¡åŠ¹ã§ã™ã€‚"); return; }

            const t = arenaData[index];
            const rowNum = t.rowNum;

            // å¿µã®ãŸã‚è¡Œç•ªå·ãƒã‚§ãƒƒã‚¯
            if (!rowNum) {
                alert("ã‚¨ãƒ©ãƒ¼ï¼šãƒ‡ãƒ¼ã‚¿ã®è¡Œç•ªå·ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const month = document.getElementById(`editArenaMonth${index}`).value;
            const task = document.getElementById(`editArenaTask${index}`).value;
            const person = document.getElementById(`editArenaPerson${index}`).value;
            const completed = document.getElementById(`editArenaCompleted${index}`).value === "true";
            const file = document.getElementById(`editArenaPhoto${index}`).files[0];
            const removePhoto = document.getElementById(`editArenaPhoto${index}`).dataset.remove === "true";

            showLoading(true);

            try {
                // â˜…é‡è¦1: ä¿å­˜å‰ã«å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆè¡¨ç¤ºãŒå¤ããªã‚‹ã®ã‚’é˜²ãï¼‰
                localStorage.removeItem(CACHE_KEY_ARENA);

                let res; // GASã‹ã‚‰ã®è¿”ä¿¡ã‚’å—ã‘å–ã‚‹å¤‰æ•°

                if (file) {
                    // ç”»åƒã‚ã‚Šæ›´æ–°ã®å ´åˆ
                    const blob = await compressImage(file, 600, 0.6);
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child('arena_photos/' + Date.now() + '_' + file.name);
                    await fileRef.put(blob);
                    const url = await fileRef.getDownloadURL();
                    res = await callGas('updateArenaTask', { rowNum, month, task, person, completed, url: url });

                } else if (removePhoto) {
                    // ç”»åƒå‰Šé™¤ã®å ´åˆ
                    await callGas('deleteArenaPhoto', { rowNum });
                    res = await callGas('updateArenaTask', { rowNum, month, task, person, completed, url: "" });

                } else {
                    // â˜…é‡è¦2: ç”»åƒå¤‰æ›´ãªã—ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚„å®Œäº†ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰ã®å ´åˆ
                    // ã“ã“ã§ res ã‚’å—ã‘å–ã‚‹å‡¦ç†ãŒæŠœã‘ã¦ã„ãŸãŸã‚ã€ä¿®æ­£ã—ã¾ã—ãŸ
                    res = await callGas('updateArenaTask', { rowNum, month, task, person, completed, url: t.url });
                }

                // â˜…é‡è¦3: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                if (res) {
                    alert("æ›´æ–°ã—ã¾ã—ãŸ"); // GASã‹ã‚‰æˆ»ã‚Šå€¤ãŒã‚ã‚Œã°æˆåŠŸ
                } else {
                    alert("æ›´æ–°å®Œäº†ã—ã¾ã—ãŸãŒã€å¿œç­”ãŒç©ºã§ã—ãŸ");
                }

                await fetchArenaData(); // ç”»é¢ã‚’æœ€æ–°ã«ã™ã‚‹

            } catch (e) {
                console.error(e);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteArenaTask(rowNum) { if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { showLoading(true); const res = await callGas('deleteArenaTask', { rowNum }); if (res) { alert(res); await fetchArenaData(); } showLoading(false); } }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function showPhotoModal(url) { const modal = document.getElementById("photoModal"); document.getElementById("modalImage").src = url; modal.style.display = "flex"; modal.onclick = () => { modal.style.display = "none"; }; }
        function escapeHtml(text) { if (text === null || text === undefined) return ""; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"); }
        function formatMonth(val) { if (!val) return ""; if (typeof val === 'string' && val.length <= 7) return val; const d = new Date(val); if (isNaN(d.getTime())) return val; const year = d.getFullYear(); const month = ("0" + (d.getMonth() + 1)).slice(-2); return `${year}-${month}`; }
        function formatDate(val) { if (!val) return ""; if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val; const d = new Date(val); if (isNaN(d.getTime())) return val; const year = d.getFullYear(); const month = ("0" + (d.getMonth() + 1)).slice(-2); const day = ("0" + d.getDate()).slice(-2); return `${year}-${month}-${day}`; }
        function getDayOfWeekStr(val) { if (!val) return ""; const d = new Date(val); if (isNaN(d.getTime())) return ""; const days = ["(æ—¥)", "(æœˆ)", "(ç«)", "(æ°´)", "(æœ¨)", "(é‡‘)", "(åœŸ)"]; return days[d.getDay()]; }
        function toggleSummary(id, headerEl) { const content = document.getElementById(id); content.classList.toggle('open'); headerEl.classList.toggle('open'); }
        function toggleMemoContent(contentId, iconId) { const content = document.getElementById(contentId); const icon = document.getElementById(iconId); if (content.style.display === "block") { content.style.display = "none"; icon.style.transform = "rotate(0deg)"; } else { content.style.display = "block"; icon.style.transform = "rotate(180deg)"; } }

        async function updateShuttleStock(type) {
            shuttleUpdateCount++;
            let idPrefix = "";
            if (type === 'jr_kamiho') idPrefix = 'jrKamiho';
            else if (type === 'jr_kamitsu') idPrefix = 'jrKamitsu';
            else if (type === 'fed') idPrefix = 'fed';
            else return;

            const used = Number(document.getElementById(idPrefix + 'Used').value) || 0;
            const added = Number(document.getElementById(idPrefix + 'Added').value) || 0;

            // â˜…è¿½åŠ : ç”¨é€”ã¨å‚™è€ƒã®å–å¾—
            const usageType = document.getElementById(idPrefix + 'Type').value;
            const remarks = document.getElementById(idPrefix + 'Memo').value;

            if (used === 0 && added === 0) return alert("ä½¿ç”¨æ•°ã¾ãŸã¯è¿½åŠ æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            showLoading(true);

            // â˜…ä¿®æ­£: GASã¸ usageType ã¨ remarks ã‚‚ä¸€ç·’ã«é€ã‚‹
            const res = await callGas('updateShuttleStock', {
                type,
                used,
                added,
                usageType, // ç”¨é€”ï¼ˆç·´ç¿’ã€å¤§ä¼šãªã©ï¼‰
                remarks    // å‚™è€ƒ
            });

            showLoading(false);

            if (res) {
                alert("æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ");
                // å…¥åŠ›æ¬„ã®ã‚¯ãƒªã‚¢
                document.getElementById(idPrefix + 'Used').value = "";
                document.getElementById(idPrefix + 'Added').value = "";
                document.getElementById(idPrefix + 'Type').value = "ç·´ç¿’"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                document.getElementById(idPrefix + 'Memo').value = "";      // ã‚¯ãƒªã‚¢

                refreshShuttleUI(res);
                safeSetStorage(CACHE_KEY_SHUTTLE, JSON.stringify(res));
            }
        }

        function refreshShuttleUI(data) {
            if (data.jr_kamiho) { document.getElementById('jrKamihoStock').innerText = data.jr_kamiho.stock; document.getElementById('jrKamihoWeekUsed').innerText = data.jr_kamiho.week; document.getElementById('jrKamihoMonthUsed').innerText = data.jr_kamiho.month; }
            if (data.jr_kamitsu) { document.getElementById('jrKamitsuStock').innerText = data.jr_kamitsu.stock; document.getElementById('jrKamitsuWeekUsed').innerText = data.jr_kamitsu.week; document.getElementById('jrKamitsuMonthUsed').innerText = data.jr_kamitsu.month; }
            if (data.fed) { document.getElementById('fedStock').innerText = data.fed.stock; document.getElementById('fedWeekUsed').innerText = data.fed.week; document.getElementById('fedMonthUsed').innerText = data.fed.month; }
        }

        async function loadShuttleData() {
            const cache = localStorage.getItem(CACHE_KEY_SHUTTLE);
            const notice = document.getElementById("cache-notice");

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å…ˆã«è¡¨ç¤º
            if (cache) {
                refreshShuttleUI(JSON.parse(cache));
                if (notice) {
                    notice.style.display = "inline-block";
                    notice.innerText = "æœ€æ–°æƒ…å ±ã‚’ç¢ºèªä¸­...";
                }
            } else {
                showLoading(true);
            }

            const myCount = shuttleUpdateCount;
            const res = await callGas('getShuttleStock'); // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            showLoading(false);

            // é€šä¿¡ä¸­ã«åˆ¥ã®æ›´æ–°ãŒã‚ã£ãŸå ´åˆã¯å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ãªã„
            if (shuttleUpdateCount !== myCount) return;

            if (res) {
                refreshShuttleUI(res);
                safeSetStorage(CACHE_KEY_SHUTTLE, JSON.stringify(res));

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œï¼ˆé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
                if (typeof loadShuttleCalendarData === 'function') {
                    loadShuttleCalendarData();
                }

                if (notice && cache) {
                    notice.innerText = "æœ€æ–°ã®çŠ¶æ…‹ã§ã™";
                    setTimeout(() => { notice.style.display = "none"; }, 2000);
                }
            }
        }

        async function loadShuttleCalendarData() {
            const res = await callGas('getShuttleLogDetails');
            if (res) {
                shuttleLogsCache = res;
                renderShuttleCalendar();
            }
        }

        function changeShuttleMonth(diff) {
            currentCalDate.setMonth(currentCalDate.getMonth() + diff);
            renderShuttleCalendar();
            document.getElementById("shuttleDayDetail").style.display = 'none';
        }

        function renderShuttleCalendar() {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();

            document.getElementById("shuttleCalTitle").innerText = `${year}å¹´ ${month + 1}æœˆ`;

            const container = document.getElementById("shuttleCalendarGrid");
            container.innerHTML = "";

            const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
            weekdays.forEach((w, i) => {
                const div = document.createElement("div");
                div.className = `cal-weekday ${i === 0 ? 'sun' : ''} ${i === 6 ? 'sat' : ''}`;
                div.innerText = w;
                container.appendChild(div);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement("div");
                empty.className = "cal-cell";
                empty.style.background = "#f9f9f9";
                container.appendChild(empty);
            }

            const today = new Date();
            const isCurrentMonth = (today.getFullYear() === year && today.getMonth() === month);

            for (let d = 1; d <= lastDate; d++) {
                const cell = document.createElement("div");
                cell.className = "cal-cell";
                if (isCurrentMonth && d === today.getDate()) cell.classList.add("cal-today");

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // ãƒ­ã‚°ã®é›†è¨ˆã¨ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ•ãƒ©ã‚°
                const dayLogs = shuttleLogsCache.filter(l => l.date === dateStr);

                // --- é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ ---
                let summary = {
                    kamiho: { used: 0, added: 0 },
                    kamitsu: { used: 0, added: 0 },
                    fed: { used: 0, added: 0 }
                };

                dayLogs.forEach(l => {
                    if (l.category.includes('kamiho')) { summary.kamiho.used += l.used; summary.kamiho.added += l.added; }
                    if (l.category.includes('kamitsu')) { summary.kamitsu.used += l.used; summary.kamitsu.added += l.added; }
                    if (l.category.includes('fed')) { summary.fed.used += l.used; summary.fed.added += l.added; }
                });

                // æ—¥ä»˜ã¯å¸¸ã«é»’è‰²ï¼ˆå¤ªå­—ã‚¯ãƒ©ã‚¹ã ã‘ä»˜ä¸ï¼‰
                let numClass = "cal-date-num";
                if (dayLogs.length > 0) numClass += " cal-has-data";

                let html = `<div class="${numClass}">${d}</div>`;

                // --- ãƒãƒƒã‚¸ç”Ÿæˆ ---
                // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: (ã‚¿ã‚¤ãƒ—, ä½¿ç”¨æ•°, è¿½åŠ æ•°) -> HTML
                const makeBadge = (typeClass, u, a) => {
                    let text = "";
                    if (u > 0) text += `-${u}`;
                    if (a > 0) text += `${text ? ' ' : ''}+${a}`;

                    if (!text) return "";
                    return `<div class="cal-info-badge ${typeClass}">${text}</div>`;
                };

                if (dayLogs.length > 0) {
                    html += `<div class="cal-indicators">`;
                    html += makeBadge('badge-kamiho', summary.kamiho.used, summary.kamiho.added);
                    html += makeBadge('badge-kamitsu', summary.kamitsu.used, summary.kamitsu.added);
                    html += makeBadge('badge-fed', summary.fed.used, summary.fed.added);
                    html += `</div>`;
                }

                cell.innerHTML = html;
                cell.onclick = () => showShuttleDayDetail(dateStr, dayLogs);
                container.appendChild(cell);
            }
        }

        function showShuttleDayDetail(dateStr, logs) {
            const detailBox = document.getElementById("shuttleDayDetail");
            const listContent = document.getElementById("detailListContent");
            document.getElementById("detailDateStr").innerText = `${dateStr} ã®å±¥æ­´`;

            listContent.innerHTML = "";

            if (logs.length === 0) {
                listContent.innerHTML = "<p style='color:#999; text-align:center;'>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
            } else {
                logs.forEach(l => {
                    const div = document.createElement("div");
                    div.className = "detail-item";

                    let catName = "ä¸æ˜";
                    let catClass = "bg-jr";

                    if (l.category.includes("fed")) {
                        catName = "ä¸­å­¦";
                        catClass = "bg-fed";
                    } else if (l.category.includes("kamiho")) {
                        catName = "ä¸Šæ˜Ÿ";
                        catClass = "bg-kamiho";
                    } else if (l.category.includes("kamitsu")) {
                        catName = "ä¸Šé¶´";
                        catClass = "bg-kamitsu";
                    }

                    let actionText = "";
                    const parts = [];
                    if (l.used > 0) parts.push(`<span style="color:#FF5E62; font-weight:bold;">æ¶ˆè²»: ${l.used}ç­’</span>`);
                    if (l.added > 0) parts.push(`<span style="color:#0277BD; font-weight:bold;">å…¥è·: ${l.added}ç­’</span>`);
                    actionText = parts.join(" / ");

                    let detailText = "";
                    if (l.usageType) detailText += `[${l.usageType}] `;
                    if (l.remarks) detailText += `${l.remarks}`;
                    if (!detailText) detailText = "(è©³ç´°ãªã—)";

                    div.innerHTML = `
                    <div class="detail-row-header">
                        <span class="detail-cat ${catClass}">${catName}</span>
                        <span class="detail-stats">${actionText}</span>
                    </div>
                    <div style="font-size:0.85em; color:#666; padding-left:5px; margin-left: 5px; border-left: 2px solid #eee;">
                        ğŸ“ ${detailText}
                    </div>
                `;
                    listContent.appendChild(div);
                });
            }

            detailBox.style.display = "block";
            detailBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const TRAINING_APP_URL = "https://coachmasuacademy-alt.github.io/my-website/";

        // åˆ†æã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¾æ›¸
        const ANALYSIS_RULES = [
            // --- ãƒ€ãƒ–ãƒ«ã‚¹ ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ»é€£æº ---
            {
                label: "ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³",
                keywords: ["ãƒ­ãƒ¼ãƒ†", "å›ã‚‹", "å…¥ã‚Œæ›¿", "ãƒˆãƒƒãƒ—ã‚¢ãƒ³ãƒ‰", "ã‚µã‚¤ãƒ‰ãƒã‚¤", "è¢«ã‚‹"],
                required: []
            },
            {
                label: "å‰è¡›ãƒ»ãƒ—ãƒƒã‚·ãƒ¥",
                keywords: ["å‰è¡›", "ãƒ—ãƒƒã‚·ãƒ¥", "ãƒãƒƒãƒˆå‰", "é£›ã³å‡ºã—", "ã¤ã¶ã™"],
                required: []
            },
            {
                label: "å¾Œè¡›ãƒ»ã‚«ãƒãƒ¼",
                keywords: ["å¾Œè¡›", "ã‚«ãƒãƒ¼", "é€£ç¶š", "æ‰“ã¡çµ‚ã‚ã‚Š"],
                required: []
            },

            // --- ã‚µãƒ¼ãƒ–ãƒ»ãƒ¬ã‚·ãƒ¼ãƒ– ---
            {
                label: "ã‚µãƒ¼ãƒ–ãƒ»3çƒç›®",
                keywords: ["ã‚µãƒ¼ãƒ–", "ï¼“çƒç›®", "3çƒç›®", "ãƒ­ãƒ³ã‚°", "ã‚·ãƒ§ãƒ¼ãƒˆ"],
                required: []
            },
            {
                label: "ãƒ¬ã‚·ãƒ¼ãƒ–",
                keywords: ["ãƒ¬ã‚·ãƒ¼ãƒ–", "ãƒªã‚¿ãƒ¼ãƒ³", "è¿”çƒ", "ãƒ—ãƒƒã‚·ãƒ¥ãƒ¬ã‚·ãƒ¼ãƒ–"],
                required: []
            },

            // --- ã‚·ãƒ§ãƒƒãƒˆåˆ¥ ---
            { label: "ã‚¯ãƒªã‚¢", keywords: ["ã‚¯ãƒªã‚¢", "ãƒã‚¤ã‚¯ãƒªã‚¢", "ãƒ‰ãƒªãƒ–ãƒ³"], required: [] },
            { label: "ãƒ­ãƒ–", keywords: ["ãƒ­ãƒ–", "ä¸Šã’ã‚‹", "ä¸Šã’"], required: [] },
            {
                label: "ãƒ•ã‚©ã‚¢å¥¥ã‹ã‚‰ã®ã‚·ãƒ§ãƒƒãƒˆ",
                keywords: ["ãƒ•ã‚©ã‚¢å¥¥", "æ­£å¯¾", "å³å¥¥"],
                required: []
            },

            // --- ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»å‹•ã ---
            {
                label: "ã‚³ãƒ¼ãƒˆå¾Œæ–¹ã¸ã®å‹•ãå‡ºã—",
                keywords: ["ä¸‹ãŒã‚‹", "ä¸‹ãŒã‚Š", "å¾Œã‚", "å¾Œæ–¹", "ãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—", "ä¸‹ã’ã‚‰ã‚Œ"],
                required: []
            },
            {
                label: "ãƒãƒƒãƒˆå‰ã®å‹•ãå‡ºã—",
                keywords: ["å–ã‚Œãª", "ã¨ã‚Œãª", "è¿½ã„ã¤ã‘", "è¶³ãŒå‡ºãª", "ä¸€æ­©ç›®", "é…ã‚Œ", "åå¿œ"],
                required: ["ãƒ‰ãƒ­ãƒƒãƒ—", "ãƒ˜ã‚¢ãƒ”ãƒ³", "å‰", "ãƒãƒƒãƒˆ"]
            },
            {
                label: "ã‚¹ã‚¿ãƒŸãƒŠãƒ»ä½“åŠ›",
                keywords: ["ä½“åŠ›", "ãƒãƒ†", "æ¯ãŒ", "è¶³ãŒæ­¢", "å‹•ã‘ãª"],
                required: []
            },
            { label: "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…¨èˆ¬", keywords: ["ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "è¶³", "ã‚¹ãƒ†ãƒƒãƒ—"], required: [] },

            // --- ãã®ä»–ã‚·ãƒ§ãƒƒãƒˆ ---
            {
                label: "ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰ã®ã‚·ãƒ§ãƒƒãƒˆ",
                keywords: ["ãƒ©ã‚¦ãƒ³ãƒ‰", "ãƒã‚¤ãƒãƒƒã‚¯"],
                required: []
            },
            {
                label: "ã‚·ãƒ§ãƒƒãƒˆã®æµ®ããƒ»ç²¾åº¦",
                keywords: ["æµ®ã", "æµ®ã„ã¦", "ç”˜ã", "é«˜ã„", "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«", "ã‚¢ã‚¦ãƒˆ"],
                required: []
            },
            { label: "ã‚¹ãƒãƒƒã‚·ãƒ¥å¼·åŒ–", keywords: ["ã‚¹ãƒãƒƒã‚·ãƒ¥"], required: [] },
            { label: "ãƒ‰ãƒ­ãƒƒãƒ—ãƒ»ã‚«ãƒƒãƒˆ", keywords: ["ãƒ‰ãƒ­ãƒƒãƒ—", "ã‚«ãƒƒãƒˆ"], required: [] },
            { label: "ãƒ˜ã‚¢ãƒ”ãƒ³ãƒ»ãƒãƒƒãƒˆ", keywords: ["ãƒ˜ã‚¢ãƒ”ãƒ³", "ãƒãƒƒãƒˆ"], required: [] },
            { label: "ãƒ‰ãƒ©ã‚¤ãƒ–", keywords: ["ãƒ‰ãƒ©ã‚¤ãƒ–"], required: [] },
        ];

        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchViewMode(mode) {
            const catArea = document.getElementById("categoryAnalysisArea");
            const persArea = document.getElementById("personalHistoryArea");
            const btnCat = document.getElementById("btnViewCategory");
            const btnPers = document.getElementById("btnViewPersonal");

            if (mode === 'category') {
                catArea.style.display = "block";
                persArea.style.display = "none";
                btnCat.style.background = "#FF9966"; btnCat.style.color = "white";
                btnPers.style.background = "transparent"; btnPers.style.color = "#666";
            } else {
                catArea.style.display = "none";
                persArea.style.display = "block";
                btnCat.style.background = "transparent"; btnCat.style.color = "#666";
                btnPers.style.background = "#FF9966"; btnPers.style.color = "white";
                updateTimelineMemberSelect();
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ã®åç°¿æ›´æ–°
        function updateTimelineMemberSelect() {
            const select = document.getElementById("timelineMemberSelect");
            if (select.options.length > 1) return;
            select.innerHTML = '<option value="">å±¥æ­´ã‚’è¦‹ãŸã„é¸æ‰‹ã‚’é¸æŠ</option>';
            const names = [...new Set(weeklyMembers.map(m => m.name))];
            names.sort().forEach(name => {
                const op = document.createElement("option");
                op.value = name; op.text = name;
                select.appendChild(op);
            });
        }

        // å€‹äººã®å¤‰é·ã‚’æç”»
        function renderPersonalHistory() {
            const name = document.getElementById("timelineMemberSelect").value;
            const container = document.getElementById("timelineContainer");
            container.innerHTML = "";
            if (!name) return;

            const myTasks = allTasksCache.filter(t => t.name === name);
            if (myTasks.length === 0) {
                container.innerHTML = "<p style='color:#999; text-align:center;'>èª²é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }
            myTasks.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '<div class="timeline-container">';
            myTasks.forEach(task => {
                const dateStr = formatDate(task.date);
                const dateObj = new Date(task.date);
                const labelStr = `${dateObj.getFullYear()}å¹´ ${(dateObj.getMonth() + 1)}æœˆ`;
                const reflectionContent = task.reflection
                    ? `<div class="tl-reflect-section"><span class="tl-label bg-reflect">è€ƒå¯Ÿãƒ»çµæœ</span><div style="font-size:0.95em; color:#333;">${escapeHtml(task.reflection).replace(/\r?\n/g, '<br>')}</div></div>`
                    : `<div class="tl-reflect-section" style="background:#f9f9f9; color:#999; font-size:0.8em;">(è€ƒå¯Ÿã¯ã¾ã å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“)</div>`;

                html += `<div class="timeline-item"><div class="timeline-date-label">${labelStr} <span style="font-size:0.8em; font-weight:normal; color:#999;">(${dateStr})</span></div><div class="timeline-content-box"><div class="tl-task-section"><span class="tl-label bg-task">èª²é¡Œ (${task.type})</span><div style="font-size:1.05em; font-weight:bold; color:#333; line-height:1.5;">${escapeHtml(task.content).replace(/\r?\n/g, '<br>')}</div></div>${reflectionContent}</div></div>`;
            });
            html += '</div><div style="text-align:center; color:#FF9966; font-weight:bold; margin-top:20px;">â¬‡ ç¾åœ¨ã¸ç¶šã â¬‡</div>';
            container.innerHTML = html;
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
        function switchAnalysisTab(mode) {
            currentAnalysisMode = mode;
            const tabs = document.querySelectorAll('.analysis-tab');
            tabs.forEach(btn => {
                btn.style.background = "#eee"; btn.style.color = "#666"; btn.style.boxShadow = "none";
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`tab_${mode}`);
            if (activeBtn) {
                activeBtn.style.background = "#FF9966"; activeBtn.style.color = "white";
                activeBtn.style.boxShadow = "0 2px 5px rgba(255, 153, 102, 0.4)";
                activeBtn.classList.add('active');
            }
            renderAnalysis();
        }

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã®æç”»
        function renderAnalysis() {
            const titleEl = document.getElementById("analysisTitle");
            if (currentAnalysisMode === 'elem_s') titleEl.innerText = "ğŸ¸ å°å­¦ç”Ÿãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã®èª²é¡Œ";
            else if (currentAnalysisMode === 'elem_d') titleEl.innerText = "ğŸ¸ å°å­¦ç”Ÿãƒ»ãƒ€ãƒ–ãƒ«ã‚¹ã®èª²é¡Œ";
            else if (currentAnalysisMode === 'mid_s') titleEl.innerText = "ğŸ¸ ä¸­å­¦ç”Ÿãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã®èª²é¡Œ";
            else if (currentAnalysisMode === 'mid_d') titleEl.innerText = "ğŸ¸ ä¸­å­¦ç”Ÿãƒ»ãƒ€ãƒ–ãƒ«ã‚¹ã®èª²é¡Œ";

            if (!allTasksCache || allTasksCache.length === 0) {
                document.querySelector("#taskTable tbody").innerHTML = `<tr><td colspan="4" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
                return;
            }

            const targetTasks = allTasksCache.filter(task => {
                const member = weeklyMembers.find(m => m.name === task.name);
                if (!member) return false;
                let schoolType = member.isElemFed ? "elem" : (member.isFed ? "mid" : "unknown");
                const taskType = task.type || "ã‚·ãƒ³ã‚°ãƒ«ã‚¹";
                if (currentAnalysisMode === 'elem_s') return schoolType === 'elem' && taskType === 'ã‚·ãƒ³ã‚°ãƒ«ã‚¹';
                if (currentAnalysisMode === 'elem_d') return schoolType === 'elem' && taskType === 'ãƒ€ãƒ–ãƒ«ã‚¹';
                if (currentAnalysisMode === 'mid_s') return schoolType === 'mid' && taskType === 'ã‚·ãƒ³ã‚°ãƒ«ã‚¹';
                if (currentAnalysisMode === 'mid_d') return schoolType === 'mid' && taskType === 'ãƒ€ãƒ–ãƒ«ã‚¹';
                return false;
            });

            const tbody = document.querySelector("#taskTable tbody");
            tbody.innerHTML = "";

            if (targetTasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">ã“ã®ã‚«ãƒ†ã‚´ãƒªã®èª²é¡Œã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>`;
                document.getElementById("keywordRanking").innerHTML = "";
                return;
            }

            targetTasks.slice().reverse().forEach(r => {
                const tr = document.createElement("tr");
                const safeContent = escapeHtml(r.content);
                const safeType = r.type || "ã‚·ãƒ³ã‚°ãƒ«ã‚¹";
                const contentForFunc = safeContent.replace(/\r?\n/g, '\\n').replace(/'/g, "\\'");
                const encodedTask = encodeURIComponent(r.content);
                const reflectionHtml = r.reflection
                    ? `<div style="margin-top:8px; padding-top:8px; border-top:1px dashed #ccc; font-size:0.95em; color:#2E7D32;"><span style="font-weight:bold; font-size:0.8em; background:#E8F5E9; padding:2px 6px; border-radius:4px; margin-right:5px;">âœ… è€ƒå¯Ÿ</span>${escapeHtml(r.reflection).replace(/\r?\n/g, '<br>')}</div>`
                    : `<div style="margin-top:8px;"><button onclick="openReflectionModal(${r.row}, '${contentForFunc}')" style="width:100%; padding:6px; font-size:0.85em; background:#fff; border:1px solid #28a745; color:#28a745; border-radius:6px; box-shadow:none;">ï¼‹ è€ƒå¯Ÿãƒ»æŒ¯ã‚Šè¿”ã‚Šã‚’å…¥åŠ›</button></div>`;

                tr.innerHTML = `<td data-label="æ°å">${escapeHtml(r.name)}</td><td data-label="èª²é¡Œã¨è€ƒå¯Ÿ"><div style="font-weight:bold; color:#333;">${safeContent}</div>${reflectionHtml}</td><td data-label="æ—¥æ™‚" style="font-size:0.8em; color:#999;">${formatDate(r.date)}</td><td data-label="æ“ä½œ" class="delete-col" style="white-space:nowrap;"><button onclick="window.open('${TRAINING_APP_URL}?task=${encodedTask}&role=admin', '_blank')" style="width:auto; padding:8px 10px; font-size:11px; background:linear-gradient(135deg, #2b5876 0%, #4e4376 100%); color:white; border:none; box-shadow:0 2px 5px rgba(0,0,0,0.2); margin-right:4px; margin-bottom:6px; display:inline-block; text-align:left; line-height:1.4;"><span style="font-weight:bold; font-size:1.1em; display:block;">ğŸš€ Smart Coach</span></button><div style="margin-top:2px;"><button onclick="openEditTask(${r.row}, '${safeType}', '${contentForFunc}')" style="width:auto; padding:5px 10px; font-size:11px; background:#17a2b8; margin-right:4px;">ç·¨é›†</button><button onclick="deleteTask(${r.row})" style="width:auto; padding:5px 10px; font-size:11px; background:#dc3545;">å‰Šé™¤</button></div></td>`;
                tbody.appendChild(tr);
            });
            analyzeKeywords(targetTasks);
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
        function analyzeKeywords(data) {
            const counts = {};
            data.forEach(row => {
                const text = row.content;
                for (const rule of ANALYSIS_RULES) {
                    const hasKeyword = rule.keywords.some(k => text.includes(k));
                    const hasRequired = rule.required.length === 0 || rule.required.some(r => text.includes(r));
                    if (hasKeyword && hasRequired) counts[rule.label] = (counts[rule.label] || 0) + 1;
                }
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById("keywordRanking");
            container.innerHTML = "";
            if (sorted.length === 0) {
                container.innerHTML = "<span style='color:#999; font-size:0.9em;'>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã—</span>";
                return;
            }
            sorted.forEach(([word, count]) => {
                const isTop = count >= 3;
                const bg = isTop ? "#FF9966" : "#f0f0f0";
                const color = isTop ? "white" : "#333";
                const weight = isTop ? "bold" : "normal";
                const div = document.createElement("div");
                div.style.cssText = `padding:6px 12px; background:${bg}; color:${color}; border-radius:15px; font-size:0.85em; font-weight:${weight}; display:flex; align-items:center;`;
                div.innerHTML = `${word} <span style="background:rgba(255,255,255,0.7); color:#333; padding:1px 6px; border-radius:8px; font-size:0.8em; margin-left:6px;">${count}</span>`;
                container.appendChild(div);
            });
        }

        // åç°¿ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
        function updateTaskMemberSelect() {
            const select = document.getElementById("taskName");
            if (select.options.length > 1) return;
            select.innerHTML = '<option value="">åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            if (!weeklyMembers || weeklyMembers.length === 0) {
                const op = document.createElement("option"); op.text = "åç°¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­..."; select.appendChild(op); return;
            }
            weeklyMembers.forEach(m => {
                if (m.isElemFed || m.isFed) {
                    let label = m.isElemFed ? "ã€å°ã€‘" : "ã€ä¸­ã€‘";
                    const op = document.createElement("option");
                    op.value = m.name; op.text = `${label} ${m.name}`;
                    select.appendChild(op);
                }
            });
        }

        // èª²é¡Œã‚’ç™»éŒ²
        async function submitTask() {
            const name = document.getElementById("taskName").value;
            const content = document.getElementById("taskContent").value;
            const typeRadios = document.getElementsByName("taskType");
            let typeVal = "";
            for (let r of typeRadios) { if (r.checked) typeVal = r.value; }
            if (!name) return alert("åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
            if (!content) return alert("èª²é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            showLoading(true);
            const res = await callGas('saveTask', { name, content, type: typeVal });
            if (res) { alert("ç™»éŒ²ã—ã¾ã—ãŸ"); document.getElementById("taskContent").value = ""; loadTasks(); }
            showLoading(false);
        }

        // èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function loadTasks() {
            updateTaskMemberSelect();
            showLoading(true);
            const data = await callGas('getTaskList');
            showLoading(false);
            if (data) { allTasksCache = data; renderAnalysis(); }
        }

        function openEditTask(row, type, content) {
            document.getElementById("editTaskRow").value = row;
            document.getElementById("editTaskContent").value = content;
            const radios = document.getElementsByName("editTaskType");
            for (const r of radios) { r.checked = (r.value === type); }
            document.getElementById("taskEditModal").style.display = "flex";
        }

        async function saveTaskEdit() {
            const row = document.getElementById("editTaskRow").value;
            const content = document.getElementById("editTaskContent").value;
            let type = "ã‚·ãƒ³ã‚°ãƒ«ã‚¹";
            const radios = document.getElementsByName("editTaskType");
            for (const r of radios) { if (r.checked) type = r.value; }
            if (!content) return alert("èª²é¡Œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            showLoading(true);
            const res = await callGas('updateTask', { row, content, type });
            if (res) { alert(res); document.getElementById("taskEditModal").style.display = "none"; loadTasks(); }
            showLoading(false);
        }

        async function deleteTask(row) {
            if (!confirm("æœ¬å½“ã«ã“ã®èª²é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            showLoading(true);
            const res = await callGas('deleteTask', { row });
            if (res) { alert(res); loadTasks(); }
            showLoading(false);
        }

        function generateTeamPlanPrompt() {
            if (!allTasksCache || allTasksCache.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            const targetTasks = allTasksCache.filter(task => {
                const member = weeklyMembers.find(m => m.name === task.name);
                if (!member) return false;
                let schoolType = member.isElemFed ? "elem" : (member.isFed ? "mid" : "unknown");
                const taskType = task.type || "ã‚·ãƒ³ã‚°ãƒ«ã‚¹";
                if (currentAnalysisMode === 'elem_s') return schoolType === 'elem' && taskType === 'ã‚·ãƒ³ã‚°ãƒ«ã‚¹';
                if (currentAnalysisMode === 'elem_d') return schoolType === 'elem' && taskType === 'ãƒ€ãƒ–ãƒ«ã‚¹';
                if (currentAnalysisMode === 'mid_s') return schoolType === 'mid' && taskType === 'ã‚·ãƒ³ã‚°ãƒ«ã‚¹';
                if (currentAnalysisMode === 'mid_d') return schoolType === 'mid' && taskType === 'ãƒ€ãƒ–ãƒ«ã‚¹';
                return false;
            });
            if (targetTasks.length === 0) return alert("ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯èª²é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

            const counts = {};
            targetTasks.forEach(row => {
                const text = row.content;
                for (const rule of ANALYSIS_RULES) {
                    const hasKeyword = rule.keywords.some(k => text.includes(k));
                    const hasRequired = rule.required.length === 0 || rule.required.some(r => text.includes(r));
                    if (hasKeyword && hasRequired) counts[rule.label] = (counts[rule.label] || 0) + 1;
                }
            });
            const sortedIssues = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([key, val]) => `${key}(${val}å)`);
            if (sortedIssues.length === 0) return alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");

            let categoryName = "";
            if (currentAnalysisMode === 'elem_s') categoryName = "å°å­¦ç”Ÿãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹";
            else if (currentAnalysisMode === 'elem_d') categoryName = "å°å­¦ç”Ÿãƒ»ãƒ€ãƒ–ãƒ«ã‚¹";
            else if (currentAnalysisMode === 'mid_s') categoryName = "ä¸­å­¦ç”Ÿãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹";
            else if (currentAnalysisMode === 'mid_d') categoryName = "ä¸­å­¦ç”Ÿãƒ»ãƒ€ãƒ–ãƒ«ã‚¹";

            const teamData = { category: categoryName, issues: sortedIssues };
            const encodedData = encodeURIComponent(JSON.stringify(teamData));
            window.open(`${TRAINING_APP_URL}?mode=team_link&data=${encodedData}`, '_blank');
        }

        // æœˆè¬ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadFeeData(isBackground = false) {
            const monthInput = document.getElementById("feeMonthSelect");
            if (!monthInput.value) monthInput.value = formatMonth(new Date());
            const targetMonth = monthInput.value;
            const notice = document.getElementById("cache-notice");

            // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å…ˆã«è¡¨ç¤ºã™ã‚‹
            const cache = localStorage.getItem(CACHE_KEY_FEE);
            if (cache && !isBackground) {
                try {
                    const cachedObj = JSON.parse(cache);
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœˆã¨ã€ä»Šè¦‹ã‚ˆã†ã¨ã—ã¦ã„ã‚‹æœˆãŒåŒã˜ãªã‚‰è¡¨ç¤º
                    if (cachedObj.month === targetMonth) {
                        renderFeeTable(cachedObj.data, targetMonth);
                        // è£èª­ã¿è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’å‡ºã•ãªã„ï¼‰
                        isBackground = true;
                        // ã€Œæ›´æ–°ä¸­ã€ã®é€šçŸ¥ã‚’å‡ºã™
                        if (notice) {
                            notice.style.display = "inline-block";
                            notice.innerText = "æœ€æ–°æƒ…å ±ã‚’ç¢ºèªä¸­...";
                        }
                    }
                } catch (e) { console.error("Cache Error", e); }
            }

            // 2. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªãã¦ã€ã‹ã¤è£èª­ã¿è¾¼ã¿ã§ã‚‚ãªã„å ´åˆã®ã¿ï¼‰
            if (!isBackground) showLoading(true);

            // 3. GASã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const data = await callGas('getFeeData', { month: targetMonth });

            if (!isBackground) showLoading(false);

            // 4. ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããŸã‚‰è¡¨ç¤ºæ›´æ–°ï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
            if (data) {
                // é€šçŸ¥ã‚’æ¶ˆã™
                if (notice && isBackground) {
                    notice.innerText = "æœ€æ–°ã®çŠ¶æ…‹ã§ã™";
                    setTimeout(() => { notice.style.display = "none"; }, 2000);
                }

                renderFeeTable(data, targetMonth);
                // æœˆæƒ…å ±ã¨ä¸€ç·’ã«ä¿å­˜
                localStorage.setItem(CACHE_KEY_FEE, JSON.stringify({
                    month: targetMonth,
                    data: data
                }));
            }
        }

        // æœˆè¬ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
        function renderFeeTable(data, month) {
            const tbody = document.querySelector("#feeTable tbody");
            tbody.innerHTML = "";

            const paidList = data.paidList || [];
            // åç°¿ãƒ‡ãƒ¼ã‚¿å–å¾—
            const memberList = (weeklyMembers && weeklyMembers.length > 0) ? weeklyMembers : memberData;

            // é›†è¨ˆç”¨ã‚«ã‚¦ãƒ³ã‚¿
            let paidCount = 0;
            let totalTarget = 0;

            memberList.forEach(m => {
                // â–¼â–¼â–¼ è¿½åŠ : Håˆ—(isExempt)ã«ã€‡ãŒã‚ã‚‹äººã¯è¡¨ç¤ºã—ãªã„ â–¼â–¼â–¼
                if (m.isExempt) return;
                // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

                totalTarget++;
                const isPaid = paidList.includes(m.name);
                if (isPaid) paidCount++;

                const tr = document.createElement("tr");
                const statusBtnClass = isPaid ? "payment-status-btn paid" : "payment-status-btn unpaid";
                const statusText = isPaid ? "æ¸ˆ" : "æœª";
                const rowStyle = isPaid ? "background-color: #f9f9f9;" : "";

                tr.style.cssText = rowStyle;
                tr.innerHTML = `
                <td style="font-weight:bold;">${m.name} <span style="font-size:0.8em; font-weight:normal; color:#888;">(${m.grade})</span></td>
                <td style="text-align:center;">
                    <button class="${statusBtnClass}" onclick="toggleFeeStatus('${m.name}', '${month}', ${!isPaid})">
                        ${statusText}
                    </button>
                </td>
                <td style="text-align:center;"></td>
            `;
                tbody.appendChild(tr);
            });

            // äººæ•°è¡¨ç¤ºæ›´æ–°
            const countLabel = document.getElementById("feeCountLabel");
            if (countLabel) countLabel.innerText = `æ”¯æ‰•ã„æ¸ˆã¿: ${paidCount} / ${totalTarget}å`;
        }

        // æœˆè¬ã®æ”¯æ‰•ã„çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
        async function toggleFeeStatus(name, month, isPay) {
            // å³åº§ã«è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ï¼ˆUXå‘ä¸Šï¼‰
            showLoading(true);
            const res = await callGas('updateFeeStatus', { name, month, isPay });
            showLoading(false);

            if (res) {
                // æˆåŠŸã—ãŸã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºå®šã•ã›ã‚‹
                loadFeeData(true);
            } else {
                alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }


        // â–¼â–¼â–¼ è¿½åŠ : ã‚¬ãƒƒãƒˆå¼µã‚Šç®¡ç†ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼

        // ã‚¬ãƒƒãƒˆç”¨åç°¿ã‚»ãƒƒãƒˆ
        function updateGutMemberSelect() {
            const select = document.getElementById("gutNameSelect");
            if (select.options.length > 1) return; // æ—¢ã«ã‚»ãƒƒãƒˆæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

            const list = weeklyMembers.length > 0 ? weeklyMembers : memberData;
            list.forEach(m => {
                const op = document.createElement("option");
                op.value = m.name;
                op.text = `${m.name} (${m.grade})`;
                select.appendChild(op);
            });

            // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’ä»Šæ—¥ã«
            document.getElementById("gutDate").value = formatDate(new Date());
        }

        // ã‚¬ãƒƒãƒˆå¼µã‚Šãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
        async function loadGutList(isBackground = false) {
            const notice = document.getElementById("cache-notice");

            // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å…ˆã«è¡¨ç¤º
            const cache = localStorage.getItem(CACHE_KEY_GUT);
            if (cache && !isBackground) {
                renderGutTable(JSON.parse(cache));
                isBackground = true; // è£èª­ã¿è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã¸
                if (notice) {
                    notice.style.display = "inline-block";
                    notice.innerText = "æœ€æ–°æƒ…å ±ã‚’ç¢ºèªä¸­...";
                }
            }

            // 2. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            if (!isBackground) showLoading(true);

            // 3. æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
            const data = await callGas('getGutList');

            if (!isBackground) showLoading(false);

            // 4. è¡¨ç¤ºæ›´æ–°ï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
            if (data) {
                if (notice && isBackground) {
                    notice.innerText = "æœ€æ–°ã®çŠ¶æ…‹ã§ã™";
                    setTimeout(() => { notice.style.display = "none"; }, 2000);
                }

                renderGutTable(data);
                localStorage.setItem(CACHE_KEY_GUT, JSON.stringify(data));
            }
        }

        // ã‚¬ãƒƒãƒˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderGutTable(data) {
            const tbody = document.querySelector("#gutTable tbody");
            if (!tbody) return;
            tbody.innerHTML = "";

            // æ—¥ä»˜ã®æ–°ã—ã„é †
            data.sort((a, b) => new Date(b.date) - new Date(a.date));

            data.forEach(r => {
                const tr = document.createElement("tr");
                const date = formatDate(r.date);
                const price = isNaN(r.price) ? "Â¥-" : `Â¥${r.price.toLocaleString()}`;

                // ç¨®é¡ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€å˜ä¾¡ã‹ã‚‰æ¨æ¸¬ã—ã¦è¡¨ç¤ºï¼ˆ1800ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ãªã‚‰ã‚¬ãƒƒãƒˆè¾¼ã€ãã†ã§ãªã‘ã‚Œã°æŒè¾¼ï¼‰
                // ã¾ãŸã¯ã‚·ãƒ³ãƒ—ãƒ«ã«æœ¬æ•°ã‚’è¡¨ç¤º
                let detailText = `${r.count}æœ¬ / ${r.tension}lbs`;
                // å‚è€ƒæƒ…å ±ã¨ã—ã¦å˜ä¾¡ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆï¼ˆä»»æ„ï¼‰
                // const unitType = (r.price / r.count) >= 1800 ? "è¾¼" : "æŒ";
                // detailText += ` (${unitType})`;

                // æ”¯æ‰•ã„çŠ¶æ³åˆ¤å®š
                const isPaid = (r.status === "æ”¯æ‰•ã„æ¸ˆã¿");
                const statusClass = isPaid ? "payment-status-btn paid" : "payment-status-btn unpaid";
                const statusLabel = isPaid ? "æ¸ˆ" : "æœª";
                const bgStyle = isPaid ? "background-color:#f9f9f9;" : "";

                tr.style.cssText = bgStyle;
                tr.innerHTML = `
                <td>${date}</td>
                <td style="font-weight:bold;">${escapeHtml(r.name)}</td>
                <td>
                    <div style="font-size:0.95em; font-weight:bold; color:#555;">${detailText}</div>
                </td>
                <td>
                   <div style="font-weight:bold; color:#1976D2; margin-bottom:5px;">${price}</div>
                   <button class="${statusClass}" onclick="toggleGutStatus(${r.row}, ${!isPaid})" style="font-size:0.8em; padding:4px 10px;">
                        ${statusLabel}
                   </button>
                </td>
                <td class="delete-col">
                    <button onclick="deleteGut(${r.row})" style="background:#dc3545; font-size:11px; padding:6px;">å‰Šé™¤</button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¬ãƒƒãƒˆè¾¼ã¿ vs æŒã¡è¾¼ã¿ï¼‰
        async function toggleGutStatus(row, makePaid) {
            showLoading(true);
            const newStatus = makePaid ? "æ”¯æ‰•ã„æ¸ˆã¿" : "æœªæ‰•ã„";
            const res = await callGas('updateGutStatus', { row: row, status: newStatus });
            showLoading(false);
            if (res) {
                loadGutList(true);
            } else {
                alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // ã‚¬ãƒƒãƒˆç™»éŒ²é€ä¿¡
        async function submitGut() {
            const name = document.getElementById("gutNameSelect").value;
            const date = document.getElementById("gutDate").value;
            const count = document.getElementById("gutCount").value;
            const tension = document.getElementById("gutTension").value;

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å€¤å–å¾—
            let option = "included";
            const radios = document.getElementsByName("gutOption");
            for (const r of radios) { if (r.checked) option = r.value; }

            if (!name || !date || !tension) return alert("æ°åãƒ»æ—¥ä»˜ãƒ»ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            showLoading(true);
            const res = await callGas('saveGut', {
                name, date, count, tension, type: option
            });
            showLoading(false);

            if (res) {
                alert(res);
                // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
                document.getElementById("gutTension").value = "";
                loadGutList(); // ãƒªã‚¹ãƒˆæ›´æ–°
            }
        }

        // ã‚¬ãƒƒãƒˆå±¥æ­´å‰Šé™¤
        async function deleteGut(row) {
            if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            showLoading(true);
            const res = await callGas('deleteGut', { row });
            showLoading(false);
            if (res) {
                alert(res);
                loadGutList();
            }
        }

    </script>

    <div id="appLoginModal" class="login-overlay">
        <div class="login-box">
            <span class="login-icon">ğŸ”’</span>
            <div class="login-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            <input type="tel" id="appPassInput" class="pass-input" placeholder="****" maxlength="8">
            <button class="login-btn" onclick="verifyAppLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <div id="taskLoginModal" class="login-overlay" style="background: rgba(0,0,0,0.6);">
        <div class="login-box">
            <div style="text-align:right; margin-bottom:10px;">
                <button onclick="closeTaskLogin()"
                    style="width:auto; margin:0; padding:5px 10px; background:none; color:#999; border:none; box-shadow:none; font-size:1.2em;">âœ•</button>
            </div>
            <span class="login-icon">ğŸ“Š</span>
            <div class="login-title">èª²é¡Œç®¡ç†ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
            <input type="tel" id="taskPassInput" class="pass-input" placeholder="****" maxlength="8">
            <button class="login-btn" onclick="verifyTaskLogin()" style="background:#1976D2;">ç¢ºèª</button>
        </div>
    </div>

</body>

</html>
