<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥å¥ˆå·çœŒå°å­¦ç”Ÿãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³é€£ç›Ÿ ç™»éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; }
        .menu-list .list-group-item { cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
        .menu-list .list-group-item:hover { background-color: #f8f9fa; }
        .menu-list .list-group-item.active { background-color: #e7f1ff; color: #0d6efd; border-left-color: #0d6efd; border-color: #dee2e6; font-weight: bold; }
        .main-content-card { min-height: 500px; border-top: 4px solid #0d6efd; }
        .auth-tab { cursor: pointer; padding: 10px; border-bottom: 2px solid transparent; width: 50%; text-align: center; }
        .auth-tab.active { border-bottom: 3px solid #0d6efd; color: #0d6efd; font-weight: bold; background-color: #f8f9fa;}
        .univ-list-container { max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 0.375rem; }
        .univ-list-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .univ-list-item:hover { background-color: #e9ecef; }
        .univ-list-item.selected { background-color: #cfe2ff; color: #084298; font-weight: bold; }
        .payment-box { background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 8px; padding: 15px; margin-top: 20px; }
        .payment-id { font-family: monospace; font-size: 1.8rem; font-weight: bold; letter-spacing: 3px; background: white; padding: 5px 20px; border-radius: 5px; border: 2px solid #ffc107; display: inline-block; color: #000; }
        
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .receipt-preview { max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px; }
        .receipt-area { background-color: #fff; border: 2px dashed #bbb; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .badge-uploaded { background-color: #198754; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; }
        .badge-missing { background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; }

        .save-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; }
        .excel-upload-area { background-color: #f1f8ff; border: 2px dashed #0d6efd; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .count-input-group { background: #fff; padding: 15px; border: 1px solid #dee2e6; border-radius: 6px; }

        /* æ±ºç®—æ›¸ãƒ»é ˜åæ›¸ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .report-container { background-color: white; padding: 40px; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2px solid #000; table-layout: fixed; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 10px 15px; vertical-align: middle; word-wrap: break-word; }
        .report-table th { background-color: #f2f2f2; text-align: center; font-weight: bold; border-bottom: 2px solid #000; }
        .report-table tfoot th, .report-table tfoot td { border-top: 2px solid #000; background-color: #f9f9f9; font-weight: bold; }
        .report-table .col-item { width: 30%; }
        .report-table .col-detail { width: 50%; font-size: 0.9rem; }
        .report-table .col-price { width: 20%; text-align: right; }
        .memo-box { border: 1px solid #000; padding: 15px; min-height: 150px; border-radius: 4px; white-space: pre-wrap; background: #fff; }

        /* ç®¡ç†è€…ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .status-badge { font-size: 0.8rem; cursor: pointer; display: inline-block; width: 100%; text-align: center; padding: 4px 0; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 2px; }
        .status-none { background-color: #f8f9fa; color: #aaa; } 
        .status-waiting { background-color: #fff3cd; color: #856404; border-color: #ffeeba; } 
        .status-done { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; font-weight: bold; }
        .status-pending { background-color: #fd7e14; color: white; border-color: #e87311; } 
        .receipt-modal-img { max-width: 100%; max-height: 80vh; object-fit: contain; }
        .btn-approve { font-weight: bold; padding: 10px 30px; font-size: 1.1rem; }
        .table-admin th { 
    background-color: #eee !important; /* æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */
    color: #333 !important;            /* æ–‡å­—ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */
    position: sticky; 
    top: 0; 
    z-index: 10; 
    font-size: 0.85rem; 
    white-space: nowrap; 
    border-bottom: 2px solid #ccc;
}
        .table-admin td { vertical-align: middle; font-size: 0.9rem; }
        .univ-name-cell { min-width: 150px; font-weight: bold; }
        .money-cell { font-family: monospace; text-align: right; white-space: nowrap; }
        .password-cell { font-family: monospace; color: #d63384; font-weight: bold; font-size: 0.8rem; }

        /* ãƒãƒ£ãƒƒãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-container { height: 500px; display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 8px; background: #f0f2f5; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; white-space: pre-wrap; position: relative; }
        .msg-mine { align-self: flex-end; background-color: #0d6efd; color: white; border-bottom-right-radius: 2px; }
        .msg-other { align-self: flex-start; background-color: white; color: black; border: 1px solid #e5e5e5; border-bottom-left-radius: 2px; }
        .msg-info { font-size: 0.75rem; margin-top: 4px; opacity: 0.7; text-align: right; }
        .chat-input-area { background: white; padding: 10px; border-top: 1px solid #ddd; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

        /* å°åˆ·è¨­å®š */
        @media print {
            body { background-color: white; color: black; }
            .no-print, .menu-list, .btn, .card-header, .save-area, nav, .payment-box button, .excel-upload-area, .count-input-group, .chat-input-area, .status-badge, .chat-container { display: none !important; }
            .container-fluid, .row, .col-md-9, .col-lg-10 { padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: 100% !important; flex: none !important; }
            .main-content-card { border: none !important; box-shadow: none !important; min-height: 0 !important; }
            .card-body { padding: 0 !important; }
            .report-container { border: none; box-shadow: none; padding: 0; }
            .report-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .page-break { page-break-before: always; }
            
            /* é ˜åæ›¸å°åˆ·æ™‚ã®åˆ¶å¾¡ */
            #receiptModal.show { display: block !important; position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 9999; background: white; }
            #receiptModal.show .modal-dialog { margin: 0; max-width: 100%; }
            #receiptModal.show .modal-content { border: none; box-shadow: none; }
            #receiptModal.show .modal-header, #receiptModal.show .modal-footer { display: none !important; }
            #receiptModal.show .modal-body { padding: 0; }
            .receipt-layout { border: none; padding: 20px; }
            
            /* é ˜åæ›¸ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯ä»–ã‚’éš ã™ */
            body:has(#receiptModal.show) > #app > div > div:not(#receiptModal) { display: none !important; }
        }

        /* é ˜åæ›¸ãƒ»é›»å­å°é‘‘ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .receipt-layout { border: 4px double #333; padding: 40px; color: #000; font-family: "Mincho", serif; position: relative; background: white; }
        .receipt-title { font-size: 2rem; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; display: inline-block; padding: 0 20px; }
        .receipt-amount { font-size: 2.5rem; font-weight: bold; text-align: center; margin: 20px 0; border-bottom: 1px solid #000; }
        .receipt-detail { margin-top: 20px; font-size: 1.1rem; line-height: 1.8; }
        .issuer-info { margin-top: 40px; text-align: right; position: relative; }
        .hanko-box { position: absolute; right: 0; top: 0; width: 90px; height: 90px; opacity: 0.85; transform: rotate(-2deg); user-select: none; }
        @media print { .hanko-box { opacity: 1; -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
[v-cloak] { display: none !important; }

/* â–¼â–¼â–¼ IDã‚«ãƒ¼ãƒ‰ç”Ÿæˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç¸¦å‹å¤§åˆ¤ãƒ»é€£ç›Ÿåå¼·èª¿ç‰ˆï¼‰ â–¼â–¼â–¼ */
.id-card-wrapper {
    position: fixed; top: -9999px; left: -9999px; /* ç”»é¢å¤–ã«éš ã™ */
}

.id-card {
    width: 680px;   /* æ¨ªå¹… */
    height: 1000px; /* é«˜ã•ï¼ˆç¸¦é•·å¤§åˆ¤ã‚µã‚¤ã‚ºï¼‰ */
    
    /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
    background: linear-gradient(160deg, #0d47a1 0%, #1976d2 60%, #42a5f5 100%);
    color: white;
    font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif;
    position: relative;
    padding: 40px;
    box-sizing: border-box;
    border-radius: 0; /* å°åˆ·ç”¨ãªã®ã§è§’ä¸¸ãªã—ã€ã¾ãŸã¯å°ã•ã */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    text-align: center; /* åŸºæœ¬ã‚»ãƒ³ã‚¿ãƒ¼æƒãˆ */
    border: 1px solid #ddd;
}

/* èƒŒæ™¯ã®é€ã‹ã— */
.id-card::before {
    content: "OFFICIAL COACH";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) rotate(-60deg); /* è§’åº¦ã‚’ãã¤ã */
    font-size: 110px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.05);
    white-space: nowrap;
    pointer-events: none;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆé€£ç›Ÿåãªã©ï¼‰ */
.card-header-area {
    border-bottom: 3px solid rgba(255,255,255,0.3);
    padding-bottom: 25px;
    display: flex;
    flex-direction: column; /* ç¸¦ä¸¦ã³ */
    align-items: center;
    gap: 15px;
}

/* â˜…â˜…â˜… é€£ç›Ÿåã‚’å¤§ããå¼·èª¿ â˜…â˜…â˜… */
.assoc-name {
    font-size: 100px; /* 46pxã‹ã‚‰å¤§å¹…ã‚¢ãƒƒãƒ— */
    font-weight: 900;
    letter-spacing: 15px; /* æ–‡å­—é–“éš”ã‚’åºƒã’ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹ */
    line-height: 1.2;
    text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
    width: 100%;
    margin-top: 20px;
}

.card-title-box {
    background: rgba(255,255,255,0.25);
    color: #fff;
    padding: 8px 40px;
    border-radius: 50px;
    font-weight: bold;
    font-size: 38px; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚‚å°‘ã—å¤§ãã */
    border: 2px solid rgba(255,255,255,0.6);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* ãƒœãƒ‡ã‚£ã‚¨ãƒªã‚¢ï¼ˆãƒãƒ¼ãƒ ãƒ»æ°åï¼‰ */
.card-body-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px 0 !important;
}

.team-name {
    font-size: 52px !important; /* 42pxã‹ã‚‰ã‚¢ãƒƒãƒ— */
    margin-bottom: 10px;
}

.coach-name {
    font-size: 94px; /* åå‰ã‚’ç‰¹å¤§ã« */
    font-weight: bold;
    margin-bottom: 20px !important;
    line-height: 1.1;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
    border-bottom: 2px solid rgba(255,255,255,0.3);
    padding-bottom: 10px;
    width: 90%;
}

.meta-info {
    display: flex;
    flex-direction: column; /* æƒ…å ±ã‚‚ç¸¦ä¸¦ã³ */
    gap: 10px;
    margin-top: 10px;
}
.meta-item {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 15px;
}
.meta-item label {
    font-size: 28px !important; /* 20pxã‹ã‚‰ã‚¢ãƒƒãƒ— */
}
.meta-item div {
    font-size: 48px !important; /* 36pxã‹ã‚‰ã‚¢ãƒƒãƒ— */
}
/* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆè³‡æ ¼ãƒ»æœŸé™ï¼‰ */
.card-footer-area {
    display: flex;
    flex-direction: column; /* ç¸¦ä¸¦ã³ */
    align-items: center;
    gap: 20px;
    background: rgba(0,0,0,0.25);
    margin: -40px; /* è¦ªã®paddingã‚’æ‰“ã¡æ¶ˆã—ã¦ç«¯ã¾ã§åºƒã’ã‚‹ */
    margin-top: 0;
    padding: 30px;
    backdrop-filter: blur(10px);
}

.license-badges {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

.badge-license {
    padding: 15px 35px !important;
    font-size: 32px !important; /* 26pxã‹ã‚‰ã‚¢ãƒƒãƒ— */
    border-width: 3px !important; /* æ ç·šã‚’å¤ªã */
}
.badge-coach { 
    background: #fff;       /* èƒŒæ™¯ã¯ç™½ */
    color: #0d47a1;         /* â˜…æ–‡å­—è‰²ã‚’å¯©åˆ¤ã¨åŒã˜é’ã«å¤‰æ›´ */
    border: 2px solid #0d47a1; /* â˜…æ ç·šã‚‚é’ã«å¤‰æ›´ */
}
.badge-umpire { 
    background: #fff; 
    color: #0d47a1; 
    border: 2px solid #0d47a1; 
}

.valid-date {
    text-align: center;
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 10px;
    width: 100%;
}
.valid-label {
    font-size: 24px !important; /* 16pxã‹ã‚‰ã‚¢ãƒƒãƒ— */
    letter-spacing: 4px !important;
}
.valid-value {
    font-size: 46px !important; /* 34pxã‹ã‚‰ã‚¢ãƒƒãƒ— */
}
.print-only-area {
    display: none;
}

@media print {
    /* 1. ç”¨ç´™ã‚µã‚¤ã‚ºã‚’A4ç¸¦ã«å›ºå®š */
    @page {
        size: A4 portrait;
        margin: 10mm; /* ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã®å°åˆ·é™ç•Œã‚’è€ƒæ…®ã—ãŸå¤–ä½™ç™½ */
    }

    /* 2. ç”»é¢ä¸Šã®å…¨è¦ç´ ã‚’éè¡¨ç¤ºã« */
    body * { visibility: hidden; }

    /* 3. å°åˆ·å°‚ç”¨ã‚¨ãƒªã‚¢ã®ã¿è¡¨ç¤ºã—ã€ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ2åˆ—ï¼‰ã‚’é©ç”¨ */
    .print-only-area, .print-only-area * { visibility: visible; }

    .print-only-area {
        display: grid !important;
        grid-template-columns: 1fr 1fr; /* 2åˆ—ä¸¦ã¹ã‚‹ */
        gap: 5mm; /* ã‚«ãƒ¼ãƒ‰åŒå£«ã®éš™é–“ï¼ˆè£æ–­ç”¨ï¼‰ */
        position: absolute;
        top: 0;
        left: 0;
        width: 190mm; /* A4ã®å¹…ã‹ã‚‰ä½™ç™½ã‚’å¼•ã„ãŸã‚µã‚¤ã‚º */
        background: white !important;
        padding: 0;
        margin: 0;
    }

    /* 4. å„ã‚«ãƒ¼ãƒ‰ã®æ ï¼ˆA4ã®ç´„1/4ã‚µã‚¤ã‚ºï¼‰ */
    .id-card-print-item {
        width: 90mm;
        height: 132mm; /* 2æ®µä¸¦ã‚“ã§ã‚‚A4ã«åã¾ã‚‹é«˜ã• */
        page-break-inside: avoid;
        display: flex !important;
        justify-content: center;
        align-items: center;
        border: 1px dashed #ccc; /* è£æ–­ã®ç›®å®‰ã«ãªã‚‹è–„ã„ç‚¹ç·š */
        position: relative;
        overflow: hidden;
    }

    /* 5. ã‚«ãƒ¼ãƒ‰è‡ªä½“ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ4æšåã¾ã‚‹ã‚ˆã†ç¸®å°ç‡ã‚’èª¿æ•´ï¼‰ */
    .id-card-print-item .id-card {
        width: 680px !important;
        height: 1000px !important;
        /* A4ã®1/4ã«åã¾ã‚‹ã‚ˆã† 0.47å€ã«ç¸®å° */
        transform: scale(0.47) !important; 
        transform-origin: center center;
        
        position: absolute !important;
        margin: 0 !important;
        border: none !important;
        
        box-shadow: 0 0 0 2px #0d47a1 !important; 
        
        /* æç”»ã®å®‰å®šåŒ–è¨­å®š */
        outline: 1px solid transparent; 
        backface-visibility: hidden;
        
        flex-shrink: 0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* 4æšã”ã¨ã«æ”¹ãƒšãƒ¼ã‚¸ã•ã›ã‚‹åˆ¶å¾¡ */
    .id-card-print-item:nth-child(4n) {
        page-break-after: always;
    }

    /* ä¸è¦ãªè¦ç´ ã®å®Œå…¨æ’é™¤ */
    .id-card-wrapper, .modal, .modal-backdrop, .no-print { display: none !important; }
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
.table-responsive thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa; /* èƒŒæ™¯è‰²ãŒãªã„ã¨ä¸‹ãŒé€ã‘ã¾ã™ */
    box-shadow: inset 0 -1px 0 #dee2e6; /* å¢ƒç•Œç·šã‚’ç¶­æŒ */
}

/* æ¤œç´¢ãƒ’ãƒƒãƒˆæ™‚ã®è¡Œã®è¦–èªæ€§ã‚’ä¸Šã’ã‚‹ */
.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
}

/* è³‡æ ¼ãƒãƒƒã‚¸ã®ã‚µã‚¤ã‚ºå¾®èª¿æ•´ */
.badge {
    letter-spacing: 0.5px;
    padding: 0.4em 0.6em;
}
    </style>
</head>
<body>
    <div id="app" class="container-fluid py-3" style="max-width: 1200px;" v-cloak>
        <div v-if="isLoading" class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p></div>


               
        <div v-else>
            <div v-if="!user && !isAdmin" class="row justify-content-center mt-5">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white p-0">
                            <div class="d-flex"><div class="auth-tab" :class="{active: !isRegisterMode}" @click="isRegisterMode = false">ãƒ­ã‚°ã‚¤ãƒ³</div><div class="auth-tab" :class="{active: isRegisterMode}" @click="toggleRegisterMode">æ–°è¦ç™»éŒ²</div></div>
                        </div>
                        <div class="card-body p-4">
                            <h4 class="text-center mb-4">ç¥å¥ˆå·çœŒå°å­¦ç”Ÿãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³é€£ç›Ÿ</h4>
                            <div v-if="isRegisterMode">
                                <div class="alert alert-light border small mb-3"><i class="bi bi-info-circle"></i> ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¯ãƒ©ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                                <div class="mb-3"><label class="form-label fw-bold">ã‚¯ãƒ©ãƒ–é¸æŠ</label><input type="text" class="form-control mb-2" v-model="searchQuery" placeholder="ã‚¯ãƒ©ãƒ–åã§æ¤œç´¢..."><div class="univ-list-container bg-white"><div v-if="filteredUnivList.length === 0" class="p-3 text-muted text-center small">è©²å½“ãªã—</div><div v-for="univ in filteredUnivList" :key="univ.univ_id" class="univ-list-item d-flex justify-content-between" :class="{ selected: regForm.univ_id === univ.univ_id }" @click="selectUniv(univ)"><span>{{ univ.univ_name }}</span><span class="badge bg-light text-dark border">{{ univ.univ_id }}</span></div></div><div v-if="regForm.univ_id" class="mt-2 p-2 bg-primary bg-opacity-10 border border-primary rounded text-primary text-center">é¸æŠä¸­: <strong>{{ regUnivName }}</strong></div><div v-if="regError" class="mt-2 text-danger small"><i class="bi bi-exclamation-triangle"></i> {{ regError }}</div></div>
                                <div class="mb-4"><label class="form-label fw-bold">ä»£è¡¨è€…æ°å</label><input type="text" v-model="regForm.representative" class="form-control" placeholder="ä¾‹: ç¥å¥ˆå· å¤ªéƒ"></div>
                            </div>
                            <div class="mb-3"><label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="text" v-model="authEmail" class="form-control"></div>
                            <div class="mb-2"><label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)</label><input type="password" v-model="authPass" class="form-control"></div>
                            
                            <button v-if="!isRegisterMode" @click="login" class="btn btn-primary w-100 py-2">ãƒ­ã‚°ã‚¤ãƒ³</button>
                            <button v-else @click="register" class="btn btn-success w-100 py-2" :disabled="!!regError || !regForm.univ_id || !regForm.representative">ç™»éŒ²ã—ã¦é–‹å§‹</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else-if="isAdmin">
                <nav class="navbar navbar-dark bg-dark px-3 mb-3 rounded">
                    <span class="navbar-brand mb-0 h1"><i class="bi bi-speedometer2"></i> ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
                    <div class="d-flex gap-2">

<button class="btn btn-sm btn-info text-white fw-bold" @click="openBroadcastModal">
            <i class="bi bi-megaphone-fill"></i> å…¨å“¡ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        </button>

<button class="btn btn-sm btn-warning fw-bold text-dark" @click="showDeadlineModal = true">
            <i class="bi bi-calendar-event"></i> æœŸé™è¨­å®š
        </button>
                        <button class="btn btn-sm btn-outline-light" @click="downloadAllCSV"><i class="bi bi-file-earmark-spreadsheet"></i> å…¨ãƒ‡ãƒ¼ã‚¿CSV</button>
                        <button class="btn btn-sm btn-danger" @click="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </nav>

                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-folder-fill"></i> å¤§ä¼šãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
                    <div class="card-body">
                        <div class="row align-items-end g-2">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">å¯¾è±¡ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</label>
                                <select v-model="selectedTournament" class="form-select">
                                    <option v-for="(cat, key) in categories" :value="key" :key="key">{{ cat.label }}</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" @click="downloadTournamentZip">
                                        <i class="bi bi-file-earmark-zip-fill"></i> Excelä¸€æ‹¬DL (ZIP)
                                    </button>
                                    <button class="btn btn-outline-dark" @click="downloadTournamentCSV">
                                        <i class="bi bi-file-text"></i> ã“ã®å¤§ä¼šã®CSVå‡ºåŠ›
                                    </button>
                                </div>
                                <div v-if="isZipping" class="text-success small mt-1">
                                    <div class="spinner-border spinner-border-sm" role="status"></div> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ä¸­... (æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 border-info">
    <div class="card-header bg-info text-white fw-bold"><i class="bi bi-megaphone-fill"></i> é€£çµ¡äº‹é …ã®ç®¡ç†</div>
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-3"><input type="date" class="form-control" v-model="adminNews.date"></div>
            <div class="col-md-9"><input type="text" class="form-control" v-model="adminNews.title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«"></div>
            <div class="col-12"><textarea class="form-control" v-model="adminNews.content" rows="3" placeholder="æœ¬æ–‡"></textarea></div>
            
            <div class="col-12">
                <label class="form-label small fw-bold"><i class="bi bi-paperclip"></i> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ï¼ˆè¤‡æ•°å¯ï¼‰</label>
                <input type="file" class="form-control form-control-sm" @change="uploadNewsFile" :disabled="isUploadingNews">
                
                <div v-if="adminNews.files && adminNews.files.length > 0" class="mt-2">
                    <ul class="list-group list-group-sm">
                        <li v-for="(file, fIdx) in adminNews.files" :key="fIdx" class="list-group-item d-flex justify-content-between align-items-center py-1 small">
                            <span><i class="bi bi-file-earmark-check text-success"></i> {{ file.name }}</span>
                            <div class="d-flex gap-2">
                                <a :href="file.url" target="_blank" class="text-decoration-none">ç¢ºèª</a>
                                <button class="btn btn-sm btn-link text-danger p-0" @click="removeAdminNewsFile(fIdx)"><i class="bi bi-x-circle"></i></button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div v-if="isUploadingNews" class="mt-1 small text-primary">
                    <div class="spinner-border spinner-border-sm" role="status"></div> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...
                </div>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-info text-white fw-bold" @click="addNews" :disabled="isUploadingNews || !adminNews.title">ã“ã®å†…å®¹ã§æŠ•ç¨¿ã™ã‚‹</button>
        </div>
        <hr>
        <h6 class="text-muted small">æŠ•ç¨¿æ¸ˆã¿ãƒªã‚¹ãƒˆ</h6>
        <ul class="list-group">
            <li v-for="(n, i) in newsList" :key="i" class="list-group-item d-flex justify-content-between align-items-center py-1">
                <span class="small">
                    <strong>{{ new Date(n.date).toLocaleDateString() }}</strong> : {{ n.title }}
                    <span v-if="n.files && n.files.length > 0" class="badge bg-light text-dark border ms-2">ğŸ“ {{ n.files.length }}</span>
                </span>
                <button class="btn btn-sm btn-outline-danger" @click="deleteNews(i)">å‰Šé™¤</button>
            </li>
        </ul>
    </div>
</div>

<div class="card mb-4 border-dark">
    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-person-vcard-fill"></i> ã‚³ãƒ¼ãƒç™»éŒ²è€… å…¨ä½“ãƒªã‚¹ãƒˆ</span>
        <button class="btn btn-sm btn-outline-light" @click="downloadCoachCSV">CSVå‡ºåŠ›</button>
    </div>
    <div class="card-body">
        <div class="row g-2 mb-3">
            <div class="col-md-6">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" v-model="coachSearchQuery" placeholder="ã‚¯ãƒ©ãƒ–åãƒ»æ°åãƒ»è³‡æ ¼ã§æ¤œç´¢...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <span class="badge bg-secondary">è©²å½“: {{ filteredCoachRows.length }} å / å…¨ä½“: {{ totalCoachCount }} å</span>
            </div>
        </div>

        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-sm table-hover table-bordered border mb-0">
                <thead class="table-light sticky-top" style="z-index: 20;">
                    <tr class="small text-center align-middle">
                        <th>æ‰€å±ã‚¯ãƒ©ãƒ–</th><th>æ°å</th><th>BAJ ID</th><th>è³‡æ ¼</th><th>æœŸé™</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="c in filteredCoachRows" :key="c.idKey" class="align-middle">
                        <td class="small">{{ c.univ_name }}</td>
                        <td class="fw-bold text-nowrap">{{ c.name }}</td>
                        <td class="text-center font-monospace">{{ c.bajId || '-' }}</td>
                        <td class="text-center">
    <span v-if="c.license" class="badge bg-warning text-dark me-1" style="font-size: 0.75rem;">{{ c.license }}</span>
    <span v-if="c.umpireLevel" class="badge bg-info text-white" style="font-size: 0.75rem;">
        {{ c.umpireLevel }}ç´šå¯©åˆ¤
    </span>
    <span v-else-if="c.hasUmpire" class="badge bg-info text-white" style="font-size: 0.75rem;">
        3ç´šå¯©åˆ¤
    </span>
</td>
                        <td class="text-center small">{{ c.expireDate }}</td>
                    </tr>
                    <tr v-if="filteredCoachRows.length === 0">
                        <td colspan="5" class="text-center py-4 text-muted small">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
                <div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card text-bg-primary h-100">
            <div class="card-body text-center">
                <h6 class="card-title opacity-75">ç™»éŒ²ã‚¯ãƒ©ãƒ–æ•°</h6>
                <h2 class="card-text">{{ adminRecords.length }} <small class="fs-6">å›£ä½“</small></h2>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100 border-secondary">
            <div class="card-body">
                <h6 class="card-title text-muted">ãƒ•ã‚£ãƒ«ã‚¿</h6>
                <select class="form-select form-select-sm mt-2" v-model="adminSearchQuery">
    <option value="">å…¨ã¦ã®ãƒãƒ¼ãƒ ã‚’è¡¨ç¤º</option>
    <option v-for="rec in adminRecords" :key="rec.univ_id" :value="rec.univ_name">
        {{ rec.univ_id }} : {{ rec.univ_name }}
    </option>
</select>
            </div>
        </div>
    </div>
</div>


                <div class="table-responsive shadow-sm border rounded" style="max-height: 70vh;">
                    <table class="table table-hover table-admin mb-0">
                        <thead><tr>
                            <th>ID</th><th>ã‚¯ãƒ©ãƒ–å</th><th>ä»£è¡¨è€…</th><th>é€£çµ¡</th><th>è«‹æ±‚åˆè¨ˆ</th>
                            <th>â‘ ç™»éŒ²</th><th>â‘¡è¬›ç¿’ä¼š</th><th>â‘¢ãƒŸãƒƒã‚¯ã‚¹ï¼†ãƒ“ã‚®ãƒŠãƒ¼</th><th>â‘£è‹¥è‘‰</th><th>â‘¤ABC</th>
                            <th>â‘¥å¯©åˆ¤</th><th>â‘¦ä¼šé•·æ¯</th><th>â‘§é–¢æ±</th><th>â‘¨æ–°äºº</th><th>â‘©é€£ç›Ÿè¤‡</th><th>â‘ªè¿½åŠ </th>
                            <th>å‚™è€ƒãƒ»é€£çµ¡</th>
                        </tr></thead>
                        <tbody>
                            <tr v-for="rec in filteredAdminRecords" :key="rec.univ_id">
                                <td>{{ rec.univ_id }}</td>
                                <td class="univ-name-cell">{{ rec.univ_name }}</td>
                                <td style="font-size:0.85rem;">{{ rec.raw_data.representative || '-' }}</td>
                                <td>
                                    <button class="btn btn-sm position-relative" :class="unreadStatus[rec.univ_id] ? 'btn-primary' : 'btn-outline-primary'" @click="openAdminChat(rec)">
                                        <i class="bi bi-chat-dots-fill"></i> ãƒãƒ£ãƒƒãƒˆ
                                        <span v-if="unreadStatus[rec.univ_id]" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                            ! <span class="visually-hidden">unread</span>
                                        </span>
                                    </button>
                                </td>
                                <td class="money-cell fw-bold text-primary" :title="rec.cost_detail" style="cursor: help; text-decoration: underline dotted;">{{ formatMoney(rec.total_cost) }}</td>
                                
                                <td v-for="key in adminStatusKeys" :key="key" style="min-width: 90px;">
                                    <div :class="['status-badge', getAdminStatusClass(rec[key])]">
                                        <div v-if="rec[key].hasReceipt">
                                            <button class="btn btn-link p-0 text-decoration-none fw-bold" :class="rec[key].confirmed ? 'text-success' : 'text-white'" @click="showReceipt(rec, key)">
                                                <i class="bi" :class="rec[key].confirmed ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'"></i> {{ rec[key].confirmed ? 'æ‰¿èªæ¸ˆ' : 'ç¢ºèª' }}
                                            </button>
                                        </div>
                                        <div v-else>
                                            <button class="btn btn-link p-0 text-decoration-none fw-bold" :class="rec[key].confirmed ? 'text-success' : 'text-muted'" @click="togglePaymentStatus(rec, key)">
                                                <i class="bi" :class="rec[key].confirmed ? 'bi-check-circle-fill' : 'bi-circle'"></i> {{ rec[key].confirmed ? 'æ‰¿èªæ¸ˆ' : 'æœªæ‰¿èª' }}
                                            </button>
                                            <div class="small mt-1" style="font-size:0.75rem;">ID: {{ rec[key].paymentId }}</div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-1">
                                        <a v-if="rec[key].rawObj.excel_url" :href="rec[key].rawObj.excel_url" target="_blank" class="btn btn-sm btn-outline-success py-0" style="font-size: 0.7rem;"><i class="bi bi-file-earmark-excel-fill"></i> ç”³è¾¼æ›¸DL</a>
                                        <button v-else-if="rec[key].rawObj && (rec[key].rawObj.excel_url)" class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.7rem;" @click="openDetailModal(rec, key)"><i class="bi bi-list-ul"></i> è©³ç´°</button>
                                    </div>
                                </td>
                                <td style="max-width: 200px;">
                                    <div class="text-truncate small" :title="rec.memo">{{ rec.memo }}</div>
                                    <button class="btn btn-sm btn-outline-danger mt-1 w-100" @click="sendAlertEmail(rec)"><i class="bi bi-envelope"></i> ä¸å‚™é€£çµ¡</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="modal.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header"><h5 class="modal-title">{{ modal.univName }} - {{ getCategoryName(modal.category) }}</h5><button type="button" class="btn-close" @click="closeModal"></button></div>
                            <div class="modal-body text-center bg-dark"><img :src="modal.url" class="receipt-modal-img"></div>
                            <div class="modal-footer justify-content-between">
                                <div><a :href="modal.url" target="_blank" class="btn btn-outline-light btn-sm text-dark border-secondary">å…ƒç”»åƒã‚’é–‹ã</a></div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-secondary" @click="closeModal">é–‰ã˜ã‚‹</button>
                                    <button v-if="!modal.targetRecord[modal.category].confirmed" class="btn btn-success btn-approve" @click="toggleApproval(true)"><i class="bi bi-check-lg"></i> æŒ¯è¾¼ã‚’ç¢ºèªãƒ»æ‰¿èªã™ã‚‹</button>
                                    <button v-else class="btn btn-outline-danger" @click="toggleApproval(false)">æ‰¿èªã‚’å–ã‚Šæ¶ˆã™</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="adminChatModal.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-chat-dots"></i> ãƒãƒ£ãƒƒãƒˆ: {{ adminChatModal.univName }}</h5>
                                <button type="button" class="btn-close btn-close-white" @click="adminChatModal.show = false"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="chat-container">
                                    <div class="chat-messages" id="adminChatBox">
                                        <div v-if="chatMessages.length === 0" class="text-center text-muted mt-5">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                                        <div v-for="(msg, idx) in chatMessages" :key="idx" :class="['message-bubble', msg.sender === 'admin' ? 'msg-mine' : 'msg-other']">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div style="word-break: break-word;">{{ msg.content }}</div>
                                                <button class="btn btn-link text-danger p-0 ms-2" style="font-size: 0.8rem; text-decoration: none;" @click="deleteChat(msg)"><i class="bi bi-trash"></i></button>
                                            </div>
                                            <div class="msg-info">{{ formatTimestamp(msg.timestamp) }}</div>
                                        </div>
                                    </div>
                                    <div class="chat-input-area d-flex gap-2">
                                        <textarea v-model="chatInput" class="form-control" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." @keypress.enter.prevent="sendChat('admin')"></textarea>
                                        <button class="btn btn-primary" @click="sendChat('admin')"><i class="bi bi-send"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom no-print">
                    <div>
                        <h4 class="m-0 d-inline-block me-3">ç™»éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h4>
                        <span class="badge bg-secondary me-2">{{ form.univ_name }}</span>
                        <span class="small text-muted" v-if="form.representative">({{ form.representative }})</span>
                    </div>
                    <div><span class="me-3 small text-muted">{{ user.email }}</span><button @click="logout" class="btn btn-outline-danger btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
                </div>

                <div class="row">
                    <div class="col-md-3 col-lg-2 mb-4 no-print">
                        <div class="list-group menu-list shadow-sm mt-3">
    <button class="list-group-item list-group-item-action fw-bold" :class="{active: activeTab === 'home'}" @click="activeTab = 'home'"><i class="bi bi-house-door-fill"></i> ãƒ›ãƒ¼ãƒ  (é€£çµ¡äº‹é …)</button>
    <div class="list-group-item bg-light fw-bold text-muted small">ç”³è«‹ãƒ»ç”³è¾¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    
    <button v-for="(cat, key) in categories" :key="key" 
        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
        :class="{active: activeTab === key}" 
        @click="activeTab = key">
        
        <span>{{ cat.label }}</span>
        
        <span v-if="deadlines[key]" class="badge rounded-pill" style="font-size: 0.75rem;"
              :class="isExpired(key) ? 'text-bg-danger' : 'text-bg-light border text-dark'">
            {{ new Date(deadlines[key]).toLocaleDateString().slice(5) }} ã¾ã§
        </span>
    </button>
    
    <div class="list-group-item bg-light fw-bold text-muted small mt-2">äº¤æµãƒ»å‹Ÿé›†</div>
    <button class="list-group-item list-group-item-action fw-bold text-success" 
            :class="{active: activeTab === 'recruit'}" 
            @click="activeTab = 'recruit'">
        <i class="bi bi-people-fill"></i> â‘« ãƒšã‚¢å‹Ÿé›†æ²ç¤ºæ¿
    </button>

<button class="list-group-item list-group-item-action fw-bold text-dark" 
    :class="{active: activeTab === 'coach_reg'}" 
    @click="activeTab = 'coach_reg'">
    <i class="bi bi-person-badge-fill"></i> â‘¬ ã‚³ãƒ¼ãƒç™»éŒ²ãƒ»IDè¨¼
</button>

    <div class="list-group-item bg-light fw-bold text-muted small mt-2">è¨­å®šãƒ»ãã®ä»–</div>
    


                            <button class="list-group-item list-group-item-action" :class="{active: activeTab === 'settlement'}" @click="activeTab = 'settlement'">â‘­ æ”¯æ‰•æ˜ç´°</button>
                            <button class="list-group-item list-group-item-action" :class="{active: activeTab === 'account'}" @click="activeTab = 'account'">â‘® ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</button>
                            <button class="list-group-item list-group-item-action fw-bold text-primary d-flex justify-content-between align-items-center" :class="{active: activeTab === 'chat'}" @click="activeTab = 'chat'; userHasUnread = false;">
                                <span><i class="bi bi-chat-dots-fill"></i> â‘¯ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (é‹å–¶ã¸é€£çµ¡)</span>
                                <span v-if="userHasUnread" class="badge bg-danger rounded-pill">!</span>
                            </button>

                        </div>
                    </div>

<div class="col-md-9 col-lg-10 mb-5">
    <div class="card shadow-sm main-content-card">
        <div class="card-body p-4">

            <div v-if="activeTab === 'home'">
    <h4 class="mb-4 text-primary"><i class="bi bi-info-circle-fill"></i> é€£çµ¡äº‹é …ãƒ»ãƒ‹ãƒ¥ãƒ¼ã‚¹</h4>
    <div v-if="newsList.length === 0" class="alert alert-secondary">ç¾åœ¨ã€é€£çµ¡äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    <div v-else class="list-group">
        <div v-for="(news, idx) in newsList" :key="idx" class="list-group-item shadow-sm mb-3 border-start border-4 border-primary">
            <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1 fw-bold text-dark">{{ news.title }}</h5>
                <small class="text-muted">{{ new Date(news.date).toLocaleDateString() }}</small>
            </div>
            <p class="mb-2 mt-2" style="white-space: pre-wrap; line-height: 1.6;">{{ news.content }}</p>
            
            <div v-if="news.files && news.files.length > 0" class="mt-3 border-top pt-2">
                <div class="small fw-bold text-muted mb-2"><i class="bi bi-paperclip"></i> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:</div>
                <div class="d-flex flex-wrap gap-2">
                    <a v-for="(file, fIdx) in news.files" :key="fIdx" :href="file.url" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-file-earmark-text"></i> {{ file.name || 'ãƒ•ã‚¡ã‚¤ãƒ«' + (fIdx + 1) }}
                    </a>
                </div>
            </div>
            <div v-else-if="news.url" class="mt-2 border-top pt-2">
                <a :href="news.url" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-paperclip"></i> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>
            </div>
        </div>
    </div>
</div>

            <div v-if="activeTab === 'chat'">
                <h4 class="mb-4 text-primary"><i class="bi bi-chat-dots-fill"></i> é‹å–¶ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>
                <div class="alert alert-info small"><i class="bi bi-info-circle"></i> å€‹åˆ¥ã®é€£çµ¡ã‚„è³ªå•ã¯ã“ã¡ã‚‰ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</div>
                <div class="chat-container">
                    <div class="chat-messages" id="userChatBox">
                        <div v-if="chatMessages.length === 0" class="text-center text-muted mt-5">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                        <div v-for="(msg, idx) in chatMessages" :key="idx" :class="['message-bubble', msg.sender !== 'admin' ? 'msg-mine' : 'msg-other']">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="word-break: break-word;">{{ msg.content }}</div>
                                <button v-if="msg.sender !== 'admin'" class="btn btn-link text-danger p-0 ms-2" style="font-size: 0.8rem; text-decoration: none;" @click="deleteChat(msg)"><i class="bi bi-trash"></i></button>
                            </div>
                            <div class="msg-info">{{ formatTimestamp(msg.timestamp) }}</div>
                        </div>
                    </div>
                    <div class="chat-input-area d-flex gap-2">
                        <textarea v-model="chatInput" class="form-control" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." @keypress.enter.prevent="sendChat('user')"></textarea>
                        <button class="btn btn-primary" @click="sendChat('user')"><i class="bi bi-send"></i></button>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'recruit'">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="text-success mb-0"><i class="bi bi-people-fill"></i> ãƒšã‚¢å‹Ÿé›†æ²ç¤ºæ¿</h4>
                        <small class="text-muted">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’æ¢ã—ã¦ã€ç›´æ¥ãƒãƒ£ãƒƒãƒˆã§é€£çµ¡ã‚’å–ã‚Šåˆãˆã¾ã™</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success position-relative" @click="showDirectChatList = true">
                            <i class="bi bi-envelope-paper"></i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
                        </button>
                        <button class="btn btn-success fw-bold" @click="openRecruitModal">
                            <i class="bi bi-pencil-square"></i> å‹Ÿé›†ã™ã‚‹
                        </button>
                    </div>
                </div>
            
                <div class="row g-3">
                    <div v-if="recruitList.length === 0" class="col-12 text-center text-muted py-5">
                        ç¾åœ¨ã€å‹Ÿé›†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                    </div>
            
                    <div v-for="item in recruitList" :key="item.id" class="col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm" :class="item.univ_id === form.univ_id ? 'border-primary' : 'border-success'">
                            <div class="card-header d-flex justify-content-between align-items-center" 
                                 :class="item.univ_id === form.univ_id ? 'bg-primary text-white' : 'bg-success text-white'">
                                <span class="badge bg-white" :class="item.univ_id === form.univ_id ? 'text-primary' : 'text-success'">
                                    {{ getCategoryLabel(item.category) }}
                                </span>
                                <small>{{ item.timestamp ? new Date(item.timestamp.toDate()).toLocaleDateString() : 'æ—¥æ™‚ä¸æ˜' }}</small>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title fw-bold mb-1">{{ item.univ_name }}</h5>
                        
                        <div class="mb-2">
                            <span class="badge me-1" :class="item.player_gender === 'å¥³' ? 'bg-danger' : 'bg-primary'">
                                {{ item.player_gender || '-' }}
                            </span>
                            <span class="badge bg-light text-dark border me-2">
                                {{ item.player_grade || '-' }}
                            </span>
                            <span class="fw-bold fs-5">{{ item.player_name || 'åç§°æœªè¨­å®š' }}</span>
                        </div>
                        <div class="badge bg-warning text-dark border border-dark mb-2">{{ item.level }}</div>
                        <p class="card-text small bg-light p-2 rounded" style="white-space: pre-wrap; min-height: 60px;">{{ item.comment }}</p>
                        
                        <div class="mt-3 text-center">
                            <button v-if="item.univ_id !== form.univ_id" class="btn btn-outline-success w-100 fw-bold" @click="openDirectChat(item.univ_id, item.univ_name)">
                                <i class="bi bi-chat-dots-fill"></i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
                            </button>
                            <button v-else class="btn btn-sm btn-outline-danger w-100" @click="deleteRecruit(item.id)">
                                <i class="bi bi-trash"></i> å‹Ÿé›†ã‚’å‰Šé™¤
                            </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <template v-for="(catName, catKey) in categories" :key="catKey">
                <div v-if="activeTab === catKey">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-primary"><i class="bi bi-folder2-open"></i> {{ catName.label }}</h4>
                    </div>

                    <div class="alert alert-info small"><i class="bi bi-exclamation-circle-fill"></i> ç”³è¾¼ç”¨ç´™(Excel)ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€å†…è¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
                    
                    <div class="excel-upload-area">
                        <label class="form-label fw-bold">ç”³è¾¼ãƒ•ã‚¡ã‚¤ãƒ«(Excel)ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                        <div v-if="entry[catKey].excel_url" class="mt-3">
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <span class="badge bg-success"><i class="bi bi-file-earmark-excel"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿</span>
                                <button class="btn btn-sm btn-outline-danger" @click="deleteExcel(catKey)">
                                    <i class="bi bi-trash"></i> å‰Šé™¤
                                </button>
                            </div>
                            <a :href="entry[catKey].excel_url" target="_blank" class="d-block mt-1 small">ç¢ºèªã™ã‚‹</a>
                        </div>
                        <div v-else>
                            <input type="file" class="form-control w-75 mx-auto" accept=".xlsx, .xls" @change="uploadExcel($event, catKey)">
                            <div v-if="isUploading" class="spinner-border spinner-border-sm mt-2 text-primary"></div>
                        </div>
                    </div>

                    <div class="count-input-group mb-4">
                        <h6 class="border-bottom pb-2 mb-3">å‚åŠ ãƒ»ç™»éŒ²æ•° å…¥åŠ›</h6>
                        <div class="row g-3">
                            <div v-if="catKey === 'reg_fee'" class="row g-3"><div class="col-md-6"><label>é¸æ‰‹ç™»éŒ² (Â¥1,500)</label><div class="input-group"><input type="number" v-model.number="entry.reg_fee.count_player" class="form-control" min="0"><span class="input-group-text">å</span></div></div><div class="col-md-6"><label>æŒ‡å°è€…ç™»éŒ² (Â¥1,500)</label><div class="input-group"><input type="number" v-model.number="entry.reg_fee.count_coach" class="form-control" min="0"><span class="input-group-text">å</span></div></div></div>
                            <div v-if="catKey === 'training'" class="row g-3"><div class="col-md-4"><label>ä¸€èˆ¬ (Â¥5,000)</label><div class="input-group"><input type="number" v-model.number="entry.training.count_general" class="form-control" min="0"><span class="input-group-text">å</span></div></div><div class="col-md-4"><label>æŒ‡å°è€…ä¼šå“¡ (Â¥3,000)</label><div class="input-group"><input type="number" v-model.number="entry.training.count_member" class="form-control" min="0"><span class="input-group-text">å</span></div></div><div class="col-md-4"><label>å°ä¸­é«˜ç”Ÿ (Â¥500)</label><div class="input-group"><input type="number" v-model.number="entry.training.count_student" class="form-control" min="0"><span class="input-group-text">å</span></div></div></div>
                            
<div v-if="catKey === 'class_tourney'" class="row g-3">
    <div class="col-md-6"><label>ãƒ“ã‚®ãƒŠãƒ¼ã‚º (Â¥2,000/äºº)</label><div class="input-group"><input type="number" v-model.number="entry.class_tourney.count_beginner" class="form-control" min="0"><span class="input-group-text">å</span></div></div>
    <div class="col-md-6"><label>ãƒŸãƒƒã‚¯ã‚¹è¤‡ (Â¥4,000/çµ„)</label><div class="input-group"><input type="number" v-model.number="entry.class_tourney.count_mix" class="form-control" min="0"><span class="input-group-text">çµ„</span></div></div>
</div>
                            <div v-if="catKey === 'wakaba'" class="row g-3"><div class="col-md-6"><label>å‚åŠ ãƒãƒ¼ãƒ  (Â¥15,000)</label><div class="input-group"><input type="number" v-model.number="entry.wakaba.count_team" class="form-control" min="0"><span class="input-group-text">ãƒãƒ¼ãƒ </span></div></div></div>
                            <div v-if="catKey === 'abc'" class="row g-3"><div class="col-md-6"><label>ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (Â¥2,000)</label><div class="input-group"><input type="number" v-model.number="entry.abc.count_single" class="form-control" min="0"><span class="input-group-text">å</span></div></div></div>
                            <div v-if="catKey === 'umpire'" class="row g-3"><div class="col-md-6"><label>å—è¬›è€…æ•° (Â¥1,000)</label><div class="input-group"><input type="number" v-model.number="entry.umpire.count_person" class="form-control" min="0"><span class="input-group-text">å</span></div></div></div>
                            <div v-if="catKey === 'chairman'" class="row g-3"><div class="col-md-6"><label>ãƒ€ãƒ–ãƒ«ã‚¹ (Â¥4,000)</label><div class="input-group"><input type="number" v-model.number="entry.chairman.count_double" class="form-control" min="0"><span class="input-group-text">çµ„</span></div></div></div>
                            <div v-if="catKey === 'kanto'" class="row g-3"><div class="col-md-6"><label>ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (Â¥2,500)</label><div class="input-group"><input type="number" v-model.number="entry.kanto.count_single" class="form-control" min="0"><span class="input-group-text">å</span></div></div><div class="col-md-6"><label>ãƒ€ãƒ–ãƒ«ã‚¹ (Â¥5,000)</label><div class="input-group"><input type="number" v-model.number="entry.kanto.count_double" class="form-control" min="0"><span class="input-group-text">çµ„</span></div></div></div>
                            <div v-if="catKey === 'rookie'" class="row g-3"><div class="col-md-6"><label>ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (Â¥2,000)</label><div class="input-group"><input type="number" v-model.number="entry.rookie.count_single" class="form-control" min="0"><span class="input-group-text">å</span></div></div></div>
                            <div v-if="catKey === 'fed_doubles'" class="row g-3"><div class="col-md-6"><label>ãƒ€ãƒ–ãƒ«ã‚¹ (Â¥4,000)</label><div class="input-group"><input type="number" v-model.number="entry.fed_doubles.count_double" class="form-control" min="0"><span class="input-group-text">çµ„</span></div></div></div>

                            <div v-if="catKey === 'add_reg'" class="row g-3">
                                <div class="col-12 mb-4" v-if="entry.add_reg.history && entry.add_reg.history.length > 0">
                                    <div class="card bg-light border-primary">
                                        <div class="card-header bg-primary text-white small py-1">
                                            <i class="bi bi-list-check"></i> è¿½åŠ ç™»éŒ²æ¸ˆã¿ãƒªã‚¹ãƒˆ ({{ entry.add_reg.history.length }}ä»¶)
                                        </div>
                                        <ul class="list-group list-group-flush">
                                            <li v-for="(item, idx) in entry.add_reg.history" :key="idx" class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-secondary me-2">No.{{ idx + 1 }}</span>
                                                    <span class="fw-bold me-2 text-primary">{{ item.period === 'early' ? 'é–¢æ±å‰' : '1æœˆ' }}</span>
                                                    <span class="small">é¸æ‰‹: <strong>{{ item.count_player }}</strong>å / æŒ‡å°è€…: <strong>{{ item.count_coach }}</strong>å</span>
                                                    <div class="mt-1">
                                                        <a v-if="item.excel_url" :href="item.excel_url" target="_blank" class="btn btn-sm btn-outline-success py-0 me-2" style="font-size: 0.75rem;"><i class="bi bi-file-earmark-excel"></i> Excel</a>
                                                        <a v-if="item.receipt_url" :href="item.receipt_url" target="_blank" class="btn btn-sm btn-outline-warning py-0 text-dark me-2" style="font-size: 0.75rem;"><i class="bi bi-card-image"></i> æŒ¯è¾¼æ˜ç´°</a>
                                                        <button class="btn btn-sm btn-outline-dark py-0" style="font-size: 0.75rem;" @click="openHistoryReceipt(item)"><i class="bi bi-receipt"></i> é ˜åæ›¸</button>
                                                    </div>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger" @click="removeRegHistory(idx)"><i class="bi bi-trash"></i> å‰Šé™¤</button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="p-3 border rounded bg-white shadow-sm position-relative">
                                        <span class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-danger border border-light shadow-sm" style="left: 20px !important;">NEW</span>
                                        <h6 class="mb-3 text-dark fw-bold border-bottom pb-2"><i class="bi bi-plus-circle-fill text-success"></i> æ–°ã—ãè¿½åŠ ç™»éŒ²ã‚’è¡Œã†</h6>
                                        <div class="alert alert-light border small text-muted"><i class="bi bi-info-circle"></i> Excelã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€äººæ•°ã‚’å…¥åŠ›å¾Œã€æŒ¯è¾¼æ˜ç´°ã‚’æ·»ä»˜ã—ã¦ã€Œãƒªã‚¹ãƒˆã«è¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold bg-light p-2 rounded w-100">ç™»éŒ²æ™‚æœŸã‚’é¸æŠ</label>
                                            <div class="d-flex gap-4 ms-2">
                                                <div class="form-check"><input class="form-check-input" type="radio" v-model="entry.add_reg.period" value="early" id="ar1"><label class="form-check-label" for="ar1">é–¢æ±äºˆé¸å‰ã¾ã§ (Â¥1,500)</label></div>
                                                <div class="form-check"><input class="form-check-input" type="radio" v-model="entry.add_reg.period" value="late" id="ar2"><label class="form-check-label" for="ar2">1æœˆ æ–°äººæˆ¦ (Â¥500)</label></div>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6"><label>é¸æ‰‹ç™»éŒ²</label><div class="input-group"><input type="number" v-model.number="entry.add_reg.count_player" class="form-control" min="0"><span class="input-group-text">å</span></div></div>
                                            <div class="col-md-6"><label>æŒ‡å°è€…ç™»éŒ²</label><div class="input-group"><input type="number" v-model.number="entry.add_reg.count_coach" class="form-control" min="0"><span class="input-group-text">å</span></div></div>
                                        </div>

                                        <div class="excel-upload-area mt-3 mb-3" style="background-color: #fff3cd; border-color: #ffc107;">
                                            <label class="form-label fw-bold">æŒ¯è¾¼æ˜ç´°(ç”»åƒ)ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                                            <div v-if="entry.add_reg.receipt_url">
                                                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                                    <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> ç”»åƒã‚»ãƒƒãƒˆå®Œäº†</span>
                                                    <button class="btn btn-sm btn-outline-danger" @click="deleteReceipt('add_reg')"><i class="bi bi-trash"></i> å‰Šé™¤</button>
                                                </div>
                                                <img :src="entry.add_reg.receipt_url" class="receipt-preview" style="max-height: 150px;">
                                            </div>
                                            <div v-else>
                                                <input type="file" class="form-control w-75 mx-auto" accept="image/*" @change="uploadReceipt($event, 'add_reg')">
                                                <div v-if="isUploading" class="spinner-border spinner-border-sm mt-2"></div>
                                                <div class="small text-muted mt-1">â€»Excelã¨ä¸€ç·’ã«ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2 text-center">
                                            <button class="btn btn-success w-75 fw-bold shadow-sm" @click="addRegToHistory" :disabled="!entry.add_reg.excel_url">
                                                <i class="bi bi-arrow-up-circle"></i> å…¥åŠ›å†…å®¹ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹
                                            </button>
                                            <div v-if="!entry.add_reg.excel_url" class="text-danger small mt-2 fw-bold"><i class="bi bi-exclamation-triangle"></i> Excelã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="payment-box">
                        <div class="text-center">
                            <h5 class="text-dark mb-1">åˆè¨ˆæ”¯æ‰•é¡: <strong>{{ formatMoney(calculateCategoryTotal(catKey)) }}</strong></h5>

                            <div class="bg-white rounded border border-warning p-2 my-3 d-inline-block px-4 shadow-sm">
                                <div class="small text-muted border-bottom mb-1 pb-1">æŒ¯è¾¼å…ˆ</div>
                                <div class="fw-bold text-dark fs-5">
                                    ã‚†ã†ã¡ã‚‡éŠ€è¡Œã€€åº—ç•ªï¼š098<br>
                                    æ™®é€šè²¯é‡‘ã€€ç•ªå·ï¼š0334265
                                </div>
                            </div>
                            
                            <p class="mb-2 text-muted small">ä¸‹è¨˜ç•ªå·ã‚’æŒ¯è¾¼åç¾©ã®å‰ã«å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            <div class="payment-id">{{ entry[catKey].payment_id }}</div>
                            <div class="mt-2 text-danger fw-bold">æŒ¯è¾¼åç¾©: {{ entry[catKey].payment_id }} {{ form.univ_name }}</div>
                            
                            <div class="receipt-area" v-if="catKey !== 'add_reg'">
                                <h6 class="small fw-bold mb-3">æŒ¯è¾¼æ˜ç´°ã®å†™çœŸ</h6>
                                <div v-if="entry[catKey].receipt_url">
                                    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                        <span class="badge badge-uploaded"><i class="bi bi-check-circle-fill"></i> ç™»éŒ²æ¸ˆã¿</span>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteReceipt(catKey)">
                                            <i class="bi bi-trash"></i> å‰Šé™¤
                                        </button>
                                    </div>
                                    <div class="mb-3"><img :src="entry[catKey].receipt_url" class="receipt-preview"></div>
                                    <div class="mt-3 border-top pt-2"><button class="btn btn-outline-dark w-100" @click="openReceipt(catKey)"><i class="bi bi-receipt"></i> é ˜åæ›¸ã‚’ç™ºè¡Œ</button></div>
                                </div>
                                <div v-else>
                                    <span class="badge badge-missing mb-2">æœªç™»éŒ²</span>
                                    <div class="mt-2"><input type="file" class="form-control form-control-sm w-75 mx-auto" accept="image/*" @change="uploadReceipt($event, catKey)"><div v-if="isUploading" class="spinner-border spinner-border-sm mt-2"></div></div>
                                </div>
                            </div>
                            <div class="receipt-area" v-else>
                                <div class="alert alert-info small border-0 mb-0">
                                    <i class="bi bi-info-circle-fill"></i> è¿½åŠ ç™»éŒ²ã®æŒ¯è¾¼æ˜ç´°ã¯ã€ä¸Šã®ã€Œè¿½åŠ ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã€å†…ã§Excelã¨ä¸€ç·’ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div> </template> <div v-if="categories[activeTab]" class="save-area">
                <button @click="saveData(false)" class="btn btn-primary btn-lg px-5" :disabled="isSaving">
                    <i class="bi bi-save"></i> ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                </button>
            </div>

            <div v-if="activeTab === 'settlement'">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print"><h4><i class="bi bi-file-earmark-spreadsheet-fill"></i> â‘« æ”¯æ‰•æ˜ç´°</h4><button onclick="window.print()" class="btn btn-dark"><i class="bi bi-printer"></i> å°åˆ· / PDFä¿å­˜</button></div>
                <div class="report-container">
                    <h3 class="text-center mb-4">ä»¤å’Œ7å¹´åº¦ ç¥å¥ˆå·çœŒå°å­¦ç”Ÿãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³é€£ç›Ÿ æ”¯æ‰•æ˜ç´°</h3>
                    <div class="d-flex justify-content-between mb-3"><h5>ã‚¯ãƒ©ãƒ–å: <u>{{ form.univ_name }}</u></h5><h5>æ—¥ä»˜: <u>{{ new Date().toLocaleDateString() }}</u></h5></div>
                    <table class="report-table"><colgroup><col class="col-item"><col class="col-detail"><col class="col-price"></colgroup><thead><tr><th>é …ç›®</th><th>è©³ç´°ãƒ»å†…è¨³</th><th>é‡‘é¡</th></tr></thead>
                        <tbody>
                            <tr v-for="(cat, key) in categories" :key="key"><td>{{ cat.label }}</td><td>{{ generateDetailString(key, entry[key]) }}</td><td class="col-price">{{ formatMoney(calculateCategoryTotal(key)) }}</td></tr>
                        </tbody>
                        <tfoot><tr><th colspan="2" class="text-center fs-5">åˆè¨ˆ</th><th class="col-price fs-4">{{ formatMoney(grandTotal) }}</th></tr></tfoot>
                    </table>
                    <div class="mt-5"><h6>å‚™è€ƒãƒ»æŒ¯è¾¼è¨˜éŒ²</h6><textarea v-model="memo" class="form-control d-print-none" rows="5"></textarea><div class="d-none d-print-block memo-box">{{ memo }}</div><div class="save-area d-print-none"><button @click="saveData" class="btn btn-primary btn-lg px-5">ä¿å­˜</button></div></div>
                </div>
            </div>

            <div v-if="activeTab === 'account'">
                <h4><i class="bi bi-gear-fill"></i> â‘¬ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h4>
                <div class="card mt-4 border-info"><div class="card-header bg-info bg-opacity-10 fw-bold">ç™»éŒ²æƒ…å ±ã®å¤‰æ›´</div><div class="card-body"><div class="mb-3"><label class="form-label fw-bold">ä»£è¡¨è€…æ°å</label><input type="text" v-model="form.representative" class="form-control"></div><button class="btn btn-info text-white fw-bold" @click="saveData(false)">æ°åã‚’æ›´æ–°</button></div></div>
                <div class="card mt-4 border-warning">
                    <div class="card-header bg-warning bg-opacity-10 fw-bold">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</div>
                    <div class="card-body">
                        <div class="mb-3"><label class="form-label">ç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="text" class="form-control" :value="user.email" disabled></div><hr>
                        <div class="mb-3"><label class="form-label fw-bold">æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" v-model="account.newEmail" class="form-control"></div>
                        <div class="mb-3"><label class="form-label fw-bold">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" v-model="account.newPass" class="form-control"></div>
                        <button class="btn btn-warning text-dark fw-bold" @click="updateAccount">å¤‰æ›´å†…å®¹ã‚’ä¿å­˜</button>
                    </div>
                </div>
                <div class="card mt-5 border-danger">
                    <div class="card-header bg-danger text-white fw-bold">é€€ä¼šãƒ»ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</div>
                    <div class="card-body">
                        <p class="text-danger small">â€»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚<br>â€»å†ç™»éŒ²ã™ã‚‹å ´åˆã¯ã€æ–°è¦ç™»éŒ²ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚</p>
                        <button class="btn btn-outline-danger w-100" @click="deleteAccount">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</button>
                    </div>
                </div>
            </div>

        </div> 


<div v-if="showRecruitModal" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square"></i> ãƒšã‚¢ãƒ»ç·´ç¿’ç›¸æ‰‹ã‚’å‹Ÿé›†</h5>
                            <button type="button" class="btn-close btn-close-white" @click="showRecruitModal = false"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select v-model="newRecruit.category" class="form-select">
                        <option v-for="(cat, key) in categories" :value="key" :key="key">{{ cat.label }}</option>
                    </select>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">é¸æ‰‹æ°å</label>
                        <input type="text" class="form-control" v-model="newRecruit.name" placeholder="æ°åã‚’å…¥åŠ›">
                    </div>
                    <div class="col-3">
                        <label class="form-label fw-bold">æ€§åˆ¥</label>
                        <select v-model="newRecruit.gender" class="form-select">
                            <option>ç”·</option>
                            <option>å¥³</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="form-label fw-bold">å­¦å¹´</label>
                        <select v-model="newRecruit.grade" class="form-select">
                            <option>å°1</option><option>å°2</option><option>å°3</option>
                            <option>å°4</option><option>å°5</option><option>å°6</option>
                            <option>ä¸­å­¦</option><option>ãã®ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ãƒ¬ãƒ™ãƒ«æ„Ÿ</label>
                    <select v-model="newRecruit.level" class="form-select">
                        <option>åˆç´šè€…</option>
                        <option>ä¸­ç´šè€…</option>
                        <option>ä¸Šç´šè€…</option>
                        <option>èª°ã§ã‚‚OK</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ã‚³ãƒ¡ãƒ³ãƒˆãƒ»è©³ç´°</label>
                                <textarea v-model="newRecruit.comment" class="form-control" rows="4" placeholder="ä¾‹ï¼šã€‡ã€‡å¤§ä¼šã«å‘ã‘ã¦ãƒ€ãƒ–ãƒ«ã‚¹ã®ãƒšã‚¢ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã‚’å§‹ã‚ã¦1å¹´ç¨‹ã§ã™ã€‚"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @click="showRecruitModal = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="button" class="btn btn-success fw-bold" @click="saveRecruit">æŠ•ç¨¿ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="directChat.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title"><i class="bi bi-chat-dots"></i> {{ directChat.partnerName }} ã•ã‚“ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h5>
                            <button type="button" class="btn-close btn-close-white" @click="directChat.show = false"></button>
                        </div>
                        <div class="modal-body p-0">
                            <div class="chat-container">
                                <div class="chat-messages" id="directChatBox">
                                    <div v-if="directChat.messages.length === 0" class="text-center text-muted mt-5">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                                    <div v-for="(msg, idx) in directChat.messages" :key="idx" :class="['message-bubble', msg.senderId === form.univ_id ? 'msg-mine' : 'msg-other']">
                                        <div style="word-break: break-word;">{{ msg.content }}</div>
                                        <div class="msg-info">{{ formatTimestamp(msg.timestamp) }}</div>
                                    </div>
                                </div>
                                <div class="chat-input-area d-flex gap-2">
                                    <textarea v-model="directChat.input" class="form-control" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." @keypress.enter.prevent="sendDirectChat"></textarea>
                                    <button class="btn btn-success" @click="sendDirectChat"><i class="bi bi-send"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showDirectChatList" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h5>
                            <button type="button" class="btn-close" @click="showDirectChatList = false"></button>
                        </div>
                        <div class="modal-body">
                            <div v-if="chatHistoryList.length === 0" class="text-center text-muted py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div class="list-group">
                                <button v-for="chat in chatHistoryList" :key="chat.roomId" class="list-group-item list-group-item-action" @click="openDirectChat(chat.partnerId, chat.partnerName)">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1 fw-bold">{{ chat.partnerName }}</h6>
                                        <small>{{ formatTimestamp(chat.lastDate) }}</small>
                                    </div>
                                    <p class="mb-1 small text-truncate text-muted">{{ chat.lastMessage }}</p>
                                </button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @click="showDirectChatList = false">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'coach_reg'">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-primary mb-0"><i class="bi bi-person-badge-fill"></i> ã‚³ãƒ¼ãƒç™»éŒ²ãƒ»IDç™ºè¡Œ</h4>
                </div>

                <div class="card mb-4 border-secondary">
                    <div class="card-header bg-secondary text-white fw-bold">æ–°è¦ã‚³ãƒ¼ãƒç™»éŒ²</div>
                    <div class="card-body bg-light">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">æ°å</label>
                                <input type="text" class="form-control" v-model="newCoach.name" placeholder="ä¾‹: ç¥å¥ˆå· æ¬¡éƒ">
                            </div>
                            <div class="col-md-4">
    <label class="form-label fw-bold">BAJç™»éŒ²ç•ªå· (10æ¡)</label>
    <input type="text" class="form-control" 
           v-model="newCoach.nbaId" 
           placeholder="ä¾‹: 1234567890"
           maxlength="10" 
           inputmode="numeric" 
           pattern="\d{10}">
    <div v-if="newCoach.nbaId && newCoach.nbaId.length !== 10" class="small text-danger">
        â€»10æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„
    </div>
</div> <div class="col-md-4">
    <label class="form-label fw-bold">æœ‰åŠ¹æœŸé™</label>
    <input type="date" class="form-control bg-light" value="2027-03-31" readonly>
    <div class="small text-muted">é€£ç›Ÿè¦å®šã«ã‚ˆã‚Šå›ºå®š</div>
</div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ã‚³ãƒ¼ãƒè³‡æ ¼</label>
                                <select class="form-select" v-model="newCoach.license">
                                    <option value="">ãªã—</option>
                                    <option>ã‚³ãƒ¼ãƒ1</option><option>ã‚³ãƒ¼ãƒ2</option><option>ã‚³ãƒ¼ãƒ3</option><option>ã‚³ãƒ¼ãƒ4</option>
                                </select>
                            </div>
                            <div class="col-md-6">
    <label class="form-label fw-bold">å¯©åˆ¤è³‡æ ¼</label>
    <div class="mt-1">
        <select class="form-select" v-model="newCoach.umpireLevel">
            <option value="">ãªã—</option>
            <option value="1">å…¬èª1ç´šå¯©åˆ¤å“¡</option>
            <option value="2">å…¬èª2ç´šå¯©åˆ¤å“¡</option>
            <option value="3">å…¬èª3ç´šå¯©åˆ¤å“¡</option>
        </select>
    </div>
</div>
                            <div class="col-12 text-end">
                                <button class="btn btn-dark fw-bold px-4" @click="addCoach" :disabled="!newCoach.name">
                                    <i class="bi bi-plus-circle"></i> ãƒªã‚¹ãƒˆã«è¿½åŠ 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                        <span>ç™»éŒ²æ¸ˆã¿ã‚³ãƒ¼ãƒä¸€è¦§ ({{ parseCoaches(coachList).length }}å)</span>
                        <button class="btn btn-sm btn-dark" @click="printAllCards" v-if="parseCoaches(coachList).length > 0">
                            <i class="bi bi-printer-fill"></i> A4ã‚µã‚¤ã‚ºã§ä¸€æ‹¬å°åˆ·
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr><th>æ°å</th><th>è³‡æ ¼</th><th>æœ‰åŠ¹æœŸé™</th><th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr>
                            </thead>
                            <tbody>
                                <tr v-if="parseCoaches(coachList).length === 0">
                                    <td colspan="4" class="text-center text-muted py-4">ç™»éŒ²ã•ã‚ŒãŸã‚³ãƒ¼ãƒã¯ã„ã¾ã›ã‚“</td>
                                </tr>
                                <tr v-for="(c, i) in parseCoaches(coachList)" :key="i">
                                    <td>
                                        <div class="fw-bold">{{ c.name }}</div>
                                        <div class="small text-muted">No. {{ c.nbaId || c.bajId || '-' }}</div>
                                    </td>
                                    <td>
    <span v-if="c.license" class="badge bg-warning text-dark me-1">{{ c.license }}</span>

    <span v-if="c.umpireLevel" class="badge bg-info text-white">
        {{ c.umpireLevel }}ç´šå¯©åˆ¤
    </span>
    <span v-else-if="c.hasUmpire" class="badge bg-info text-white">
        3ç´šå¯©åˆ¤
    </span>
</td>
                                    <td>{{ c.expireDate }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary fw-bold me-2" @click="downloadIdCard(c)">
                                            <i class="bi bi-card-heading"></i> IDè¨¼DL
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" @click="removeCoach(i)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="id-card-wrapper">
                    <div id="idCardCanvas" class="id-card">
                        <div class="card-header-area">
                            <div class="assoc-name">ç¥å¥ˆå·çœŒ</div>
                            <div class="card-title-box">OFFICIAL COACH</div>
                        </div>
                        <div class="card-body-area">
                            <div class="team-name">{{ form.univ_name }}</div>
                            <div class="coach-name">{{ printCoach.name }}</div>
                            <div class="meta-info">
                                <div class="meta-item">
                                    <label>BAJ ID</label>
                                    <div>{{ printCoach.nbaId || printCoach.bajId || '------' }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer-area">
                            <div class="license-badges">
                                <div v-if="printCoach.license" class="badge-license badge-coach">
                                    {{ printCoach.license }}
                                </div>
                                <div v-if="printCoach.umpireLevel" class="badge-license badge-umpire">
                                    {{ printCoach.umpireLevel }}ç´šå¯©åˆ¤å“¡
                                </div>
                                <div v-else-if="printCoach.hasUmpire" class="badge-license badge-umpire">
                                    3ç´šå¯©åˆ¤å“¡
                                </div>
                            </div>
                            
                            <div class="valid-date">
                                <div class="valid-label">VALID THRU</div>
                                <div class="valid-value">2027.03.31</div>
                            </div>
                        </div> </div> </div> <div class="save-area mt-4 mb-4 text-center">
                    <button @click="saveData(false)" class="btn btn-primary btn-lg px-5" :disabled="isSaving">
                        <i class="bi bi-save"></i> ãƒ‡ãƒ¼ã‚¿ã‚’é€£ç›Ÿã¸ä¿å­˜
                    </button>
</div>

                <div class="print-only-area">
    <div v-for="(coach, index) in parseCoaches(coachList)" :key="index" class="id-card-print-item">
        <div class="id-card">
            <div class="card-header-area">
                <div class="assoc-name">ç¥å¥ˆå·çœŒ</div>
                <div class="card-title-box">OFFICIAL COACH</div>
            </div>

            <div class="card-body-area">
                <div class="team-name">{{ form.univ_name }}</div>
                <div class="coach-name">{{ coach.name }}</div>
                <div class="meta-info">
                    <div class="meta-item">
                        <label>BAJ ID</label>
                        <div>{{ coach.bajId || coach.nbaId || '------' }}</div>
                    </div>
                </div>
            </div>

            <div class="card-footer-area">
                <div class="license-badges">
                    <div v-if="coach.license" class="badge-license badge-coach">{{ coach.license }}</div>
                    
                    <div v-if="coach.umpireLevel" class="badge-license badge-umpire">
                        {{ coach.umpireLevel }}ç´šå¯©åˆ¤å“¡
                    </div>
                    <div v-else-if="coach.hasUmpire" class="badge-license badge-umpire">
                        3ç´šå¯©åˆ¤å“¡
                    </div>
                </div>
                
                <div class="valid-date">
                    <div class="valid-label">VALID THRU</div>
                    <div class="valid-value">2027.03.31</div>
                </div>
            </div>
        </div> </div> </div><p class="text-muted small mt-2">
    â€»ãƒªã‚¹ãƒˆã¸ã®è¿½åŠ ãƒ»å‰Šé™¤æ™‚ã¯è‡ªå‹•ã§ä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã™ãŒã€æœ€å¾Œã«ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç¢ºå®Ÿã§ã™ã€‚
</p>
</div></div></div></div></div></div>
        <div v-if="detailModal.show" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-light py-2">
                            <h6 class="modal-title fw-bold">{{ detailModal.title }}</h6>
                            <button type="button" class="btn-close small" @click="detailModal.show = false"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3 p-3 bg-light border rounded">
                                <strong>ç”³è¾¼å†…å®¹:</strong><br>
                                <span style="white-space: pre-wrap;">{{ detailModal.data.text }}</span>
                            </div>
                            <div class="text-center text-muted small">è©³ç´°ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
                        </div>
                        <div class="modal-footer py-1">
                            <button type="button" class="btn btn-sm btn-secondary" @click="detailModal.show = false">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="receiptData.show" class="modal fade show d-block" id="receiptModal" tabindex="-1" style="background: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">é ˜åæ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                            <button type="button" class="btn-close" @click="receiptData.show = false"></button>
                        </div>
                        <div class="modal-body bg-light p-4">
                            <div class="receipt-layout mx-auto" style="max-width: 700px;">
                                <div class="text-center"><span class="receipt-title">é ˜ã€€åã€€è¨¼</span></div>
                                <div class="d-flex justify-content-between align-items-end mt-4">
                                    <h4 class="mb-0"><u>{{ form.univ_name }} æ§˜</u></h4>
                                    <div>ç™ºè¡Œæ—¥: {{ new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'long', day:'numeric'}) }}</div>
                                </div>
                                <div class="receipt-amount">{{ formatMoney(receiptData.amount) }}-</div>
                                <div class="text-center small text-muted">ï¼ˆæ¶ˆè²»ç¨ç­‰ã‚’å«ã‚€ï¼‰</div>
                                <div class="receipt-detail">
                                    <p>ä½†ã€€{{ receiptData.title }} ã¨ã—ã¦<br>ä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸã€‚</p>
                                </div>
                                <div class="issuer-info">
                                    <div class="hanko-box">
                                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
                                            <rect x="2" y="2" width="96" height="96" rx="2" ry="2" fill="none" stroke="#d00" stroke-width="2" />
                                            <rect x="6" y="6" width="88" height="88" rx="1" ry="1" fill="none" stroke="#d00" stroke-width="1" />
                                            <text x="50" y="25" font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold" font-size="20" fill="#d00" text-anchor="middle">ç¥å¥ˆå·çœŒ</text>
                                            <text x="50" y="55" font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold" font-size="20" fill="#d00" text-anchor="middle">å°å­¦ç”Ÿ</text>
                                            <text x="50" y="85" font-family="'Hiragino Mincho ProN', 'MS Mincho', serif" font-weight="bold" font-size="20" fill="#d00" text-anchor="middle">é€£ç›Ÿ</text>
                                        </svg>
                                    </div>
                                    <h5>ç¥å¥ˆå·çœŒå°å­¦ç”Ÿãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³é€£ç›Ÿ</h5>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @click="receiptData.show = false">é–‰ã˜ã‚‹</button>
                            <button type="button" class="btn btn-primary" onclick="window.print()"><i class="bi bi-printer"></i> å°åˆ· / PDFä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showDeadlineModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-event"></i> æœŸé™è¨­å®š</h5>
                <button type="button" class="btn-close" @click="showDeadlineModal = false"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">å„é …ç›®ã®ç”³è¾¼æœŸé™ã‚’è¨­å®šã—ã¾ã™ã€‚æœŸé™ã‚’éãã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã§ã€Œã€œã¾ã§ã€ã¨èµ¤å­—ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                <form @submit.prevent="saveDeadlines">
                    <div v-for="(cat, key) in categories" :key="key" class="mb-2 row">
                        <label class="col-sm-5 col-form-label col-form-label-sm fw-bold">{{ cat.label }}</label>
                        <div class="col-sm-7">
                            <input type="date" class="form-control form-control-sm" v-model="deadlines[key]">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" @click="showDeadlineModal = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary fw-bold" @click="saveDeadlines">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>
</div>
<div v-if="broadcastModal.show" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-megaphone-fill"></i> å…¨å“¡ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h5>
                <button type="button" class="btn-close btn-close-white" @click="broadcastModal.show = false"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
                    <div class="small">
                        ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹<strong>å…¨{{ adminRecords.length }}ãƒãƒ¼ãƒ </strong>ã®ãƒãƒ£ãƒƒãƒˆã«ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸€æ–‰é€ä¿¡ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹</label>
                    <textarea class="form-control" rows="6" v-model="broadcastModal.message" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" @click="broadcastModal.show = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-info text-white fw-bold" @click="sendBroadcast" :disabled="isSendingBroadcast || !broadcastModal.message">
                    <span v-if="isSendingBroadcast" class="spinner-border spinner-border-sm me-1"></span>
                    é€ä¿¡ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

        </div> </div> </div> <script>

        // â˜…â˜…â˜… ã“ã“ã‚’ã”è‡ªèº«ã®APIã‚­ãƒ¼ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwuqBbPb1MDJP_lwuE6Ge0Vb4rMXzYBeSggynOFnJyx6cPCrOOibGsPQc5ZdRqFxx4IOA/exec";

        const firebaseConfig = {
          apiKey: "AIzaSyCAQorZttgQhUzM30-gHW18MvfcDwtTSUc",
          authDomain: "kanagawa-jr-badminton.firebaseapp.com",
          projectId: "kanagawa-jr-badminton",
          storageBucket: "kanagawa-jr-badminton.firebasestorage.app",
          messagingSenderId: "316845745244",
          appId: "1:316845745244:web:362cb9789709cd5113f299",
        };
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        const ADMIN_ID = "kanagawaadmin";
        const ADMIN_PASS = "kanagawaadmin1234"; 

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // FirestoreåˆæœŸåŒ–
        const { createApp } = Vue;

        createApp({
    data() {
                return {
                    user: null, isAdmin: false, authEmail: '', authPass: '', isRegisterMode: false,
                    regForm: { univ_id: '', representative: '' }, regError: '', regUnivName: '', searchQuery: '',
                    isLoading: false, isSaving: false, isUploading: false,
                    masterData: [], savedRecords: [], newsList: [],
                    activeTab: 'home',
                   adminNews: { date: '', title: '', content: '', files: [] }, isUploadingNews: false,
                    account: { newEmail: '', newPass: '' },
                    form: { univ_id: '', univ_name: '', representative: '' }, memo: '',coachSearchQuery: '',
                    
                    deadlines: {}, 
                    showDeadlineModal: false,
                    broadcastModal: { show: false, message: '' }, 
                    isSendingBroadcast: false,

                    recruitList: [],
                    showRecruitModal: false,
                    newRecruit: { category: 'class_tourney', level: 'åˆç´šè€…', comment: '' },
                    recruitUnsubscribe: null,
                    
                    directChat: { 
                        show: false, 
                        roomId: '', 
                        partnerId: '', 
                        partnerName: '', 
                        messages: [], 
                        input: '', 
                        unsubscribe: null 
                    },
                    showDirectChatList: false,
                    chatHistoryList: [],
                               
            categories: {
                reg_fee: { label: "â‘  é€£ç›Ÿç™»éŒ²", id_suffix: "01" },
                training: { label: "â‘¡ æŒ‡å°è€…ãƒ»ã‚¸ãƒ¥ãƒ‹ã‚¢è¬›ç¿’ä¼š", id_suffix: "02" },
                class_tourney: { label: "â‘¢ ãƒŸãƒƒã‚¯ã‚¹ãƒ€ãƒ–ãƒ«ã‚¹ï¼†ãƒ“ã‚®ãƒŠãƒ¼ã‚ºå¤§ä¼š", id_suffix: "03" },
                wakaba: { label: "â‘£ è‹¥è‘‰ã‚«ãƒƒãƒ—ç¥å¥ˆå·çœŒäºˆé¸", id_suffix: "04" },
                abc: { label: "â‘¤ ABCå¤§ä¼šç¥å¥ˆå·çœŒäºˆé¸", id_suffix: "05" },
                umpire: { label: "â‘¥ å¯©åˆ¤è¬›ç¿’ä¼š", id_suffix: "06" },
                chairman: { label: "â‘¦ ä¼šé•·æ¯ãƒ€ãƒ–ãƒ«ã‚¹", id_suffix: "07" },
                kanto: { label: "â‘§ é–¢æ±äºˆé¸", id_suffix: "08" },
                rookie: { label: "â‘¨ æ–°äººæˆ¦", id_suffix: "09" },
                fed_doubles: { label: "â‘© é€£ç›Ÿãƒ€ãƒ–ãƒ«ã‚¹", id_suffix: "10" },
                add_reg: { label: "â‘ª è¿½åŠ ç™»éŒ²", id_suffix: "11" }
            },
            entry: {
                reg_fee: { excel_url: '', count_player:0, count_coach:0, payment_id: '', receipt_url: '' },
                training: { excel_url: '', count_general:0, count_member:0, count_student:0, payment_id: '', receipt_url: '' },
                class_tourney: { excel_url: '', count_beginner:0, count_challenge:0, count_mix:0, payment_id: '', receipt_url: '' },
                wakaba: { excel_url: '', count_team:0, payment_id: '', receipt_url: '' },
                abc: { excel_url: '', count_single:0, payment_id: '', receipt_url: '' },
                umpire: { excel_url: '', count_person:0, payment_id: '', receipt_url: '' },
                chairman: { excel_url: '', count_double:0, payment_id: '', receipt_url: '' },
                kanto: { excel_url: '', count_single:0, count_double:0, payment_id: '', receipt_url: '' },
                rookie: { excel_url: '', count_single:0, payment_id: '', receipt_url: '' },
                fed_doubles: { excel_url: '', count_double:0, payment_id: '', receipt_url: '' },
                add_reg: { excel_url: '', period:'early', count_player:0, count_coach:0, payment_id: '', receipt_url: '', history: [] }
            },
            adminFilterType: 'all', adminSearchQuery: '',
            adminStatusKeys: ['reg_fee', 'training', 'class_tourney', 'wakaba', 'abc', 'umpire', 'chairman', 'kanto', 'rookie', 'fed_doubles', 'add_reg'],
            selectedTournament: 'reg_fee', isZipping: false,
            modal: { show: false, univName: '', category: '', url: '' },
            detailModal: { show: false, title: '', type: '', data: null },
            receiptData: { show: false, amount: 0, title: '' },
            
            // æœªèª­ç®¡ç†ç”¨
            unreadStatus: {},     // ç®¡ç†è€…ç”¨
            userHasUnread: false, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨
            latestMsgId: null,    // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDä¿æŒç”¨

            // ãƒãƒ£ãƒƒãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
            chatMessages: [],
            chatInput: '',
            chatUnsubscribe: null,
            adminChatModal: { show: false, univId: '', univName: '' },
coachList: [],
                    newCoach: { 
    name: '', 
    nbaId: '', 
    expireDate: '2027-03-31', 
    license: '', 
    umpireLevel: '' 
},
                    printCoach: {},
        }
    },
    computed: {
        filteredUnivList() {
    // masterData ãŒ undefined ã¾ãŸã¯ null ã®å ´åˆã‚‚ã‚¬ãƒ¼ãƒ‰ã™ã‚‹
    if (!this.masterData || !this.masterData.length) return [];
    let list = this.masterData;
    if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); list = list.filter(m => m.univ_name.toLowerCase().includes(q)); }
    return list;
},

        grandTotal() {
            let total = 0;
            for (const key in this.categories) total += this.calculateCategoryTotal(key);
            return total;
        },
        adminRecords() {
            if (!this.savedRecords) return [];
            return this.savedRecords.map(r => this.processAdminRecord(r));
        },
        filteredAdminRecords() {
            let list = this.adminRecords;
            if (this.adminSearchQuery) list = list.filter(r => r.univ_name.includes(this.adminSearchQuery));
            return list.sort((a,b) => a.univ_id - b.univ_id);
        },
        adminTotalRevenue() { return this.adminRecords.reduce((sum, r) => sum + (parseInt(r.total_cost) || 0), 0); },

        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ  â–¼â–¼â–¼

        // 1. å…¨ã¦ã®ã‚¯ãƒ©ãƒ–ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒã‚’1ã¤ã®ãƒªã‚¹ãƒˆã«çµ±åˆ
        allCoachList() {
            const list = [];
            this.adminRecords.forEach(rec => {
                const coaches = this.parseCoaches(rec.raw_data.coaches);
                coaches.forEach(c => {
                    list.push({
                        univ_name: rec.univ_name,
                        name: c.name,
                        bajId: c.bajId || c.nbaId || '',
                        license: c.license,
umpireLevel: c.umpireLevel,
                        hasUmpire: c.hasUmpire,
                        expireDate: c.expireDate,
                        idKey: rec.univ_id + "_" + c.name + "_" + (c.bajId || Math.random()) // é‡è¤‡é˜²æ­¢ã‚­ãƒ¼
                    });
                });
            });
            return list;
        },

        // 2. æ¤œç´¢çª“ã«å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—ã§ã‚³ãƒ¼ãƒãƒªã‚¹ãƒˆã‚’çµã‚Šè¾¼ã‚€
        filteredCoachRows() {
        // â–¼ã“ã“ã‚’è¿½åŠ ï¼šå…¥åŠ›ãŒãªã„ï¼ˆã¾ãŸã¯ç©ºç™½ã®ã¿ï¼‰ã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
        if (!this.coachSearchQuery || !this.coachSearchQuery.trim()) {
            return [];
        }
        
        const q = this.coachSearchQuery.toLowerCase();
        return this.allCoachList.filter(c => {
            return c.univ_name.toLowerCase().includes(q) || 
                   c.name.toLowerCase().includes(q) || 
                   (c.license && c.license.toLowerCase().includes(q)) ||
                   (c.bajId && String(c.bajId).toLowerCase().includes(q));
        });
    },

        // 3. å…¨ä½“ã®åˆè¨ˆäººæ•°
        totalCoachCount() {
            return this.allCoachList.length;
        }
    },


    watch: {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å´: ã‚¿ãƒ–ãŒãƒãƒ£ãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰åˆæœŸåŒ–
        activeTab(newVal) {
            if (newVal === 'chat' && this.form.univ_id && !this.isAdmin) {
                this.initChat(this.form.univ_id);
                // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã€ã™ã§ã«æœ€æ–°IDã‚’å–å¾—æ¸ˆã¿ãªã‚‰æ—¢èª­ã«ã™ã‚‹
                if (this.latestMsgId) {
                    localStorage.setItem('user_read_' + String(this.form.univ_id), this.latestMsgId);
                }
                this.userHasUnread = false;
                setTimeout(() => this.scrollToBottom('userChatBox'), 500);
            }
        }
    },
    created() {
        this.isLoading = true;
        const url = GAS_API_URL + "?t=" + new Date().getTime();
        fetch(url).then(r => r.json()).then(d => {
    // d.master ã‚„ d.records ãŒç„¡ã„å ´åˆã¯ç©ºé…åˆ—ã‚’å…¥ã‚Œã‚‹ ( || [] ã‚’è¿½åŠ  )
    this.masterData = d.master || []; 
    this.savedRecords = d.records || []; 
    this.newsList = d.news || []; 
    this.isLoading = false;

    db.collection('config').doc('tournaments').onSnapshot(doc => {
                if (doc.exists) {
                    this.deadlines = doc.data() || {};
                                   }
            });
            
if (this.user) {
            this.initUserData(this.user.email);
        }


            firebase.auth().onAuthStateChanged(u => { 
                this.user = u; 
                if(u) {
                    this.initUserData(u.email); 

// å‹Ÿé›†ãƒªã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
                    db.collection('recruits').orderBy('timestamp', 'desc').onSnapshot(snap => {
                        this.recruitList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ï¼ˆè‡ªåˆ†ã‚’å«ã‚€ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ï¼‰ã‚’å–å¾—ã™ã‚‹ç°¡æ˜“çš„ãªå‡¦ç†
                    // â€»æœ¬æ¥ã¯Firestoreã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
                    db.collection('direct_chats').onSnapshot(snap => {
                        const list = [];
                        snap.forEach(doc => {
                            const data = doc.data();
                            if (data.participants && data.participants.includes(this.form.univ_id)) {
                                // ç›¸æ‰‹ã®åå‰ã‚’æ¢ã™
                                const partnerId = data.participants.find(p => p !== this.form.univ_id) || 'è‡ªåˆ†';
                                // â€»æœ¬æ¥ã¯IDã‹ã‚‰åå‰ãƒã‚¹ã‚¿ã‚’å¼•ãã¹ãã§ã™ãŒã€ç°¡æ˜“çš„ã«IDã¾ãŸã¯ä¿å­˜åã‚’ä½¿ç”¨
                                list.push({
                                    roomId: doc.id,
                                    partnerId: partnerId,
                                    partnerName: partnerId, // å¿…è¦ã«å¿œã˜ã¦åå‰è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
                                    lastMessage: data.lastMessage,
                                    lastDate: data.lastDate
                                });
                            }
                        });
                        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
                        list.sort((a, b) => (b.lastDate?.seconds || 0) - (a.lastDate?.seconds || 0));
                        this.chatHistoryList = list;
                    });
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®æœªèª­ç›£è¦–ã‚’é–‹å§‹
                    if (!this.isAdmin && this.form.univ_id) {
                        this.startUserUnreadListener(this.form.univ_id);
                    }
                }
            });

            // ç®¡ç†è€…ç”¨ã®æœªèª­ç›£è¦–ã‚’é–‹å§‹
            setTimeout(() => {
                if (this.isAdmin || (this.user && this.user.email === ADMIN_ID)) {
                    this.startAdminUnreadListeners();
                }
            }, 2000);

        }).catch(e => { console.error(e); this.isLoading = false; });
    },
    methods: {
        // â–¼â–¼â–¼ è¿½åŠ : æœŸé™é–¢é€£ã®ãƒ¡ã‚½ãƒƒãƒ‰ â–¼â–¼â–¼
        saveDeadlines() {
            if(!confirm("è¨­å®šã—ãŸç”³è¾¼æœŸé™ã‚’ä¿å­˜ãƒ»å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ")) return;
            db.collection('config').doc('tournaments').set(this.deadlines)
                .then(() => {
                    alert("æœŸé™è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ");
                    this.showDeadlineModal = false;
                })
                .catch(error => {
                    console.error("Error saving deadlines: ", error);
                    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
                });
        },
        isExpired(key) {
            if (!this.deadlines[key]) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(this.deadlines[key]);
            return today > targetDate;
        },
        
openBroadcastModal() {
            this.broadcastModal.message = '';
            this.broadcastModal.show = true;
        },

        async sendBroadcast() {
            if (!this.broadcastModal.message) return;
            if (!confirm(`ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ ${this.adminRecords.length} ãƒãƒ¼ãƒ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

            this.isSendingBroadcast = true;
            const msgContent = this.broadcastModal.message;
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            
            try {
                const promises = this.adminRecords.map(rec => {
                    const strUnivId = String(rec.univ_id);
                    return db.collection('chats').doc(strUnivId).collection('messages').add({
                        content: msgContent,
                        sender: 'admin',
                        timestamp: timestamp
                    });
                });

                await Promise.all(promises);
                alert("å…¨ãƒãƒ¼ãƒ ã¸ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
                this.broadcastModal.show = false;
            } catch (e) {
                console.error(e);
                alert("é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
            } finally {
                this.isSendingBroadcast = false;
            }
        },

        formatMoney(v) { if (isNaN(v) || v === null || v === undefined) return "Â¥0"; return "Â¥" + v.toLocaleString(); },
        calculateCategoryTotal(key) {
            const e = this.entry[key]; if (!e) return 0;

            // è¿½åŠ ç™»éŒ²(add_reg)ã®å ´åˆã€ãƒªã‚¹ãƒˆ(history)ã®åˆ†ã‚‚åˆç®—ã™ã‚‹
            if (key === 'add_reg') {
                let total = 0;
                
                // 1. ç¾åœ¨å…¥åŠ›ä¸­ã®ãƒ•ã‚©ãƒ¼ãƒ åˆ†
                const currentPrice = (e.period === 'late') ? 500 : 1500;
                total += ((e.count_player || 0) + (e.count_coach || 0)) * currentPrice;

                // 2. ãƒªã‚¹ãƒˆã«è¿½åŠ æ¸ˆã¿ã®åˆ†
                if (e.history && Array.isArray(e.history)) {
                    e.history.forEach(h => {
                        const hPrice = (h.period === 'late') ? 500 : 1500;
                        total += ((h.count_player || 0) + (h.count_coach || 0)) * hPrice;
                    });
                }
                return total;
            }
            switch(key) {
                case 'reg_fee': return (e.count_player||0)*1500 + (e.count_coach||0)*1500;
                case 'training': return (e.count_general||0)*5000 + (e.count_member||0)*3000 + (e.count_student||0)*500;
                case 'class_tourney': return (e.count_beginner||0)*2000 + (e.count_mix||0)*4000;
                case 'wakaba': return (e.count_team||0)*15000;
                case 'abc': return (e.count_single||0)*2000;
                case 'umpire': return (e.count_person||0)*1000;
                case 'chairman': return (e.count_double||0)*4000;
                case 'kanto': return (e.count_single||0)*2500 + (e.count_double||0)*5000;
                case 'rookie': return (e.count_single||0)*2000;
                case 'fed_doubles': return (e.count_double||0)*4000;
                case 'add_reg': const price=(e.period==='late')?500:1500; return ((e.count_player||0)+(e.count_coach||0))*price;
                default: return 0;
            }
        },
        generateDetailString(key, e) {
            if (!e) return "-"; let parts = [];

            if (key === 'add_reg') {
                // å±¥æ­´åˆ†ã®è¡¨ç¤º
                if (e.history && Array.isArray(e.history)) {
                    e.history.forEach((h, idx) => {
                        const hLabel = (h.period === 'late') ? "1æœˆ" : "é–¢æ±å‰";
                        parts.push(`[ç¬¬${idx+1}å›:${hLabel}] é¸${h.count_player} æŒ‡${h.count_coach}`);
                    });
                }
                // ç¾åœ¨å…¥åŠ›ä¸­ã®è¡¨ç¤º
                if (e.count_player > 0 || e.count_coach > 0) {
                    const label = (e.period === 'late') ? "1æœˆ" : "é–¢æ±å‰";
                    parts.push(`[æ–°è¦:${label}] é¸${e.count_player} æŒ‡${e.count_coach}`);
                }
                return parts.length > 0 ? parts.join(", ") : "ãªã—";
            }
            switch(key) {
                case 'reg_fee': if(e.count_player) parts.push(`é¸æ‰‹:${e.count_player}`); if(e.count_coach) parts.push(`æŒ‡å°è€…:${e.count_coach}`); break;
                case 'training': if(e.count_general) parts.push(`ä¸€èˆ¬:${e.count_general}`); if(e.count_member) parts.push(`ä¼šå“¡:${e.count_member}`); if(e.count_student) parts.push(`å­¦ç”Ÿ:${e.count_student}`); break;
                case 'class_tourney': if(e.count_beginner) parts.push(`ãƒ“ã‚®ãƒŠãƒ¼:${e.count_beginner}`); if(e.count_mix) parts.push(`Mix:${e.count_mix}`); break;
                case 'wakaba': if(e.count_team) parts.push(`${e.count_team}ãƒãƒ¼ãƒ `); break;
                case 'abc': if(e.count_single) parts.push(`${e.count_single}å`); break;
                case 'umpire': if(e.count_person) parts.push(`${e.count_person}å`); break;
                case 'chairman': if(e.count_double) parts.push(`${e.count_double}çµ„`); break;
                case 'kanto': if(e.count_single) parts.push(`S:${e.count_single}`); if(e.count_double) parts.push(`D:${e.count_double}`); break;
                case 'rookie': if(e.count_single) parts.push(`S:${e.count_single}`); break;
                case 'fed_doubles': if(e.count_double) parts.push(`D:${e.count_double}`); break;
                // â˜…å‰Šé™¤æ¸ˆã¿: case 'add_reg'
            }
            return parts.length > 0 ? parts.join(", ") : "0";
        },
        initChat(univId) {
            if (this.chatUnsubscribe) this.chatUnsubscribe();
            this.chatMessages = [];
            const strUnivId = String(univId);
            this.chatUnsubscribe = db.collection('chats').doc(strUnivId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    this.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.$nextTick(() => {
                        this.scrollToBottom(this.isAdmin ? 'adminChatBox' : 'userChatBox');
                    });
                    if (this.chatMessages.length > 0) {
                        const lastMsg = this.chatMessages[this.chatMessages.length - 1];
                        if (this.isAdmin) {
                            localStorage.setItem('admin_read_' + strUnivId, lastMsg.id);
                            this.unreadStatus[strUnivId] = false; 
                        } else if (this.activeTab === 'chat') {
                            localStorage.setItem('user_read_' + strUnivId, lastMsg.id);
                            this.userHasUnread = false;
                        }
                    }
                });
        },
        deleteChat(msg) {
            if(!confirm("ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const targetId = this.isAdmin ? this.adminChatModal.univId : this.form.univ_id;
            db.collection('chats').doc(String(targetId)).collection('messages').doc(msg.id).delete()
                .catch(e => alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message));
        },
        startAdminUnreadListeners() {
            if (!this.savedRecords) return;
            this.savedRecords.forEach(rec => {
                const strUnivId = String(rec.univ_id);
                db.collection('chats').doc(strUnivId).collection('messages')
                    .orderBy('timestamp', 'desc').limit(1)
                    .onSnapshot(snapshot => {
                        if (!snapshot.empty) {
                            const lastMsg = snapshot.docs[0].data();
                            const lastReadId = localStorage.getItem('admin_read_' + strUnivId);
                            if (lastMsg.sender !== 'admin' && lastMsg.id !== lastReadId && snapshot.docs[0].id !== lastReadId) {
                                this.unreadStatus[strUnivId] = true;
                            } else {
                                this.unreadStatus[strUnivId] = false;
                            }
                        } else {
                            this.unreadStatus[strUnivId] = false;
                        }
                    });
            });
        },

        startUserUnreadListener(univId) {
            const strUnivId = String(univId);
            db.collection('chats').doc(strUnivId).collection('messages')
                .orderBy('timestamp', 'desc').limit(1)
                .onSnapshot(snapshot => {
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        const lastMsg = doc.data();
                        this.latestMsgId = doc.id; 
                        const lastReadId = localStorage.getItem('user_read_' + strUnivId);
                        
                        if (this.activeTab === 'chat') {
                            localStorage.setItem('user_read_' + strUnivId, this.latestMsgId);
                            this.userHasUnread = false;
                        } else if (lastMsg.sender === 'admin' && this.latestMsgId !== lastReadId) {
                            this.userHasUnread = true;
                        } else {
                            this.userHasUnread = false;
                        }
                    }
                });
        },

        sendChat(sender) {
            if (!this.chatInput.trim()) return;
            const univId = this.isAdmin ? this.adminChatModal.univId : this.form.univ_id;
            if (!univId) { alert("ã‚¨ãƒ©ãƒ¼: ã‚¯ãƒ©ãƒ–IDãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"); return; }
            const strUnivId = String(univId);
            db.collection('chats').doc(strUnivId).collection('messages').add({
                content: this.chatInput,
                sender: sender,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then((docRef) => {
                this.chatInput = '';
                if (this.isAdmin) {
                    localStorage.setItem('admin_read_' + strUnivId, docRef.id);
                    this.unreadStatus[strUnivId] = false;
                } else {
                    localStorage.setItem('user_read_' + strUnivId, docRef.id);
                }
                this.scrollToBottom(this.isAdmin ? 'adminChatBox' : 'userChatBox');
            }).catch(e => console.error(e));
        },

        openAdminChat(rec) {
            this.adminChatModal.univId = rec.univ_id;
            this.adminChatModal.univName = rec.univ_name;
            this.adminChatModal.show = true;
            this.initChat(rec.univ_id);
        },

        formatTimestamp(ts) {
            if (!ts) return '';
            const d = ts.toDate();
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        },

        scrollToBottom(elemId) {
            const el = document.getElementById(elemId);
            if(el) el.scrollTop = el.scrollHeight;
        },

        uploadExcel(event, category) {
            const file = event.target.files[0]; if (!file) return; this.isUploading = true;
            const path = `excel/${this.form.univ_id}/${category}_${Date.now()}_${file.name}`;
            firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => { this.entry[category].excel_url = url; this.saveData(true); this.isUploading = false; alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ"); }).catch(e => { alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + e.message); this.isUploading = false; });
        },

deleteExcel(category) {
    if (!confirm("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…¥åŠ›ã—ãŸäººæ•°ã¯æ®‹ã‚Šã¾ã™ï¼‰")) return;
    this.entry[category].excel_url = '';
    this.saveData(true); // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆä¿å­˜
},

        uploadReceipt(event, category) {
            const file = event.target.files[0]; if (!file) return; this.isUploading = true;
            const path = `receipts/${this.form.univ_id}/${category}_${Date.now()}`;
            firebase.storage().ref().child(path).put(file).then(s => s.ref.getDownloadURL()).then(url => { this.entry[category].receipt_url = url; this.saveData(true); this.isUploading = false; }).catch(e => { alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + e.message); this.isUploading = false; });
        },

        deleteReceipt(category) {
    if(!confirm("ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    this.entry[category].receipt_url = ''; 
    this.saveData(true); // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆä¿å­˜
},

        uploadNewsFile(event) {
    const file = event.target.files[0]; 
    if (!file) return; 
    
    this.isUploadingNews = true;
    const fileName = file.name;
    const path = `news/${Date.now()}_${fileName}`;
    
    firebase.storage().ref().child(path).put(file)
        .then(s => s.ref.getDownloadURL())
        .then(url => { 
            // é…åˆ—ã«è¿½åŠ 
            if(!this.adminNews.files) this.adminNews.files = [];
            this.adminNews.files.push({ name: fileName, url: url });
            this.isUploadingNews = false; 
            // inputã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠå¯èƒ½ã«ã™ã‚‹
            event.target.value = '';
        })
        .catch(e => { 
            alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + e.message); 
            this.isUploadingNews = false; 
        });
},

removeAdminNewsFile(index) {
    this.adminNews.files.splice(index, 1);
},

addNews() { 
            if(!this.adminNews.date || !this.adminNews.title) return alert("æ—¥ä»˜ã¨ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™"); 
            
            // ã€ä¿®æ­£ç®‡æ‰€ã€‘JSON.parse(JSON.stringify(...)) ã‚’ä½¿ã£ã¦ã€Œæ·±ã„ã‚³ãƒ”ãƒ¼ã€ã‚’ä½œæˆã—ã¾ã™ã€‚
            // ã“ã‚Œã«ã‚ˆã‚Šã€filesé…åˆ—ã®ä¸­èº«ã‚‚å®Œå…¨ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¤‡è£½ã•ã‚Œã€
            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆã‚„å‚ç…§ã®å½±éŸ¿ã‚’å—ã‘ãªããªã‚Šã¾ã™ã€‚
            const newsItem = JSON.parse(JSON.stringify(this.adminNews));

            // filesãŒä¸‡ãŒä¸€ undefined ã®å ´åˆã¯ç©ºé…åˆ—ã«ã—ã¦ãŠãå®‰å…¨ç­–
            if (!newsItem.files) {
                newsItem.files = [];
            }

            // æŠ•ç¨¿ãƒªã‚¹ãƒˆã«è¿½åŠ 
            this.newsList.unshift(newsItem); 
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            this.saveNews(); 
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            this.adminNews = { date: '', title: '', content: '', files: [] }; 
        },

        updateAccount() {
            const user = firebase.auth().currentUser; const promises = [];
            if (this.account.newEmail) promises.push(user.updateEmail(this.account.newEmail));
            if (this.account.newPass) promises.push(user.updatePassword(this.account.newPass));
            Promise.all(promises).then(() => { alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"); if (this.account.newEmail) this.saveData(true); this.account.newEmail = ''; this.account.newPass = ''; }).catch(err => { alert("ã‚¨ãƒ©ãƒ¼: " + err.message); });
        },

openHistoryReceipt(item) {
    // 1. ãã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®é‡‘é¡ã‚’è¨ˆç®—
    // item.period ãŒ 'late' ãªã‚‰500å††ã€'early' ãªã‚‰1500å††
    const price = (item.period === 'late') ? 500 : 1500;
    const count = (item.count_player || 0) + (item.count_coach || 0);
    const total = count * price;

    if (total === 0) {
        alert("é‡‘é¡ãŒ0å††ã®ãŸã‚ç™ºè¡Œã§ãã¾ã›ã‚“ã€‚");
        return;
    }

    // 2. é ˜åæ›¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
    this.receiptData.amount = total;
    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å°‘ã—å¤‰ãˆã¦åŒºåˆ¥ã—ã‚„ã™ãã™ã‚‹ï¼ˆä¾‹ï¼šè¿½åŠ ç™»éŒ²(é–¢æ±äºˆé¸å‰) å‚åŠ è²»ç­‰ï¼‰
    const periodLabel = (item.period === 'late') ? "1æœˆæ–°äººæˆ¦" : "é–¢æ±äºˆé¸å‰";
    this.receiptData.title = `ä»¤å’Œ7å¹´åº¦ è¿½åŠ ç™»éŒ²(${periodLabel}) å‚åŠ è²»ç­‰`;
    
    // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    this.receiptData.show = true;
},

        deleteAccount() {
            if (!confirm("æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nå†ç™»éŒ²ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚")) return;
            const user = firebase.auth().currentUser; const email = user.email;
            const payload = { action: 'delete_user', univ_id: this.form.univ_id, email: email };
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(e => console.error("GAS delete request failed", e));
            user.delete().then(() => { alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"); location.reload(); }).catch((error) => { if (error.code === 'auth/requires-recent-login') { alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"); this.logout(); } else { alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message); } });
        },
        toggleRegisterMode() { this.isRegisterMode=true; this.resetSelection(); },
        resetSelection() { this.regForm.univ_id=''; this.regUnivName=''; this.regForm.representative=''; this.regError=''; this.searchQuery=''; },
        selectUniv(u) { const t=this.savedRecords.some(r=>r.univ_id==u.univ_id); if(t){this.regError="ç™»éŒ²æ¸ˆã¿";this.regForm.univ_id='';}else{this.regError='';this.regForm.univ_id=u.univ_id;this.regUnivName=u.univ_name;} },
    
    
login() {
    // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
    if (this.authEmail === ADMIN_ID && this.authPass === ADMIN_PASS) {
        // ç®¡ç†è€…ã‚‚ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã«ã™ã‚‹è¨­å®šã‚’è¿½åŠ 
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
                return firebase.auth().signInAnonymously();
            })
            .then(() => { 
                this.isAdmin = true; 
                this.authEmail = ''; 
                this.authPass = ''; 
            })
            .catch((e) => { 
                alert("ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + e.message); 
            });
        return;
    }

    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
    // â–¼â–¼â–¼ ã“ã“ã§ã€ŒSESSIONï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰ã€ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã™ â–¼â–¼â–¼
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
        .then(() => {
            // è¨­å®šæˆåŠŸå¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
            return firebase.auth().signInWithEmailAndPassword(this.authEmail, this.authPass);
        })
        .catch(e => alert(e.message));
},

        register() { if(this.regError||!this.regUnivName||!this.regForm.representative) return alert("å…¥åŠ›å†…å®¹ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™"); if(!confirm("ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ"))return; firebase.auth().createUserWithEmailAndPassword(this.authEmail,this.authPass).then(c=>{ this.form.univ_id=this.regForm.univ_id; this.form.univ_name=this.regUnivName; this.form.representative=this.regForm.representative; this.saveData(true, this.authPass); }).catch(e=>alert(e.message)); },


       logout() {
    // ç®¡ç†è€…ç”¨ã®å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    if (this.isAdmin) {
        this.isAdmin = false;
        this.chatMessages = [];
    }
    
    // ç®¡ç†è€…(åŒ¿åãƒ­ã‚°ã‚¤ãƒ³)ã®å ´åˆã‚‚ã€é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã‚‚ã€
    // å…±é€šã—ã¦Firebaseã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã™ã‚‹ã“ã¨ã§ this.user ãŒ null ã«ãªã‚Š
    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ (v-if="!user && !isAdmin") ã«æˆ»ã‚Šã¾ã™ã€‚
    firebase.auth().signOut();
},


        initUserData(em) {
            const d = this.savedRecords.find(r => r.email === em);
            if (d) {
                this.form.univ_id = d.univ_id; this.form.univ_name = d.univ_name; this.form.representative = d.representative || ''; if (d.memo) this.memo = d.memo;
                const safeParse = (json, defaultVal) => { if (typeof json === 'object' && json !== null) return json; try { return json ? JSON.parse(json) : defaultVal; } catch (e) { return defaultVal; } };
                for (const key in this.categories) {
                    if (d[key]) {
                        const parsed = safeParse(d[key], {}); this.entry[key] = { ...this.entry[key], ...parsed };
                        if (!this.entry[key].payment_id) this.entry[key].payment_id = this.form.univ_id + this.categories[key].id_suffix;
                    } else { this.entry[key].payment_id = this.form.univ_id + this.categories[key].id_suffix; }
                }
                this.initChat(d.univ_id);
if (d.coaches) {
                    this.coachList = this.parseCoaches(d.coaches);
                } else {
                    this.coachList = [];
                }
            }
        },
        saveDataPayload(password = null) {
            const p = { 
                univ_id:this.form.univ_id, 
                email:this.user.email, 
                univ_name:this.form.univ_name, 
                representative:this.form.representative, 
                memo: this.memo, 
                total_cost:this.grandTotal,
                coaches: this.coachList
                
            };
            for (const key in this.categories) p[key] = this.entry[key];
            if (password) p.password = password;
            return fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(p) }).then(r=>r.json());
        },
        saveData(isSilent = false, password = null) { this.isSaving = true; this.saveDataPayload(password).then(d => { if(!isSilent) alert("ä¿å­˜ã—ã¾ã—ãŸ"); this.isSaving=false; }).catch(e=>{alert("ã‚¨ãƒ©ãƒ¼");this.isSaving=false;}); },
        processAdminRecord(raw) {
            const safeParse = (json, def) => { try { return json ? JSON.parse(json) : def; } catch(e) { return def; } };
            const result = { univ_id: raw.univ_id, univ_name: raw.univ_name, total_cost: raw.total_cost, memo: raw.memo, cost_detail: "", raw_data: raw };
            let details = [];
            for (const key in this.categories) {
                const rawObj = safeParse(raw[key], {});
                result[key] = { hasPaymentId: !!rawObj.payment_id, hasReceipt: !!rawObj.receipt_url, receiptUrl: rawObj.receipt_url, paymentId: rawObj.payment_id, confirmed: !!rawObj.confirmed, rawObj: rawObj };
                const detailStr = this.generateDetailString(key, rawObj);
                if(detailStr !== "0" && detailStr !== "-") { this.entry[key] = rawObj; const amount = this.calculateCategoryTotal(key); details.push(`${this.categories[key].label}: ${detailStr} = Â¥${amount.toLocaleString()}`); }
            }
            result.cost_detail = details.length > 0 ? details.join('\n') : "å†…è¨³ãªã—";
            return result;
        },
        getAdminStatusClass(cat) { if (cat.confirmed) return 'status-done'; if (cat.hasReceipt) return 'status-pending'; if (cat.hasPaymentId) return 'status-waiting'; return 'status-none'; },
        showReceipt(record, catKey) { this.modal.univName = record.univ_name; this.modal.category = catKey; this.modal.url = record[catKey].receiptUrl; this.modal.targetRecord = record; this.modal.show = true; },
        closeModal() { this.modal.show = false; },
        getCategoryName(key) { return this.categories[key] ? this.categories[key].label : key; },
        downloadAllCSV() {
            let csv = "ID,ã‚¯ãƒ©ãƒ–å,åˆè¨ˆè«‹æ±‚é¡"; for (const key in this.categories) csv += `,${this.categories[key].label}_è©³ç´°,${this.categories[key].label}_Excel`; csv += "\n";
            this.filteredAdminRecords.forEach(r => { let line = `${r.univ_id},${r.univ_name},${r.total_cost}`; for (const key in this.categories) { const raw = r[key].rawObj || {}; const detail = this.generateDetailString(key, raw).replace(/,/g, ' '); line += `,${detail},${raw.excel_url || ''}`; } csv += line + "\n"; });
            saveAs(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: "text/csv" }), "kanagawa_badminton_summary.csv");
        },
        downloadTournamentCSV() {
            const key = this.selectedTournament; let csv = `ID,ã‚¯ãƒ©ãƒ–å,å‚åŠ å†…è¨³,ExcelURL,æ”¯æ‰•ID,æ‰¿èªæ¸ˆ\n`;
            this.filteredAdminRecords.forEach(r => { const raw = r[key].rawObj; if (!raw) return; const detail = this.generateDetailString(key, raw).replace(/,/g, ' '); csv += `${r.univ_id},${r.univ_name},${detail},${raw.excel_url||''},${raw.payment_id||''},${raw.confirmed?1:0}\n`; });
            saveAs(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: "text/csv" }), `kanagawa_${key}_list.csv`);
        },
        async downloadTournamentZip() {
            const key = this.selectedTournament; const zip = new JSZip(); let count = 0; this.isZipping = true;
            const targets = this.filteredAdminRecords.filter(r => r[key].rawObj && r[key].rawObj.excel_url).map(r => ({ name: `${r.univ_name}_${this.getCategoryName(key)}.xlsx`, url: r[key].rawObj.excel_url }));
            if (targets.length === 0) { alert("å¯¾è±¡ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); this.isZipping = false; return; }
            try { await Promise.all(targets.map(async (target) => { try { const response = await fetch(target.url); if (!response.ok) throw new Error("Network error"); const blob = await response.blob(); zip.file(target.name, blob); count++; } catch (err) { console.error(`Failed to load ${target.name}`, err); } })); if (count === 0) alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); else saveAs(await zip.generateAsync({ type: "blob" }), `${this.getCategoryName(key)}_All_Excel.zip`); } catch (e) { console.error(e); alert("ZIPä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); } finally { this.isZipping = false; }
        },
        toggleApproval(isApprove) {
            const rec = this.modal.targetRecord; const cat = this.modal.category; if (!confirm(isApprove ? "ã€ŒæŒ¯è¾¼æ¸ˆã¿ã€ã¨ã—ã¦æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ" : "æ‰¿èªã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            rec[cat].confirmed = isApprove; rec[cat].rawObj.confirmed = isApprove;
            this.saveTargetRecord(rec).then(() => { alert(isApprove ? "æ‰¿èªã—ã¾ã—ãŸ" : "æ‰¿èªã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ"); this.modal.show = false; });
        },
        togglePaymentStatus(rec, key) {
            const currentStatus = rec[key].confirmed; if (!confirm(currentStatus ? "ã€Œæ‰¿èªæ¸ˆã€ã‚’å–ã‚Šæ¶ˆã—ã¦ã€Œæœªæ‰¿èªã€ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ" : "å…¥é‡‘ã‚’ç¢ºèªã—ã¾ã—ãŸã‹ï¼Ÿ\nã€Œæ‰¿èªæ¸ˆã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´ã—ã¾ã™ã€‚")) return;
            rec[key].confirmed = !currentStatus; rec[key].rawObj.confirmed = !currentStatus;
            this.saveTargetRecord(rec);
        },
        saveTargetRecord(rec) {
            const payload = { ...rec.raw_data }; const cats = this.adminStatusKeys; cats.forEach(key => { payload[key] = JSON.stringify(rec[key].rawObj); }); payload.email = payload.email || 'admin_edit'; 
            return fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).catch(e => { console.error(e); alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); });
        },
        openReceipt(category) {
            const amount = this.calculateCategoryTotal(category); if (amount === 0) { alert("æ”¯æ‰•é‡‘é¡ãŒ0å††ã®ãŸã‚ç™ºè¡Œã§ãã¾ã›ã‚“ã€‚"); return; }
            this.receiptData.amount = amount; this.receiptData.title = `ä»¤å’Œ7å¹´åº¦ ${this.categories[category].label} å‚åŠ è²»ç­‰`; this.receiptData.show = true;
        },
        addNews() { if(!this.adminNews.date || !this.adminNews.title) return alert("æ—¥ä»˜ã¨ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™"); this.newsList.unshift({ ...this.adminNews }); this.saveNews(); this.adminNews = { date: '', title: '', content: '', url: '' }; },
        deleteNews(index) { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; this.newsList.splice(index, 1); this.saveNews(); },
        saveNews() { const payload = { action: 'update_news', news_list: this.newsList }; fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(() => alert("é€£çµ¡äº‹é …ã‚’æ›´æ–°ã—ã¾ã—ãŸ")).catch(e => alert("ã‚¨ãƒ©ãƒ¼: " + e.message)); },
        sendAlertEmail(rec) {
            const reason = prompt(`${rec.univ_name} (${rec.raw_data.email}) ã¸ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚\n\nä¸å‚™ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š`); if (!reason) return;
            const body = `${rec.univ_name} ä»£è¡¨è€…æ§˜\n\nç¥å¥ˆå·çœŒå°å­¦ç”Ÿãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³é€£ç›Ÿã§ã™ã€‚\nã”æå‡ºã„ãŸã ã„ãŸç™»éŒ²å†…å®¹ã«ä»¥ä¸‹ã®ä¸å‚™ãŒã‚ã‚Šã¾ã—ãŸã€‚\n\nã€ä¸å‚™å†…å®¹ã€‘\n${reason}\n\nã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ä¿®æ­£ãƒ»å†ç”³è«‹ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\nhttps://kanto-badminton-app.web.app/`; 
            if (!confirm("ä»¥ä¸‹ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\n" + body)) return;
            const payload = { action: 'send_email', to: rec.raw_data.email, body: body };
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(d => { if(d.status === 'success') alert("é€ä¿¡ã—ã¾ã—ãŸ"); else alert("é€ä¿¡å¤±æ•—: " + d.message); }).catch(e => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"));
        },
        openDetailModal(rec, key) {
            const raw = rec[key].rawObj; const catName = this.getCategoryName(key); const detailText = this.generateDetailString(key, raw).replace(/, /g, '\n');
            this.detailModal = { show: true, title: `${rec.univ_name} - ${catName}`, type: 'entry', data: { text: detailText } };
        },

        addRegToHistory() {
    const target = this.entry.add_reg;
    
    // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
    if (!target.excel_url) return alert("Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    if (target.count_player === 0 && target.count_coach === 0) return alert("äººæ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");

    // å±¥æ­´é…åˆ—ãŒãªã‘ã‚Œã°ä½œæˆ
    if (!target.history) target.history = [];

    // ç¾åœ¨ã®å†…å®¹ã‚’å±¥æ­´ã«ãƒ—ãƒƒã‚·ãƒ¥
    target.history.push({
        excel_url: target.excel_url,
        receipt_url: target.receipt_url || '', // ç”»åƒURLã‚‚ä¿å­˜
        period: target.period,
        count_player: target.count_player,
        count_coach: target.count_coach,
        added_at: new Date().toISOString()
    });

    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    target.excel_url = '';
    target.receipt_url = ''; // ç”»åƒå…¥åŠ›ã‚‚ã‚¯ãƒªã‚¢
    target.count_player = 0;
    target.count_coach = 0;
    
    // ä¿å­˜ï¼ˆãƒªã‚¹ãƒˆã«è¿½åŠ ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€Œä¿å­˜ã—ã¾ã—ãŸã€ã¨å‡ºã—ãŸã„å ´åˆã¯ falseã€å‡ºã—ãŸããªã„ãªã‚‰ trueï¼‰
    this.saveData(false); 
},

        // â˜…æ–°è¦è¿½åŠ : å±¥æ­´ã‹ã‚‰å‰Šé™¤ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        removeRegHistory(index) {
            if(!confirm("ã“ã®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            this.entry.add_reg.history.splice(index, 1);
            this.saveData(false); // â˜…ã“ã“ã‚‚ã€Œä¿å­˜ã—ã¾ã—ãŸã€ã‚’å‡ºã™ã‚ˆã†ã« false ã«å¤‰æ›´æ¨å¥¨
        },

getCategoryLabel(key) { return this.categories[key] ? this.categories[key].label : key; },
        
        openRecruitModal() { 
            // åˆæœŸåŒ–æ™‚ã«æ–°ã—ã„é …ç›®ï¼ˆname, grade, genderï¼‰ã‚’è¿½åŠ 
            this.newRecruit = { 
                category: 'class_tourney', 
                level: 'åˆç´šè€…', 
                comment: '', 
                name: '', 
                grade: 'å°6', 
                gender: 'ç”·' 
            }; 
            this.showRecruitModal = true; 
        },

        saveRecruit() {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›ãƒã‚§ãƒƒã‚¯ï¼‰
            if(!this.newRecruit.comment) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(!this.newRecruit.name) return alert("æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const data = {
                univ_id: this.form.univ_id,
                univ_name: this.form.univ_name,
                category: this.newRecruit.category,
                level: this.newRecruit.level,
                comment: this.newRecruit.comment,
                // â˜…è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                player_name: this.newRecruit.name,
                player_grade: this.newRecruit.grade,
                player_gender: this.newRecruit.gender,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('recruits').add(data).then(() => {
                this.showRecruitModal = false;
                alert("å‹Ÿé›†ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ");
            }).catch(e => alert("ã‚¨ãƒ©ãƒ¼: " + e.message));
        },

        deleteRecruit(id) {
            if(!confirm("ã“ã®å‹Ÿé›†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            db.collection('recruits').doc(id).delete().then(() => alert("å‰Šé™¤ã—ã¾ã—ãŸ"));
        },

        openDirectChat(partnerId, partnerName) {
            this.directChat.partnerId = partnerId;
            this.directChat.partnerName = partnerName;
            
            // ãƒ«ãƒ¼ãƒ IDã‚’ä¸€æ„ã«ç”Ÿæˆ
            const ids = [String(this.form.univ_id), String(partnerId)].sort();
            this.directChat.roomId = ids.join('_');
            
            this.directChat.messages = [];
            this.directChat.show = true;
            this.showDirectChatList = false; 

            if(this.directChat.unsubscribe) this.directChat.unsubscribe();
            
            this.directChat.unsubscribe = db.collection('direct_chats')
                .doc(this.directChat.roomId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    this.directChat.messages = snapshot.docs.map(doc => doc.data());
                    this.$nextTick(() => this.scrollToBottom('directChatBox'));
                });
        },

        sendDirectChat() {
            if(!this.directChat.input.trim()) return;
            db.collection('direct_chats').doc(this.directChat.roomId).collection('messages').add({
                content: this.directChat.input,
                senderId: this.form.univ_id,
                senderName: this.form.univ_name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ä¸€è¦§è¡¨ç¤ºç”¨ã«è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚æ›´æ–°
            db.collection('direct_chats').doc(this.directChat.roomId).set({
                participants: [this.form.univ_id, this.directChat.partnerId],
                lastMessage: this.directChat.input,
                lastDate: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            this.directChat.input = '';
        },

addCoach() {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šåå‰ã¨10æ¡ç•ªå·ã®ãƒã‚§ãƒƒã‚¯
    if(!this.newCoach.name) return;
    if(!this.newCoach.nbaId || !/^\d{10}$/.test(this.newCoach.nbaId)) {
        alert("BAJç™»éŒ²ç•ªå·ã¯åŠè§’æ•°å­—10æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    const coachData = {
        name: this.newCoach.name,
        bajId: this.newCoach.nbaId,
        expireDate: '2027-03-31',
        license: this.newCoach.license,
        umpireLevel: this.newCoach.umpireLevel, // é¸æŠã•ã‚ŒãŸ 1, 2, 3 ã‚’ä¿å­˜
        hasUmpire: this.newCoach.umpireLevel !== '' // ä½•ã‹ç´šãŒã‚ã‚Œã° true
    };
    
    this.coachList.push(coachData);
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    this.newCoach.name = '';
    this.newCoach.nbaId = '';
    this.newCoach.license = '';
    this.newCoach.umpireLevel = ''; 
    
    this.saveData(true);
},

        removeCoach(index) {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            this.coachList.splice(index, 1);
            this.saveData(true);
        },
        downloadIdCard(coach) {
            this.printCoach = coach;
            this.$nextTick(() => {
                const element = document.getElementById("idCardCanvas");
                html2canvas(element, { scale: 2 }).then(canvas => {
                    canvas.toBlob(blob => {
                        saveAs(blob, `IDCard_${coach.name}.png`);
                    });
                });
            });
        }, // â† å…ƒã‹ã‚‰ã‚ã‚‹downloadIdCardã®çµ‚ã‚ã‚Š

        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ç®¡ç†ç”»é¢ç”¨ã®è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰ â–¼â–¼â–¼
        parseCoaches(jsonStr) {
            if (!jsonStr) return [];
            try {
                // æ–‡å­—åˆ—ã®å ´åˆ
                if (typeof jsonStr === 'string') {
                    // ã‚‚ã—ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãŒå«ã¾ã‚ŒãŸäºŒé‡æ–‡å­—åˆ—ãªã‚‰ä¸€åº¦è§£é™¤ã™ã‚‹
                    let data = JSON.parse(jsonStr);
                    // è§£é™¤ã—ãŸçµæœãŒã¾ã æ–‡å­—åˆ—ãªã‚‰ã€ã‚‚ã†ä¸€åº¦è§£é™¤ã™ã‚‹ï¼ˆäºŒé‡ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¯¾ç­–ï¼‰
                    if (typeof data === 'string') {
                        data = JSON.parse(data);
                    }
                    return Array.isArray(data) ? data : [];
                }
                return Array.isArray(jsonStr) ? jsonStr : [];
            } catch (e) {
                console.error("Coach parse error", e);
                return [];
            }
        },
        downloadCoachCSV() {
            let csv = "æ‰€å±ã‚¯ãƒ©ãƒ–,æ°å,BAJ ID,ã‚³ãƒ¼ãƒè³‡æ ¼,å¯©åˆ¤è³‡æ ¼,æœ‰åŠ¹æœŸé™\n";
            this.adminRecords.forEach(rec => {
                const coaches = this.parseCoaches(rec.raw_data.coaches);
                coaches.forEach(c => {
                    const line = [
                        rec.univ_name,
                        c.name,
                        c.bajId || c.nbaId || "",
                        c.license || "ãªã—",
                        c.umpireLevel ? c.umpireLevel + "ç´šå¯©åˆ¤" : (c.hasUmpire ? "3ç´šå¯©åˆ¤" : "ãªã—"),
                        c.expireDate || ""
                    ].join(",");
                    csv += line + "\n";
                });
            });
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: "text/csv" });
            saveAs(blob, `coach_list_all_${new Date().toLocaleDateString()}.csv`);
        }, // â† downloadCoachCSVã®çµ‚ã‚ã‚Šã®ã‚«ãƒ³ãƒã‚’ç¢ºèª

            printAllCards() {
            window.print();
        }
        
    }
}).mount('#app');
    </script>
</body>
</html>
